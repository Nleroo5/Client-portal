<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Drive Lead Media</title>
    <link rel="icon" type="image/png" href="photos/logo1.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Young+Serif:wght@400&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            color: #012E40;
            background: linear-gradient(135deg, #012E40 0%, #05908C 100%);
            min-height: 100vh;
        }
        
        .admin-header {
            background: transparent;
            color: #EEF4D9;
            padding: 30px 20px 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-family: 'Young Serif', serif;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .btn-logout {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: #000000;
            border: 2px solid #000000;
            border-radius: 8px;
            padding: 10px 24px;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            cursor: pointer;
            transition: all 0.15s ease-out;
        }

        .btn-logout:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            border-color: #000000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        /* Admin Navigation Tabs */
        .admin-nav-tabs {
            background: transparent;
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 24px 32px;
        }

        .admin-tab {
            background: linear-gradient(135deg, rgba(224, 242, 241, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
            border: 1px solid #000000;
            border-radius: 10px;
            padding: 14px 28px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #000000;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .admin-tab:hover {
            border-color: #000000;
            color: #000000;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(5, 144, 140, 0.12);
            background: linear-gradient(135deg, rgba(224, 242, 241, 0.5) 0%, rgba(255, 255, 255, 0.3) 100%);
        }

        .admin-tab.active {
            background: linear-gradient(135deg, rgba(224, 242, 241, 0.6) 0%, rgba(255, 255, 255, 0.4) 100%);
            color: #000000;
            border: 1px solid #000000;
            box-shadow: 0 0 10px rgba(242, 169, 34, 0.4), 0 0 20px rgba(242, 169, 34, 0.2);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .btn-filter {
            padding: 8px 16px;
            border: 1.5px solid #d1d5db;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
        }

        .btn-filter:hover {
            border-color: #05908C;
            background: #f9fafb;
        }

        .btn-filter.active {
            background: #05908C;
            color: white;
            border-color: #05908C;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        .admin-section {
            background: rgba(220, 230, 235, 0.95);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 28px;
            box-shadow: 0 8px 32px rgba(1, 46, 64, 0.3);
            border: 2px solid rgba(5, 144, 140, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .admin-section:hover {
            box-shadow: 0 12px 40px rgba(1, 46, 64, 0.4);
            border-color: rgba(5, 144, 140, 0.5);
            transform: translateY(-2px);
        }

        .admin-section h2 {
            color: #000000;
            font-size: 1.4rem;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid #9ca3af;
            font-weight: 700;
            font-family: 'Bitter', serif;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            color: #000000;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        /* Override for h3 and labels to be black */
        .admin-section h3 {
            color: #000000 !important;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 11px 16px;
            border: 2px solid #000000;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #85C7B3;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #05908C;
            box-shadow: 0 0 0 4px rgba(5, 144, 140, 0.1);
        }
        
        .btn {
            padding: 11px 24px;
            background: linear-gradient(135deg, #05908C 0%, #047a72 100%);
            color: #000000;
            border: 1px solid #000000;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: all 0.2s ease;
            margin-right: 10px;
            font-size: 0.9rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: linear-gradient(135deg, #047a72 0%, #036661 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 144, 140, 0.25);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: rgba(242, 169, 34, 0.5);
            color: #000000;
            border: 1px solid #000000;
        }

        .btn-primary:hover {
            background: rgba(242, 169, 34, 0.7);
            box-shadow: 0 4px 12px rgba(242, 169, 34, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: #000000;
            border: 1px solid #000000;
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: #000000;
            border: 1px solid #000000;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #000000;
            border: 1px solid #000000;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #d1d5db 0%, #b8bcc4 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-small {
            padding: 8px 18px;
            font-size: 0.85rem;
            border: 1px solid #000000;
        }

        .btn-edit {
            background: rgba(5, 144, 140, 0.5);
            color: #000000;
            padding: 6px 14px;
            border: 1px solid #000000;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-right: 6px;
        }

        .btn-edit:hover {
            background: rgba(5, 144, 140, 0.7);
            transform: translateY(-1px);
        }

        .btn-delete {
            background: rgba(242, 169, 34, 0.5);
            color: #000000;
            padding: 6px 14px;
            border: 1px solid #000000;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-delete:hover {
            background: rgba(242, 169, 34, 0.7);
            transform: translateY(-1px);
        }
        
        .client-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .client-table th {
            background: linear-gradient(135deg, #012E40 0%, #05908C 100%);
            color: white;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .client-table th:first-child {
            border-top-left-radius: 12px;
        }

        .client-table th:last-child {
            border-top-right-radius: 12px;
        }

        .client-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f3f4f6;
            background: white;
            font-size: 0.9rem;
        }

        .client-table tbody tr:hover {
            background: rgba(5, 144, 140, 0.04);
            transition: background 0.2s ease;
        }

        .client-table tbody tr:last-child td {
            border-bottom: none;
        }

        .client-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        .client-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }
        
        .status-badge, .badge {
            display: inline-block;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .status-active, .badge-success {
            background: rgba(34, 197, 94, 0.15);
            color: #000000;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-inactive, .badge-secondary {
            background: rgba(107, 114, 128, 0.15);
            color: #000000;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.15);
            color: #000000;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-warning {
            background: rgba(242, 169, 34, 0.15);
            color: #d97706;
            border: 1px solid rgba(242, 169, 34, 0.3);
        }
        
        .progress-mini {
            display: flex;
            gap: 4px;
            margin-top: 5px;
        }
        
        .progress-step {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .progress-step.complete {
            background: #22c55e;
            color: white;
        }
        
        .portal-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #05908C;
            text-decoration: none;
            font-weight: 600;
        }
        
        .portal-link:hover {
            text-decoration: underline;
        }
        
        .copy-btn {
            padding: 4px 8px;
            background: #85C7B3;
            color: #000000;
            border: 1px solid #000000;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .copy-btn:hover {
            background: #05908C;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid #22c55e;
        }
        
        .alert-error {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        
        .link-section {
            background: transparent;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .link-section h3 {
            color: #000000;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        /* Edit Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #85C7B3;
        }
        
        .modal-header h2 {
            color: #05908C;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #85C7B3;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: #F0F9F7;
            color: #05908C;
        }
        
        .progress-controls {
            background: #DFF5F3;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .progress-controls h3 {
            color: #05908C;
            margin-bottom: 15px;
        }
        
        .progress-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #85C7B3;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .client-table {
                font-size: 0.9rem;
            }

            .client-table th,
            .client-table td {
                padding: 8px;
            }

            .modal {
                width: calc(100% - 20px) !important;
                max-width: calc(100vw - 20px) !important;
                padding: 20px;
                margin: 10px;
            }

            .progress-checkboxes {
                grid-template-columns: 1fr;
            }

            .modal-header h2 {
                font-size: 1.3rem;
            }
        }

        /* Mobile Phones (480px and below) */
        @media (max-width: 480px) {
            .modal {
                width: calc(100% - 16px) !important;
                max-width: calc(100vw - 16px) !important;
                padding: 16px !important;
                margin: 8px !important;
                border-radius: 12px;
            }

            .modal-header {
                flex-direction: row;
                gap: 10px;
                margin-bottom: 20px;
                padding-bottom: 12px;
            }

            .modal-header h2 {
                font-size: 1.1rem;
            }

            .close-btn {
                font-size: 1.3rem;
                width: 32px;
                height: 32px;
            }

            #crmPipelineBoard {
                grid-template-columns: 1fr;
            }
        }

        /* Extra Small Phones (360px and below) */
        @media (max-width: 360px) {
            .modal {
                width: calc(100% - 12px) !important;
                max-width: calc(100vw - 12px) !important;
                padding: 12px !important;
                margin: 6px !important;
            }

            .modal-header h2 {
                font-size: 1rem;
            }
        }

        /* Pipeline Board Styles for CRM */
        #crmPipelineBoard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        #crmPipelineBoard > div {
            background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
            border-radius: 12px;
            padding: 18px;
            min-height: 500px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        #crmPipelineBoard > div:hover {
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            border-color: #d0d0d0;
        }

        #crmPipelineBoard h3 {
            font-size: 0.85rem;
            font-weight: 700;
            margin: 0 0 16px 0;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: #333;
            padding-bottom: 12px;
            border-bottom: 2px solid #000;
        }

        .deal-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 3px solid #000;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .deal-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border-left-width: 4px;
        }

        .archive-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .archive-list::-webkit-scrollbar {
            width: 8px;
        }

        .archive-list::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 4px;
        }

        .archive-list::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 4px;
        }

        .archive-list::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .archive-list::-webkit-scrollbar {
            width: 6px;
        }

        .archive-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .archive-list::-webkit-scrollbar-thumb {
            background: #85C7B3;
            border-radius: 10px;
        }

        .archive-list::-webkit-scrollbar-thumb:hover {
            background: #05908C;
        }

        /* Revision Request Animations */
        @keyframes revisionPulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), 0 6px 30px rgba(1, 46, 64, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.8), 0 6px 30px rgba(1, 46, 64, 0.3);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div class="admin-header">
        <img src="photos/logo1.png" alt="Drive Lead Media" style="height: 60px; object-fit: contain;">
        <h1 style="flex: 1; text-align: center;">Admin Dashboard</h1>

        <button class="btn-logout" onclick="logoutAdmin()">Logout</button>
    </div>

    <!-- Admin Navigation Tabs -->
    <div class="admin-nav-tabs">
        <button class="admin-tab active" data-tab="dashboard" onclick="switchAdminTab('dashboard')">
            Dashboard
        </button>
        <button class="admin-tab" data-tab="sales-pipeline" onclick="switchAdminTab('sales-pipeline')">
            Sales Pipeline
        </button>
        <button class="admin-tab" data-tab="team" onclick="switchAdminTab('team')">
            Team
        </button>
        <button class="admin-tab" data-tab="clients" onclick="switchAdminTab('clients')">
            Clients
        </button>
        <button class="admin-tab" data-tab="website-forms" onclick="switchAdminTab('website-forms')">
            Website Forms
        </button>
        <button class="admin-tab" data-tab="settings" onclick="switchAdminTab('settings')">
            Settings
        </button>
        <button class="admin-tab" data-tab="cms-clients" onclick="switchAdminTab('cms-clients')">
            CMS Clients
        </button>
    </div>

    <div class="admin-container">
        <!-- Alert Messages -->
        <div id="alertMessage" style="display: none;"></div>

        <!-- Tab: Dashboard (NEW) -->
        <div class="admin-tab-content active" id="tab-dashboard">

            <!-- Revenue Overview -->
            <div class="admin-section" style="background: linear-gradient(135deg, #012E40 0%, #05908C 100%);">
                <div style="margin-bottom: 24px;">
                    <h2 style="margin-bottom: 4px; font-family: 'Bitter', serif; color: #FFFFFF;">Revenue Overview</h2>
                    <p style="color: #E0F2F1; font-size: 0.9rem; margin: 0;">Real-time snapshot of your business performance</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: linear-gradient(135deg, #D1F2EB 0%, #FFFFFF 100%); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 0.75rem; color: #000000; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Total Pipeline Value</div>
                        <div style="font-size: 2.25rem; font-weight: 700; color: #000;" id="dashboardTotalPipeline">$0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #D1F2EB 0%, #FFFFFF 100%); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 0.75rem; color: #000000; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Active Deals</div>
                        <div style="font-size: 2.25rem; font-weight: 700; color: #000;" id="dashboardActiveDeals">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #D1F2EB 0%, #FFFFFF 100%); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 0.75rem; color: #000000; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">This Month MRR</div>
                        <div style="font-size: 2.25rem; font-weight: 700; color: #000;" id="dashboardMonthlyMRR">$0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #D1F2EB 0%, #FFFFFF 100%); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 0.75rem; color: #000000; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Active Clients</div>
                        <div style="font-size: 2.25rem; font-weight: 700; color: #000;" id="dashboardActiveClients">0</div>
                    </div>
                </div>
            </div>

            <!-- Notifications & Alerts Section -->
            <div class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h2 style="font-family: 'Bitter', serif; color: #000000; margin: 0;">🔔 Notifications & Alerts</h2>
                        <span id="dashboardNotificationCount" style="display: none; background: #ef4444; color: white; border-radius: 12px; padding: 4px 10px; font-size: 0.8rem; font-weight: 700;"></span>
                    </div>
                    <button onclick="markAllDashboardNotificationsRead()" id="markAllReadBtn" style="display: none; background: transparent; border: 1px solid #05908C; color: #05908C; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.background='#05908C'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='#05908C'">
                        Mark All Read
                    </button>
                </div>

                <div id="dashboardNotificationsList" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Notifications will be rendered here -->
                    <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #22c55e;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">✅</div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #166534; margin-bottom: 4px;">All Caught Up!</div>
                        <div style="color: #15803d; font-size: 0.9rem;">No pending notifications at this time</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="admin-section">
                <h2 style="font-family: 'Bitter', serif; color: #000000; margin-bottom: 16px;">Quick Actions</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <button onclick="switchAdminTab('clients')" style="background: linear-gradient(135deg, #05908C 0%, #47a5a3 100%); color: white; border: none; border-radius: 10px; padding: 20px; font-weight: 600; cursor: pointer; text-align: center; box-shadow: 0 4px 12px rgba(5, 144, 140, 0.3); transition: all 0.3s ease;">
                        <div style="font-family: 'Bitter', serif; font-size: 1.3rem;">Create Client Portal</div>
                    </button>
                    <button onclick="openDealModal()" style="background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%); color: white; border: none; border-radius: 10px; padding: 20px; font-weight: 600; cursor: pointer; text-align: center; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s ease;">
                        <div style="font-family: 'Bitter', serif; font-size: 1.3rem;">Add New Deal</div>
                    </button>
                    <button onclick="switchAdminTab('website-forms')" style="background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%); color: white; border: none; border-radius: 10px; padding: 20px; font-weight: 600; cursor: pointer; text-align: center; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); transition: all 0.3s ease;">
                        <div style="font-family: 'Bitter', serif; font-size: 1.3rem;">View Website Forms</div>
                    </button>
                </div>
            </div>

        </div>
        <!-- End Tab: Dashboard -->

        <!-- Tab: Clients (Merged: Client Portals + Messages) -->
        <div class="admin-tab-content" id="tab-clients">

        <!-- Create New Client -->
        <div class="admin-section">
            <h2 style="font-family: 'Bitter', serif; color: #000000;">Create New Client Portal</h2>
            <form id="createClientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="clientName">Client/Business Name *</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group">
                        <label for="clientEmail">Client Email</label>
                        <input type="email" id="clientEmail">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="portalType">Contract Length *</label>
                        <select id="portalType" required>
                            <option value="contract">Contract (6/12-Month Agreement)</option>
                            <option value="m2m">Month-to-Month</option>
                        </select>
                    </div>
                    <div></div>
                </div>

                <!-- Contract Portal Links (shown by default) -->
                <div id="contractLinks">
                <div class="link-section">
                    <h3>DocuSign Links</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dpaLink">Custom DPA Link</label>
                            <input type="url" id="dpaLink" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="service6Link">Custom 6-Month Service Agreement</label>
                            <input type="url" id="service6Link" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="service12Link">Custom 12-Month Service Agreement</label>
                        <input type="url" id="service12Link" placeholder="">
                    </div>
                </div>
                
                <div class="link-section">
                    <h3>Stripe Payment Links</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stripe6Monthly">6-Month Monthly Payment</label>
                            <input type="url" id="stripe6Monthly" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="stripe6Upfront">6-Month Upfront Payment</label>
                            <input type="url" id="stripe6Upfront" placeholder="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stripe12Monthly">12-Month Monthly Payment</label>
                            <input type="url" id="stripe12Monthly" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="stripe12Upfront">12-Month Upfront Payment</label>
                            <input type="url" id="stripe12Upfront" placeholder="">
                        </div>
                    </div>
                </div>
                </div>
                <!-- End Contract Portal Links -->

                <!-- Month-to-Month Portal Links (hidden by default) -->
                <div id="m2mLinks" style="display: none;">
                <div class="link-section">
                    <h3>Month-to-Month DocuSign Links</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="m2mServiceAgreementLink">Custom Service Agreement Link</label>
                            <input type="url" id="m2mServiceAgreementLink" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="m2mDpaLink">Custom DPA Link</label>
                            <input type="url" id="m2mDpaLink" placeholder="">
                        </div>
                    </div>
                </div>

                <div class="link-section">
                    <h3>Month-to-Month Payment Link</h3>
                    <div class="form-group">
                        <label for="m2mInvoiceLink">Stripe Invoice/Payment Link</label>
                        <input type="url" id="m2mInvoiceLink" placeholder="">
                    </div>
                </div>
                </div>
                <!-- End Month-to-Month Portal Links -->

                <button type="submit" class="btn btn-primary">Create Client Portal</button>
            </form>
        </div>
        
        <!-- Existing Clients -->
        <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="margin-bottom: 4px; font-family: 'Bitter', serif; color: #000000;">Client Portals</h2>
                    <p style="color: #000000; font-size: 0.9rem; margin: 0;">Manage active client onboarding portals</p>
                </div>
                <div style="display: flex; gap: 24px; align-items: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #05908C;" id="totalClientsCount">0</div>
                        <div style="font-size: 0.75rem; color: #000000; text-transform: uppercase; letter-spacing: 0.5px;">Total Clients</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #47a5a3;" id="activeClientsCount">0</div>
                        <div style="font-size: 0.75rem; color: #000000; text-transform: uppercase; letter-spacing: 0.5px;">Active</div>
                    </div>
                </div>
            </div>
            <div id="clientsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px;">
                <!-- Client cards will be loaded here -->
            </div>
        </div>

        </div>
        <!-- End Tab: Clients -->

        <!-- Tab: Team (Renamed from Sales Reps) -->
        <div class="admin-tab-content" id="tab-team">

            <!-- Add New Sales Rep -->
            <div class="admin-section">
                <h2>Add New Sales Rep</h2>
                <form id="addRepForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="repName">Full Name *</label>
                            <input type="text" id="repName" required placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="repEmail">Email</label>
                            <input type="email" id="repEmail" placeholder="john@driveleadmedia.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="repPhone">Phone Number</label>
                            <input type="tel" id="repPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="repPassword">Password *</label>
                            <input type="text" id="repPassword" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="repRole">Role *</label>
                            <select id="repRole" required>
                                <option value="rep">Rep</option>
                                <option value="leadership">Leadership</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-top: 25px;">
                        <button type="submit" class="btn btn-primary">Create Sales Rep</button>
                    </div>
                </form>
            </div>

            <!-- Existing Sales Reps -->
            <div class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="margin-bottom: 4px;">Sales Team</h2>
                        <p style="color: #000000; font-size: 0.9rem; margin: 0;">Manage sales representatives and their targets</p>
                    </div>
                    <div style="display: flex; gap: 24px; align-items: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #05908C;" id="totalRepsCount">0</div>
                            <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Active Reps</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #85C7B3;" id="inactiveRepsCount">0</div>
                            <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Inactive</div>
                        </div>
                    </div>
                </div>
                <div id="repsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px;">
                    <!-- Rep cards will be loaded here -->
                </div>
            </div>

        </div>
        <!-- End Tab: Team -->

        <!-- Tab: Sales Pipeline (Merged: Sales CRM + Archived Deals) -->
        <div class="admin-tab-content" id="tab-sales-pipeline">

            <!-- Revenue Metrics Dashboard -->
            <div class="admin-section" style="background: linear-gradient(135deg, #012E40 0%, #05908C 100%);">
                <div style="margin-bottom: 24px;">
                    <h2 style="margin-bottom: 4px; font-family: 'Bitter', serif; color: #FFFFFF;">Revenue Metrics</h2>
                    <p style="color: #E0F2F1; font-size: 0.9rem; margin: 0;">Real-time sales pipeline performance and revenue tracking</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: linear-gradient(135deg, #D1F2EB 0%, #FFFFFF 100%); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 0.75rem; color: #000000; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Total Pipeline Value</div>
                        <div style="font-size: 2.25rem; font-weight: 700; color: #000;" id="totalPipelineValue">$0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #D1F2EB 0%, #FFFFFF 100%); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 0.75rem; color: #000000; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Active Deals</div>
                        <div style="font-size: 2.25rem; font-weight: 700; color: #000;" id="activeDealsCount">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #D1F2EB 0%, #FFFFFF 100%); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 0.75rem; color: #000000; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">This Month MRR</div>
                        <div style="font-size: 2.25rem; font-weight: 700; color: #000;" id="monthlyMRR">$0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #D1F2EB 0%, #FFFFFF 100%); padding: 24px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 0.75rem; color: #000000; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Avg Deal Size</div>
                        <div style="font-size: 2.25rem; font-weight: 700; color: #000;" id="avgDealSize">$0</div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Board -->
            <div class="admin-section" style="background: linear-gradient(135deg, #012E40 0%, #05908C 100%);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="margin-bottom: 4px; font-family: 'Bitter', serif; color: #FFFFFF;">Sales Pipeline</h2>
                        <p style="color: #E0F2F1; font-size: 0.9rem; margin: 0;">Track deals across all stages of your sales process</p>
                    </div>
                    <button class="btn btn-primary" onclick="openDealModal()">+ Add New Deal</button>
                </div>
                <div id="crmPipelineBoard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- Pipeline columns will be rendered here -->
                </div>
            </div>

            <!-- Archived Deals Section (within Sales Pipeline tab) -->
            <div class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; color: #012E40;">Archived Deals</h2>
                        <p style="color: #000000; margin: 0; font-size: 0.9rem;">View all deals that have been marked as lost</p>
                    </div>
                    <button onclick="toggleArchivedDeals()" id="toggleArchivedBtn" style="background: #6b7280; color: white; border: none; border-radius: 8px; padding: 10px 20px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                        Show Archived
                    </button>
                </div>

                <div id="archivedDealsSection" style="display: none;">
                    <div style="background: #FFF8E6; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #E2E8F0;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #0F172A;">Company</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #0F172A;">Contact</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #0F172A;">Assigned Rep</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #0F172A;">Stage When Lost</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #0F172A;">Archived Date</th>
                                </tr>
                            </thead>
                            <tbody id="adminArchivedDealsBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 24px; color: #64748B;">Loading archived deals...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
        <!-- End Tab: Sales Pipeline -->

        <!-- Tab: Website Forms -->
        <div class="admin-tab-content" id="tab-website-forms">
            <div class="admin-section">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; color: #012E40;">Website Discovery Submissions</h2>
                <p style="color: #000000; margin-bottom: 24px;">Manage website discovery forms from potential clients</p>

                <!-- Share Form Info Box -->
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0284c7; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                    <div style="display: flex; align-items: start; gap: 15px;">
                        <div style="font-size: 2rem;">📋</div>
                        <div style="flex: 1;">
                            <h3 style="color: #0369a1; margin: 0 0 10px 0; font-size: 1.1rem;">Share This Form with Clients</h3>
                            <div style="background: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #bae6fd;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="text" value="https://portal.driveleadmedia.com/index-website-quote.html" readonly
                                           style="flex: 1; border: none; background: transparent; font-family: monospace; font-size: 0.9rem; color: #0c4a6e; font-weight: 600;"
                                           id="adminFormLinkInput">
                                    <button onclick="copyAdminFormLink()" style="padding: 8px 16px; background: #0284c7; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; white-space: nowrap;">
                                        Copy Link
                                    </button>
                                </div>
                            </div>
                            <div style="color: #0369a1; font-size: 0.85rem; line-height: 1.5;">
                                <strong>How it works:</strong><br>
                                • Clients fill out 12 sections (~15-20 minutes)<br>
                                • Auto-saves every 30 seconds - they can pause anytime<br>
                                • You see their progress in real-time in admin dashboard<br>
                                • Click "Generate AI Prompt" when complete to build their site
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border: 2px solid #e5e7eb;">
                        <div style="font-size: 2rem; font-weight: 700; color: #05908C; margin-bottom: 5px;" id="quotesIncomplete">0</div>
                        <div style="color: #6b7280; font-size: 0.9rem;">Incomplete</div>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border: 2px solid #e5e7eb;">
                        <div style="font-size: 2rem; font-weight: 700; color: #F2A922; margin-bottom: 5px;" id="quotesCompleted">0</div>
                        <div style="color: #6b7280; font-size: 0.9rem;">Completed</div>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border: 2px solid #e5e7eb;">
                        <div style="font-size: 2rem; font-weight: 700; color: #3b82f6; margin-bottom: 5px;" id="quotesQuoteSent">0</div>
                        <div style="color: #6b7280; font-size: 0.9rem;">Quote Sent</div>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border: 2px solid #e5e7eb;">
                        <div style="font-size: 2rem; font-weight: 700; color: #22c55e; margin-bottom: 5px;" id="quotesWon">0</div>
                        <div style="color: #6b7280; font-size: 0.9rem;">Won</div>
                    </div>
                </div>

                <!-- Filter Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="filterQuotes('all')" class="btn-filter active" id="filter-all">All</button>
                    <button onclick="filterQuotes('incomplete')" class="btn-filter" id="filter-incomplete">Incomplete</button>
                    <button onclick="filterQuotes('completed')" class="btn-filter" id="filter-completed">Completed</button>
                    <button onclick="filterQuotes('quote-sent')" class="btn-filter" id="filter-quote-sent">Quote Sent</button>
                    <button onclick="filterQuotes('won')" class="btn-filter" id="filter-won">Won</button>
                    <button onclick="filterQuotes('lost')" class="btn-filter" id="filter-lost">Lost</button>
                </div>

                <!-- Quotes List -->
                <div id="websiteQuotesList">
                    <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">📋</div>
                        <p>Loading website forms...</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab: Website Forms -->

        <!-- Tab: Settings (NEW - Placeholder) -->
        <div class="admin-tab-content" id="tab-settings">
            <div class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="font-family: 'Bitter', serif; color: #000000; margin-bottom: 8px;">Settings</h2>
                        <p style="color: #6b7280; font-size: 0.95rem;">Manage system configuration and integrations</p>
                    </div>
                    <button onclick="saveAllSettings()" style="padding: 12px 28px; background: linear-gradient(135deg, #05908C 0%, #47a5a3 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(5, 144, 140, 0.3); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(5, 144, 140, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(5, 144, 140, 0.3)'">
                        💾 Save All Changes
                    </button>
                </div>

                <!-- Company Information -->
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 28px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <h3 style="color: #012E40; font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        🏢 Company Information
                    </h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Support Email</label>
                            <input type="email" id="settingsSupportEmail" placeholder="support@company.com" style="width: 100%; padding: 12px; border: 1.5px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; transition: all 0.2s ease;" onfocus="this.style.borderColor='#05908C'" onblur="this.style.borderColor='#d1d5db'">
                        </div>
                        <div>
                            <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Support Phone</label>
                            <input type="tel" id="settingsSupportPhone" placeholder="(555) 123-4567" style="width: 100%; padding: 12px; border: 1.5px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; transition: all 0.2s ease;" onfocus="this.style.borderColor='#05908C'" onblur="this.style.borderColor='#d1d5db'">
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 28px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <h3 style="color: #012E40; font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        🔔 Notification Preferences
                    </h3>

                    <div style="background: #F3F4F6; padding: 24px; border-radius: 10px;">
                        <!-- Client Portal Activity -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: #012E40; font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">👤</span> Client Portal Activity
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 12px; padding-left: 32px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyClientStepComplete" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client completes a step (Steps 1-6)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyLogoUpload" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client uploads brand logo</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyBrandColorsSubmit" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client submits brand colors</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyWebsiteAccess" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client provides website access credentials</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyCreativeApproval" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client approves creatives to launch</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyRevisionRequest" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client requests creative revisions</span>
                                </label>
                            </div>
                        </div>

                        <!-- Website Discovery Forms -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: #012E40; font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">📝</span> Website Discovery Forms
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 12px; padding-left: 32px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyNewQuotes" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">New website form submitted</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyQuoteCompleted" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client completes entire discovery form</span>
                                </label>
                            </div>
                        </div>

                        <!-- Sales Pipeline -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: #012E40; font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">📊</span> Sales Pipeline
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 12px; padding-left: 32px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyDealCreated" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">New deal created</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyDealAssigned" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Deal assigned to sales rep</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyDealChanges" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Deal stage changes</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyDealWon" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Deal marked as won</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyDealLost" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Deal marked as lost</span>
                                </label>
                            </div>
                        </div>

                        <!-- Client Management -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: #012E40; font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">🏢</span> Client Management
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 12px; padding-left: 32px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyNewClients" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">New client added to system</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyClientActivated" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client portal activated</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyClientDeactivated" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client portal deactivated</span>
                                </label>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: #012E40; font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">💬</span> Messages
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 12px; padding-left: 32px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyNewMessages" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">Client sends a new message</span>
                                </label>
                            </div>
                        </div>

                        <!-- Team & System -->
                        <div>
                            <h4 style="color: #012E40; font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">⚙️</span> Team & System
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 12px; padding-left: 32px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifyNewTeamMember" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">New team member added</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="settingsNotifySystemErrors" style="width: 20px; height: 20px; cursor: pointer;">
                                    <span style="color: #374151; font-weight: 600;">System errors or critical issues</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button (Bottom) -->
                <div style="display: flex; justify-content: flex-end; gap: 12px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button onclick="loadSettings()" style="padding: 12px 28px; background: white; color: #6b7280; border: 2px solid #d1d5db; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95rem; transition: all 0.2s ease;" onmouseover="this.style.borderColor='#9ca3af'" onmouseout="this.style.borderColor='#d1d5db'">
                        🔄 Reset to Saved
                    </button>
                    <button onclick="saveAllSettings()" style="padding: 12px 28px; background: linear-gradient(135deg, #05908C 0%, #47a5a3 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(5, 144, 140, 0.3); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(5, 144, 140, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(5, 144, 140, 0.3)'">
                        💾 Save All Changes
                    </button>
                </div>
            </div>
        </div>
        <!-- End Tab: Settings -->

        <!-- Tab: CMS Clients (NEW) -->
        <div class="admin-tab-content" id="tab-cms-clients">
            <div class="admin-section">
                <h2 style="font-family: 'Bitter', serif; color: #000000; margin-bottom: 24px;">CMS Website Clients</h2>

                <!-- Add New CMS Client -->
                <div style="background: #E8F5F3; padding: 24px; border-radius: 12px; margin-bottom: 30px;">
                    <h3 style="color: #012E40; margin-bottom: 16px;">Add New CMS Client</h3>
                    <form id="addCMSClientForm" style="display: grid; gap: 16px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Client Name/Business *</label>
                                <input type="text" id="cmsClientName" required placeholder="ABC Construction">
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="cmsClientEmail" required placeholder="john@abcconstruction.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Password *</label>
                                <input type="text" id="cmsClientPassword" required placeholder="Auto-generated password">
                                <button type="button" onclick="generatePassword()" style="margin-top: 8px; padding: 6px 12px; background: #05908C; color: white; border: none; border-radius: 6px; cursor: pointer;">Generate</button>
                            </div>
                            <div></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Create CMS Client</button>
                    </form>
                </div>

                <!-- CMS Clients List -->
                <div style="background: white; padding: 24px; border-radius: 12px;">
                    <h3 style="color: #012E40; margin-bottom: 16px;">Active CMS Clients</h3>
                    <div id="cmsClientsList">
                        <p style="color: #64748b; text-align: center; padding: 40px;">No CMS clients yet</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Tab: CMS Clients -->

    </div>

    <!-- Edit Client Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Edit Client Portal</h2>
                <button type="button" class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            
            <form id="editClientForm">
                <input type="hidden" id="editClientId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editClientName">Client/Business Name *</label>
                        <input type="text" id="editClientName" required>
                    </div>
                    <div class="form-group">
                        <label for="editClientEmail">Client Email</label>
                        <input type="email" id="editClientEmail">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editClientStatus">Status</label>
                        <select id="editClientStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div></div>
                </div>
                
                <div class="progress-controls">
                    <h3>Progress Control</h3>
                    <div class="progress-checkboxes">
                        <div class="checkbox-item">
                            <input type="checkbox" id="editStep1">
                            <label for="editStep1">Step 1: Agreements</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="editStep2">
                            <label for="editStep2">Step 2: Payment</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="editStep3">
                            <label for="editStep3">Step 3: Meta Setup</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="editStep4">
                            <label for="editStep4">Step 4: Tracking</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="editStep5">
                            <label for="editStep5">Step 5: Approval</label>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-secondary btn-small" onclick="resetAllSteps()">Reset All Steps</button>
                        <button type="button" class="btn btn-success btn-small" onclick="completeAllSteps()">Complete All Steps</button>
                    </div>
                </div>
                
                <div class="link-section">
                    <h3>DocuSign Links</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDpaLink">Custom DPA Link</label>
                            <input type="url" id="editDpaLink" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="editService6Link">Custom 6-Month Service Agreement</label>
                            <input type="url" id="editService6Link" placeholder="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editService12Link">Custom 12-Month Service Agreement</label>
                        <input type="url" id="editService12Link" placeholder="">
                    </div>
                </div>
                
                <div class="link-section">
                    <h3>Stripe Payment Links</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editStripe6Monthly">6-Month Monthly Payment</label>
                            <input type="url" id="editStripe6Monthly" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="editStripe6Upfront">6-Month Upfront Payment</label>
                            <input type="url" id="editStripe6Upfront" placeholder="">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editStripe12Monthly">12-Month Monthly Payment</label>
                            <input type="url" id="editStripe12Monthly" placeholder="">
                        </div>
                        <div class="form-group">
                            <label for="editStripe12Upfront">12-Month Upfront Payment</label>
                            <input type="url" id="editStripe12Upfront" placeholder="">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; text-align: center; padding-top: 20px; border-top: 2px solid #85C7B3;">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="deleteClient()" style="margin-left: 20px;">Delete Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reset Portal Confirmation Modal -->
    <div class="modal-overlay" id="resetPortalModal" style="display: none;">
        <div class="modal" style="max-width: min(550px, calc(100vw - 20px));">
            <div class="modal-header">
                <h2 style="color: #F2584E; font-family: 'Bitter', serif;">⚠️ Reset Portal Data</h2>
                <button type="button" class="close-btn" onclick="closeResetPortalModal()">&times;</button>
            </div>

            <div style="padding: 20px;">
                <input type="hidden" id="resetClientId">
                <input type="hidden" id="resetClientName">

                <div style="background: #FEE2E2; border-left: 4px solid #F2584E; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #991B1B; font-weight: 600; margin-bottom: 8px;">This action will reset all portal data for:</p>
                    <p style="color: #7F1D1D; font-size: 1.1rem; font-weight: 700; margin: 0;" id="resetClientNameDisplay"></p>
                </div>

                <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <p style="font-weight: 600; color: #374151; margin-bottom: 12px;">The following will be cleared:</p>
                    <ul style="color: #6B7280; margin-left: 20px; line-height: 1.8;">
                        <li>All progress (0% completion)</li>
                        <li>All completed steps</li>
                        <li>Brand assets and logo</li>
                        <li>Brand colors</li>
                        <li>Uploaded creatives</li>
                        <li>Meta Business Manager details</li>
                        <li>Google Analytics configuration</li>
                        <li>All form data</li>
                    </ul>
                </div>

                <div style="background: #FFFBEB; border-left: 4px solid #F59E0B; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                    <p style="color: #92400E; font-size: 0.9rem; margin: 0;">
                        <strong>Note:</strong> Client contact information, portal URL, and messages will NOT be deleted.
                    </p>
                </div>

                <div style="background: white; border: 2px solid #F2584E; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="confirmResetCheckbox" style="width: 20px; height: 20px; cursor: pointer; accent-color: #F2584E;">
                        <span style="color: #374151; font-weight: 600; font-size: 0.95rem;">
                            I understand this action cannot be undone
                        </span>
                    </label>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeResetPortalModal()">Cancel</button>
                    <button type="button" id="confirmResetButton" class="btn btn-danger" onclick="confirmResetPortalData()" disabled style="opacity: 0.5; cursor: not-allowed;">
                        Reset Portal Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Configuration -->
    <script src="config.js"></script>
    <script src="validation.js"></script>
    <script src="toast.js"></script>
    <script src="notifications-system.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION & AUTH CHECK
        // ============================================
        // Firebase is initialized in config.js

        // CRITICAL SECURITY: Verify Firebase Authentication on page load
        // Wait for Firebase to be fully loaded
        let isAuthChecked = false;

        // Authorized admin emails
        const ADMIN_EMAILS = [
            'nicolas@driveleadmedia.com',
            'brenna@driveleadmedia.com',
            'tommy@driveleadmedia.com'
        ];

        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user || !ADMIN_EMAILS.includes(user.email)) {
                // Not authenticated or not admin - redirect to login
                console.warn('Unauthorized access attempt to admin dashboard');
                window.location.href = 'index.html';
                return;
            }

            // User is authenticated admin - verify salesReps document
            console.log('Admin authenticated:', user.email);
            console.log('Admin UID:', user.uid);

            // Check if salesReps document exists with admin role
            try {
                const adminDoc = await db.collection('salesReps').doc(user.uid).get();
                if (!adminDoc.exists) {
                    console.error('CRITICAL: Admin user document does not exist in salesReps collection');
                    console.error('Expected document at: salesReps/' + user.uid);

                    // EMERGENCY: Offer to create admin document automatically
                    const shouldCreate = confirm(
                        'Admin account not found!\n\n' +
                        'Would you like to create your admin account now?\n\n' +
                        'This will create a salesReps document for: ' + user.email
                    );

                    if (shouldCreate) {
                        try {
                            await db.collection('salesReps').doc(user.uid).set({
                                email: user.email,
                                name: 'Admin',
                                role: 'admin',
                                active: true,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            alert('Admin account created successfully! Please refresh the page.');
                            location.reload();
                            return;
                        } catch (createError) {
                            console.error('Error creating admin document:', createError);
                            alert('Failed to create admin account: ' + createError.message + '\n\nPlease create it manually in Firebase Console.');
                            return;
                        }
                    }

                    return;
                }

                const adminData = adminDoc.data();
                console.log('Admin document data:', adminData);

                if (adminData.role !== 'admin') {
                    console.error('CRITICAL: User document exists but role is not "admin". Current role:', adminData.role);
                    alert('Admin permissions not configured correctly. Role must be "admin" but is: ' + adminData.role);
                    return;
                }

                console.log('✓ Admin verification successful - role:', adminData.role);
            } catch (error) {
                console.error('Error verifying admin document:', error);
                alert('Error verifying admin permissions: ' + error.message);
                return;
            }

            isAuthChecked = true;

            // Now that we're authenticated and verified, load the initial data
            restoreLastTab(); // Restore last active tab (or default to dashboard)
            loadClients();

            // Old notification bell system removed - notifications now loaded via loadDashboardNotifications() in loadDashboardData()
        });

        // Your portal URL
        const PORTAL_BASE_URL = 'https://portal.driveleadmedia.com';

        // Current client being edited
        let currentEditingClient = null;

        // Show alert message
        function showAlert(message, type = 'success') {
            // Use toast notifications instead of inline alerts
            showToast(message, type);
        }

        // Logout function
        function logoutAdmin() {
            if (confirm('Are you sure you want to logout?')) {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                });
            }
        }

        // Switch between admin tabs
        window.switchAdminTab = function(tabName) {
            // Update active tab button
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Save current tab to URL and localStorage
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.pushState({}, '', url);
            localStorage.setItem('adminLastTab', tabName);

            // Load data for specific tabs
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'team') {
                loadReps();
            } else if (tabName === 'sales-pipeline') {
                // FIXED: Always load pipeline data when tab is accessed
                loadCRMPipeline();

                // Also load archived deals if that section is visible
                if (document.getElementById('archivedDealsSection') &&
                    document.getElementById('archivedDealsSection').style.display !== 'none') {
                    loadAdminArchivedDeals();
                }
            }
        }

        // Restore last active tab on page load
        function restoreLastTab() {
            // Check URL parameter first
            const urlParams = new URLSearchParams(window.location.search);
            let tabToLoad = urlParams.get('tab');

            // If no URL parameter, check localStorage
            if (!tabToLoad) {
                tabToLoad = localStorage.getItem('adminLastTab');
            }

            // If we have a saved tab, switch to it
            if (tabToLoad && document.querySelector(`[data-tab="${tabToLoad}"]`)) {
                switchAdminTab(tabToLoad);
            } else {
                // Default to dashboard
                switchAdminTab('dashboard');
            }
        }

        // Load Dashboard Data
        async function loadDashboardData() {
            try {
                // Load pipeline metrics
                const dealsSnapshot = await db.collection('deals').get();
                let totalPipeline = 0;
                let activeDeals = 0;
                let monthlyMRR = 0;

                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                dealsSnapshot.forEach(doc => {
                    const deal = doc.data();
                    if (deal.stage !== 'Lost' && deal.stage !== 'Won') {
                        activeDeals++;
                        const dealValue = parseFloat(deal.value) || 0;
                        totalPipeline += dealValue;
                    }

                    // Calculate MRR for deals won this month
                    if (deal.stage === 'Won' && deal.closedDate) {
                        const closedDate = deal.closedDate.toDate();
                        if (closedDate.getMonth() === currentMonth && closedDate.getFullYear() === currentYear) {
                            monthlyMRR += parseFloat(deal.value) || 0;
                        }
                    }
                });

                // Update dashboard metrics
                document.getElementById('dashboardTotalPipeline').textContent = '$' + totalPipeline.toLocaleString();
                document.getElementById('dashboardActiveDeals').textContent = activeDeals;
                document.getElementById('dashboardMonthlyMRR').textContent = '$' + monthlyMRR.toLocaleString();

                // Load active clients count
                const clientsSnapshot = await db.collection('clients').get();
                const activeClients = clientsSnapshot.docs.filter(doc => doc.data().active !== false).length;
                document.getElementById('dashboardActiveClients').textContent = activeClients;

                // Load sales pipeline board on dashboard (if not already loaded)
                // Check if pipeline board is empty before loading
                const pipelineBoard = document.getElementById('crmPipelineBoard');
                if (pipelineBoard && pipelineBoard.children.length === 0) {
                    loadCRMPipeline();
                }

                // Load dashboard notifications
                loadDashboardNotifications();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load Dashboard Notifications
        async function loadDashboardNotifications() {
            try {
                // Get current user email to filter notifications
                const currentUser = firebase.auth().currentUser;
                const currentEmail = currentUser ? currentUser.email : '';

                const clientsSnapshot = await db.collection('clients').get();
                const notifications = [];

                // NICOLAS NOTIFICATIONS (nicolas@driveleadmedia.com)
                if (currentEmail === 'nicolas@driveleadmedia.com') {
                    clientsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const clientId = doc.id;

                        // 1. Check for revision requests
                        if (data.revisionRequests && data.revisionRequests.length > 0) {
                            const pendingRevisions = data.revisionRequests.filter(r => r.status === 'pending');
                            if (pendingRevisions.length > 0) {
                                pendingRevisions.forEach(revision => {
                                    notifications.push({
                                        type: 'revision',
                                        icon: '⚠️',
                                        title: `${data.clientName || 'Client'} requested revision`,
                                        message: revision.message || 'No details provided',
                                        clientId: clientId,
                                        clientName: data.clientName,
                                        timestamp: revision.timestamp?.toDate() || new Date(),
                                        priority: 'high',
                                        adminOnly: 'nicolas'
                                    });
                                });
                            }
                        }

                        // 2. Check for website access submissions
                        if (data.hasUnreviewedWebsiteAccess && data.websiteAccessMethod) {
                            const accessType = data.websiteAccessMethod === 'admin-contact' ? 'Admin Contact' : 'Direct Access';
                            notifications.push({
                                type: 'website-access',
                                icon: '🌐',
                                title: `${data.clientName || 'Client'} submitted website access`,
                                message: `${accessType} information provided`,
                                clientId: clientId,
                                clientName: data.clientName,
                                timestamp: data.websiteAdminDetails?.submittedAt?.toDate() || data.websiteDirectAccess?.submittedAt?.toDate() || new Date(),
                                priority: 'medium',
                                adminOnly: 'nicolas'
                            });
                        }
                    });
                }

                // BRENNA NOTIFICATIONS (brenna@driveleadmedia.com)
                if (currentEmail === 'brenna@driveleadmedia.com') {
                    clientsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const clientId = doc.id;

                        // 4. Check for stuck portal (client hasn't progressed in 7+ days)
                        const lastUpdated = data.lastUpdated?.toDate() || data.createdAt?.toDate();
                        if (lastUpdated) {
                            const daysSinceUpdate = Math.floor((new Date() - lastUpdated) / (1000 * 60 * 60 * 24));

                            // Find which step they're stuck on
                            let stuckStep = null;
                            if (!data.step1Complete) stuckStep = 1;
                            else if (!data.step2Complete) stuckStep = 2;
                            else if (!data.step3Complete) stuckStep = 3;
                            else if (!data.step4Complete) stuckStep = 4;
                            else if (!data.step5Complete) stuckStep = 5;

                            if (stuckStep && daysSinceUpdate >= 7) {
                                const stepNames = {
                                    1: 'Sign Documents',
                                    2: 'Brand Assets',
                                    3: 'Campaign Strategy',
                                    4: 'Creative Review',
                                    5: 'Website Access'
                                };
                                notifications.push({
                                    type: 'stuck-portal',
                                    icon: '⏱️',
                                    title: `${data.clientName || 'Client'} stuck on Step ${stuckStep}`,
                                    message: `No progress on "${stepNames[stuckStep]}" for ${daysSinceUpdate} days`,
                                    clientId: clientId,
                                    clientName: data.clientName,
                                    timestamp: lastUpdated,
                                    priority: 'high',
                                    adminOnly: 'brenna'
                                });
                            }
                        }

                        // 5. Check for signature pending (DPA/Service Agreement not signed in 48+ hours)
                        // Note: This requires tracking when docs were viewed vs signed
                        // For now, we'll check if step 1 incomplete for 2+ days
                        if (!data.step1Complete) {
                            const createdDate = data.createdAt?.toDate();
                            if (createdDate) {
                                const hoursSinceCreation = (new Date() - createdDate) / (1000 * 60 * 60);
                                if (hoursSinceCreation >= 48) {
                                    notifications.push({
                                        type: 'signature-pending',
                                        icon: '📝',
                                        title: `${data.clientName || 'Client'} - Signature Pending`,
                                        message: `Portal created ${Math.floor(hoursSinceCreation / 24)} days ago but documents not signed`,
                                        clientId: clientId,
                                        clientName: data.clientName,
                                        timestamp: createdDate,
                                        priority: 'high',
                                        adminOnly: 'brenna'
                                    });
                                }
                            }
                        }
                    });

                    // 6. Check for stalled deals (haven't moved in 14+ days)
                    const dealsSnapshot = await db.collection('deals')
                        .where('archived', '==', false)
                        .get();

                    dealsSnapshot.forEach(doc => {
                        const deal = doc.data();
                        const lastUpdated = deal.lastUpdated?.toDate() || deal.createdAt?.toDate();
                        if (lastUpdated) {
                            const daysSinceUpdate = Math.floor((new Date() - lastUpdated) / (1000 * 60 * 60 * 24));
                            if (daysSinceUpdate >= 14 && deal.stage !== 'campaign-live' && deal.stage !== 'follow-up-resell') {
                                const stageNames = {
                                    'qualified': 'Qualified',
                                    'proposal-sent': 'Proposal Sent',
                                    'negotiation': 'Negotiation',
                                    'verbal-commitment': 'Verbal Commitment',
                                    'contract-sent': 'Contract Sent',
                                    'contract-signed': 'Contract Signed'
                                };
                                notifications.push({
                                    type: 'stalled-deal',
                                    icon: '🚨',
                                    title: `${deal.companyName || 'Deal'} stalled in pipeline`,
                                    message: `Stuck in "${stageNames[deal.stage] || deal.stage}" for ${daysSinceUpdate} days`,
                                    dealId: doc.id,
                                    timestamp: lastUpdated,
                                    priority: 'high',
                                    adminOnly: 'brenna'
                                });
                            }
                        }
                    });
                }

                // NICOLAS: Website forms (completed in last 24 hours)
                if (currentEmail === 'nicolas@driveleadmedia.com') {

                // Check for completed website forms (from website-quotes collection)
                // Wrap in try-catch in case permissions don't allow access
                try {
                    const quotesSnapshot = await db.collection('website-quotes')
                        .where('status', '==', 'completed')
                        .orderBy('completedAt', 'desc')
                        .limit(5)
                        .get();

                    quotesSnapshot.forEach(doc => {
                        const data = doc.data();
                        const completedDate = data.completedAt?.toDate();
                        const now = new Date();
                        const hoursSinceCompletion = completedDate ? (now - completedDate) / (1000 * 60 * 60) : 999;

                        // Only show if completed in last 24 hours
                        if (hoursSinceCompletion < 24) {
                            notifications.push({
                                type: 'website-form',
                                icon: '📝',
                                title: `${data.companyName || 'Company'} completed website form`,
                                message: `Form completed ${Math.round(hoursSinceCompletion)} hours ago`,
                                quoteId: doc.id,
                                timestamp: completedDate || new Date(),
                                priority: 'low',
                                adminOnly: 'nicolas'
                            });
                        }
                    });
                } catch (quotesError) {
                    console.warn('Could not load website forms notifications (permissions may not be set):', quotesError.message);
                    // Continue without website form notifications
                }
                } // End Nicolas notifications

                // Sort by priority and timestamp
                const priorityOrder = { high: 1, medium: 2, low: 3 };
                notifications.sort((a, b) => {
                    if (a.priority !== b.priority) {
                        return priorityOrder[a.priority] - priorityOrder[b.priority];
                    }
                    return b.timestamp - a.timestamp;
                });

                // Render notifications
                renderDashboardNotifications(notifications);

            } catch (error) {
                console.error('Error loading dashboard notifications:', error);
                // Still render empty state even if there's an error
                renderDashboardNotifications([]);
            }
        }

        // Render Dashboard Notifications
        function renderDashboardNotifications(notifications) {
            const container = document.getElementById('dashboardNotificationsList');
            const countBadge = document.getElementById('dashboardNotificationCount');
            const markAllBtn = document.getElementById('markAllReadBtn');

            if (notifications.length === 0) {
                // Show "All Caught Up" message
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #22c55e;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">✅</div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #166534; margin-bottom: 4px;">All Caught Up!</div>
                        <div style="color: #15803d; font-size: 0.9rem;">No pending notifications at this time</div>
                    </div>
                `;
                countBadge.style.display = 'none';
                markAllBtn.style.display = 'none';
                return;
            }

            // Show notification count and Mark All Read button
            countBadge.textContent = notifications.length;
            countBadge.style.display = 'inline-block';
            markAllBtn.style.display = 'inline-block';

            // Render each notification
            container.innerHTML = notifications.map(notification => {
                const timeAgo = getTimeAgo(notification.timestamp);
                const bgColor = notification.priority === 'high' ? '#fee2e2' :
                               notification.priority === 'medium' ? '#fff7ed' : '#f0f9ff';
                const borderColor = notification.priority === 'high' ? '#ef4444' :
                                   notification.priority === 'medium' ? '#f97316' : '#3b82f6';

                return `
                    <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s ease;"
                         onclick="handleNotificationClick('${notification.type}', '${notification.clientId || notification.quoteId}')"
                         onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                         onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">${notification.icon}</span>
                                <div style="font-weight: 700; color: #000000; font-size: 0.95rem;">${notification.title}</div>
                            </div>
                            <span style="font-size: 0.75rem; color: #6b7280; white-space: nowrap;">${timeAgo}</span>
                        </div>
                        <div style="margin-left: 40px; color: #374151; font-size: 0.9rem; line-height: 1.5;">${notification.message}</div>
                        <div style="margin-left: 40px; margin-top: 8px;">
                            <button style="background: ${borderColor}; color: white; border: none; padding: 6px 14px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Handle notification click
        function handleNotificationClick(type, id) {
            if (type === 'revision' || type === 'website-access' || type === 'stuck-portal' || type === 'signature-pending') {
                // Navigate to Clients tab and scroll to client
                switchAdminTab('clients');
                setTimeout(() => {
                    const clientCard = document.querySelector(`[data-client-id="${id}"]`);
                    if (clientCard) {
                        clientCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        clientCard.style.animation = 'pulse 1s ease 2';
                    }
                }, 300);
            } else if (type === 'stalled-deal') {
                // Navigate to Sales Pipeline tab
                switchAdminTab('sales-pipeline');
                setTimeout(() => {
                    const dealCard = document.querySelector(`[data-deal-id="${id}"]`);
                    if (dealCard) {
                        dealCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Highlight the card
                        const originalBg = dealCard.style.background;
                        dealCard.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%)';
                        setTimeout(() => {
                            dealCard.style.background = originalBg;
                        }, 2000);
                    }
                }, 300);
            } else if (type === 'website-form') {
                // Navigate to Website Forms tab
                switchAdminTab('website-forms');
            }
        }

        // Mark all dashboard notifications as read
        async function markAllDashboardNotificationsRead() {
            try {
                const clientsSnapshot = await db.collection('clients').get();
                const batch = db.batch();

                clientsSnapshot.forEach(doc => {
                    const data = doc.data();

                    // Mark revision requests as reviewed
                    if (data.revisionRequests && data.revisionRequests.length > 0) {
                        const updatedRevisions = data.revisionRequests.map(r => ({
                            ...r,
                            status: 'reviewed'
                        }));
                        batch.update(doc.ref, { revisionRequests: updatedRevisions });
                    }

                    // Mark website access as reviewed
                    if (data.hasUnreviewedWebsiteAccess) {
                        batch.update(doc.ref, { hasUnreviewedWebsiteAccess: false });
                    }
                });

                await batch.commit();
                loadDashboardNotifications(); // Reload to show "All Caught Up"
                showToast('All notifications marked as read', 'success');
            } catch (error) {
                console.error('Error marking notifications as read:', error);
                showToast('Error marking notifications as read', 'error');
            }
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
                }
            }

            return 'Just now';
        }

        // Toggle Archived Deals visibility
        window.toggleArchivedDeals = function() {
            const section = document.getElementById('archivedDealsSection');
            const btn = document.getElementById('toggleArchivedBtn');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.textContent = 'Hide Archived';
                btn.style.background = '#05908C';
                loadAdminArchivedDeals();
            } else {
                section.style.display = 'none';
                btn.textContent = 'Show Archived';
                btn.style.background = '#6b7280';
            }
        };

        // Initialize tab click handlers
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchAdminTab(tab.dataset.tab);
            });
        });

        // Load and display sales reps
        async function loadReps() {
            try {
                const snapshot = await db.collection('salesReps')
                    .orderBy('createdAt', 'desc')
                    .get();

                const grid = document.getElementById('repsGrid');
                grid.innerHTML = '';

                // Count active and inactive reps (excluding admins)
                const activeCount = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.active && data.role !== 'admin';
                }).length;
                const inactiveCount = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return !data.active && data.role !== 'admin';
                }).length;

                const activeDisplay = document.getElementById('totalRepsCount');
                const inactiveDisplay = document.getElementById('inactiveRepsCount');
                if (activeDisplay) activeDisplay.textContent = activeCount;
                if (inactiveDisplay) inactiveDisplay.textContent = inactiveCount;

                if (snapshot.empty) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: white; border-radius: 12px; border: 2px dashed #e5e7eb;">
                            <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;">👤</div>
                            <h3 style="color: #6b7280; font-weight: 500; margin-bottom: 8px;">No Sales Reps Yet</h3>
                            <p style="color: #9ca3af; font-size: 0.9rem;">Add your first rep using the form above to get started.</p>
                        </div>
                    `;
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();

                    // Skip admin users - don't show them in the sales team list
                    if (data.role === 'admin') {
                        return;
                    }

                    const card = document.createElement('div');
                    const cardBackground = '#FFF8E6';
                    card.style.cssText = `background: ${cardBackground}; border-radius: 12px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: all 0.2s ease; border: 1px solid #000000`;

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                    <h3 style="font-size: 1.1rem; font-weight: 700; color: #012E40; margin: 0;">${data.name}</h3>
                                    ${data.role === 'leadership' ? '<span class="badge badge-success" style="font-size: 0.7rem;">Leadership</span>' : ''}
                                </div>
                                <p style="color: #000000; font-size: 0.85rem; margin: 0;">${data.email || 'No email provided'}</p>
                                ${data.phone ? `<p style="color: #000000; font-size: 0.85rem; margin: 4px 0 0 0;">📞 ${data.phone}</p>` : ''}
                            </div>
                            <span class="badge badge-${data.active ? 'success' : 'secondary'}">${data.active ? 'Active' : 'Inactive'}</span>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                            <button class="btn-edit" onclick="editRep('${doc.id}')" style="flex: 1; padding: 10px; font-size: 0.85rem;">Edit</button>
                            <button class="btn-delete" onclick="deleteRep('${doc.id}', '${data.name}')" style="flex: 1; padding: 10px; font-size: 0.85rem;">Delete</button>
                        </div>
                    `;

                    card.addEventListener('mouseenter', () => {
                        card.style.boxShadow = '0 8px 32px rgba(1, 46, 64, 0.3)';
                        card.style.transform = 'translateY(-4px)';
                        card.style.borderColor = 'rgba(5, 144, 140, 0.6)';
                    });
                    card.addEventListener('mouseleave', () => {
                        card.style.boxShadow = '0 4px 20px rgba(1, 46, 64, 0.2)';
                        card.style.transform = 'translateY(0)';
                        card.style.borderColor = 'rgba(5, 144, 140, 0.3)';
                    });

                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading reps:', error);
                showAlert('Error loading sales reps: ' + error.message, 'error');
            }
        }

        // Edit sales rep - MUST be window.editRep for onclick to work
        window.editRep = async function(repId) {
            try {
                const doc = await db.collection('salesReps').doc(repId).get();
                if (!doc.exists) {
                    showAlert('Sales rep not found', 'error');
                    return;
                }

                const data = doc.data();

                // Populate form with existing data
                document.getElementById('repName').value = data.name;
                document.getElementById('repEmail').value = data.email;
                document.getElementById('repPhone').value = data.phone || '';
                // Don't populate password - it's managed by Firebase Auth
                document.getElementById('repPassword').value = '';
                document.getElementById('repPassword').placeholder = 'Leave blank to keep current password';
                document.getElementById('repRole').value = data.role;

                // Change form to update mode
                const form = document.getElementById('addRepForm');
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Update Rep';

                // Store repId for update
                form.dataset.editingRepId = repId;

                // Scroll to form
                form.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading rep for edit:', error);
                showAlert('Error loading sales rep: ' + error.message, 'error');
            }
        };

        // Delete sales rep - MUST be window.deleteRep for onclick to work
        window.deleteRep = async function(repId, repName) {
            // CRITICAL: Prevent admin from deleting themselves
            const currentUser = firebase.auth().currentUser;
            if (currentUser && currentUser.uid === repId) {
                showAlert('Error: You cannot delete your own admin account!', 'error');
                return;
            }

            // CRITICAL: Prevent deleting any admin user
            try {
                const repDoc = await db.collection('salesReps').doc(repId).get();
                if (repDoc.exists && repDoc.data().role === 'admin') {
                    showAlert('Error: Cannot delete admin users. Please change their role first.', 'error');
                    return;
                }
            } catch (error) {
                console.error('Error checking rep role:', error);
                showAlert('Error verifying rep permissions.', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${repName}? This will also archive all their deals.`)) {
                return;
            }

            try {
                // First, archive their deals BEFORE deleting the rep
                console.log('Archiving deals for rep:', repId);
                const dealsSnapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .get();

                console.log('Found', dealsSnapshot.size, 'deals to archive');

                if (!dealsSnapshot.empty) {
                    const batch = db.batch();
                    dealsSnapshot.forEach(doc => {
                        const dealData = doc.data();
                        batch.update(doc.ref, {
                            assignedTo: null,
                            stage: 'closed-lost',
                            archived: true,
                            archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            stageWhenLost: dealData.stage || 'unknown',
                            notes: (dealData.notes || '') + `\n[Auto-archived: Rep ${repName} was deleted]`,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    await batch.commit();
                    console.log('Deals archived successfully');
                }

                // Now delete the rep
                console.log('Deleting rep:', repId);
                await db.collection('salesReps').doc(repId).delete();
                console.log('Rep deleted successfully');

                showAlert(`Sales rep ${repName} deleted and their deals archived.`);
                loadReps();
            } catch (error) {
                console.error('Error deleting rep:', error);
                console.error('Error code:', error.code);
                console.error('Error details:', error);
                showAlert('Error deleting sales rep: ' + error.message, 'error');
            }
        };

        // Helper function to create Firebase Auth user
        async function createFirebaseAuthUser(email, password, displayName) {
            try {
                // Use Firebase Client SDK to create user
                // We'll use a secondary auth instance to avoid signing out the admin
                const secondaryApp = firebase.initializeApp(firebaseConfig, 'Secondary');

                const userCredential = await secondaryApp.auth().createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                // Update display name
                await userCredential.user.updateProfile({
                    displayName: displayName
                });

                // Sign out from secondary app (don't affect admin session)
                await secondaryApp.auth().signOut();

                // Delete the secondary app instance
                await secondaryApp.delete();

                return uid;
            } catch (error) {
                console.error('Error creating Firebase Auth user:', error);
                throw error;
            }
        }

        // Modify addRepForm submit handler to support both create and update
        document.getElementById('addRepForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn?.textContent;
            const editingRepId = form.dataset.editingRepId;

            const name = document.getElementById('repName')?.value;
            const email = document.getElementById('repEmail')?.value;
            const phone = document.getElementById('repPhone')?.value;
            const password = document.getElementById('repPassword')?.value;
            const role = document.getElementById('repRole')?.value;

            // Validate email is provided
            if (!email || !email.includes('@')) {
                showAlert('Please provide a valid email address for the sales rep.', 'error');
                return;
            }

            // Validate password
            if (!editingRepId && (!password || password.length < 6)) {
                showAlert('Password must be at least 6 characters long.', 'error');
                return;
            }

            const repData = {
                name: name,
                email: email,
                phone: phone || null,
                role: role,
                active: true
            };

            // Show loading state
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = editingRepId ? 'Updating...' : 'Creating...';
            }

            try {
                if (editingRepId) {
                    // Update existing rep (don't update password via Firestore)
                    repData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('salesReps').doc(editingRepId).update(repData);
                    showAlert('Sales rep updated successfully!');

                    // Reset form to add mode
                    delete form.dataset.editingRepId;
                    if (submitBtn) submitBtn.textContent = 'Create Sales Rep';
                } else {
                    // Create new rep with Firebase Authentication
                    if (submitBtn) submitBtn.textContent = 'Creating Firebase Auth user...';

                    // Step 1: Create Firebase Auth user
                    const uid = await createFirebaseAuthUser(email, password, name);

                    if (submitBtn) submitBtn.textContent = 'Saving to database...';

                    // Step 2: Create Firestore document with UID as document ID
                    repData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    // Don't store plaintext password in Firestore - Firebase Auth handles it
                    await db.collection('salesReps').doc(uid).set(repData);

                    showAlert('Sales rep created successfully! They can now login with their email and password.', 'success');
                }

                document.getElementById('addRepForm').reset();
                loadReps();
            } catch (error) {
                console.error('Error saving rep:', error);

                // Provide helpful error messages
                let errorMessage = 'Error saving sales rep: ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += 'This email is already registered. Please use a different email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'Invalid email format.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'Password is too weak. Use at least 6 characters.';
                } else {
                    errorMessage += error.message;
                }

                showAlert(errorMessage, 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            }
        });
        
        // Generate unique client ID
        function generateClientId() {
            return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Toggle portal type fields
        function togglePortalTypeFields() {
            const portalType = document.getElementById('portalType').value;
            const contractLinks = document.getElementById('contractLinks');
            const m2mLinks = document.getElementById('m2mLinks');

            if (portalType === 'm2m') {
                contractLinks.style.display = 'none';
                m2mLinks.style.display = 'block';
            } else {
                contractLinks.style.display = 'block';
                m2mLinks.style.display = 'none';
            }
        }

        // Initialize portal type toggle
        document.getElementById('portalType').addEventListener('change', togglePortalTypeFields);

        // Create new client
        document.getElementById('createClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate email
            const emailInput = document.getElementById('clientEmail');
            if (emailInput.value && !validateField(emailInput, isValidEmail, 'Please enter a valid email address')) {
                return;
            }

            // Validate URLs
            const urlInputs = [
                'creativeLink', 'dpaLink', 'service6Link', 'service12Link',
                'stripe6Monthly', 'stripe6Upfront', 'stripe12Monthly', 'stripe12Upfront',
                'm2mServiceAgreementLink', 'm2mDpaLink', 'm2mInvoiceLink'
            ];

            for (const inputId of urlInputs) {
                const input = document.getElementById(inputId);
                if (input && input.value && !validateField(input, isValidURL, 'Please enter a valid URL')) {
                    return;
                }
            }

            const clientId = generateClientId();
            const portalType = document.getElementById('portalType')?.value;

            // Base client data (common to both portal types)
            const clientData = {
                clientId: clientId,
                clientName: document.getElementById('clientName')?.value,
                clientEmail: document.getElementById('clientEmail')?.value || null,
                portalType: portalType, // NEW: Store portal type
                active: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),

                // Progress tracking
                step1Complete: false,
                step2Complete: false,
                step3Complete: false,
                step4Complete: false,
                step5Complete: false,

                // Shared links
                creativeLink: document.getElementById('creativeLink')?.value || null
            };

            // Add portal-specific links
            if (portalType === 'contract') {
                // Contract portal (6/12 month) links
                clientData.dpaLink = document.getElementById('dpaLink')?.value || null;
                clientData.service6Link = document.getElementById('service6Link')?.value || null;
                clientData.service12Link = document.getElementById('service12Link')?.value || null;
                clientData.stripe6Monthly = document.getElementById('stripe6Monthly')?.value || null;
                clientData.stripe6Upfront = document.getElementById('stripe6Upfront')?.value || null;
                clientData.stripe12Monthly = document.getElementById('stripe12Monthly')?.value || null;
                clientData.stripe12Upfront = document.getElementById('stripe12Upfront')?.value || null;
            } else if (portalType === 'm2m') {
                // Month-to-month portal links
                clientData.serviceAgreementLink = document.getElementById('m2mServiceAgreementLink')?.value || null;
                clientData.dpaLink = document.getElementById('m2mDpaLink')?.value || null;
                clientData.invoiceLink = document.getElementById('m2mInvoiceLink')?.value || null;
            }

            try {
                await db.collection('clients').doc(clientId).set(clientData);

                // Generate unified portal URL
                const portalUrl = `${PORTAL_BASE_URL}/client.html?id=${clientId}`;

                showAlert(`${portalType === 'm2m' ? 'Month-to-Month' : 'Contract'} portal created successfully! Portal link: ${portalUrl}`);
                document.getElementById('createClientForm').reset();
                togglePortalTypeFields(); // Reset UI to default
                loadClients();
            } catch (error) {
                console.error('Error creating client:', error);
                showAlert('Error creating client portal. Please try again.', 'error');
            }
        });

        // Helper function to get file icon
        function getFileIcon(type) {
            if (!type) return '📁';
            const typeStr = String(type).toLowerCase();
            if (typeStr.includes('pdf')) return '📄';
            if (typeStr.includes('font') || typeStr.includes('ttf') || typeStr.includes('otf') || typeStr.includes('woff')) return '🔤';
            if (typeStr.includes('image') || typeStr.includes('png') || typeStr.includes('jpg') || typeStr.includes('jpeg') || typeStr.includes('svg')) return '🖼️';
            return '📁';
        }

        // Download file using Firebase Storage with proper headers
        window.downloadFile = async function(url, filename) {
            try {
                // Get storage reference from URL
                const storageRef = firebase.storage().refFromURL(url);

                // Get metadata to determine content type
                const metadata = await storageRef.getMetadata();

                // Fetch the file as blob with proper CORS
                const xhr = new XMLHttpRequest();
                xhr.responseType = 'blob';

                xhr.onload = function() {
                    // Create blob URL
                    const blob = xhr.response;
                    const blobUrl = window.URL.createObjectURL(blob);

                    // Create download link
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename || metadata.name || 'download';
                    document.body.appendChild(a);
                    a.click();

                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(blobUrl);
                    }, 100);
                };

                xhr.onerror = function() {
                    console.error('Download failed, opening in new tab');
                    window.open(url, '_blank');
                };

                xhr.open('GET', url);
                xhr.send();

            } catch (error) {
                console.error('Error downloading:', error);
                window.open(url, '_blank');
            }
        };

        // Toggle card collapse/expand
        window.toggleCardCollapse = function(clientId) {
            const content = document.getElementById(`content-${clientId}`);
            const arrow = document.getElementById(`arrow-${clientId}`);

            if (!content || !arrow) return;

            const isCollapsed = content.style.maxHeight === '0px' || content.style.maxHeight === '';

            if (isCollapsed) {
                // Expand
                content.style.maxHeight = content.scrollHeight + 'px';
                arrow.style.transform = 'rotate(180deg)';
                // After transition, set to 'none' to allow dynamic content changes
                setTimeout(() => {
                    if (content.style.maxHeight !== '0px') {
                        content.style.maxHeight = 'none';
                    }
                }, 300);
            } else {
                // Collapse
                content.style.maxHeight = content.scrollHeight + 'px';
                // Force reflow
                content.offsetHeight;
                content.style.maxHeight = '0px';
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        // Load existing clients
        async function loadClients() {
            try {
                const snapshot = await db.collection('clients').orderBy('createdAt', 'desc').get();
                const grid = document.getElementById('clientsGrid');
                grid.innerHTML = '';

                // Count total and active clients
                const activeCount = snapshot.docs.filter(doc => doc.data().active).length;

                const totalDisplay = document.getElementById('totalClientsCount');
                const activeDisplay = document.getElementById('activeClientsCount');
                if (totalDisplay) totalDisplay.textContent = snapshot.size;
                if (activeDisplay) activeDisplay.textContent = activeCount;

                if (snapshot.empty) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: white; border-radius: 12px; border: 2px dashed #e5e7eb;">
                            <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;">📋</div>
                            <h3 style="color: #6b7280; font-weight: 500; margin-bottom: 8px;">No Clients Yet</h3>
                            <p style="color: #9ca3af; font-size: 0.9rem;">Click "Add New Client" above to create your first portal.</p>
                        </div>
                    `;
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id; // Use Firestore document ID

                    // Generate correct portal link based on portal type
                    const portalType = data.portalType || 'contract';
                    const portalLink = `${PORTAL_BASE_URL}/client.html?id=${docId}`;

                    // Calculate progress percentage
                    const completedSteps = [
                        data.step1Complete,
                        data.step2Complete,
                        data.step3Complete,
                        data.step4Complete,
                        data.step5Complete,
                        data.step6Complete
                    ].filter(Boolean).length;
                    const progressPercent = (completedSteps / 6) * 100;

                    // Check for pending revision requests and website access
                    const hasPendingRevision = data.hasPendingRevision || false;
                    const hasUnreviewedWebsiteAccess = data.hasUnreviewedWebsiteAccess || false;
                    const needsAttention = hasPendingRevision || hasUnreviewedWebsiteAccess;

                    const card = document.createElement('div');
                    card.setAttribute('data-client-id', docId); // Add data attribute for notification navigation
                    const baseCardStyle = 'background: #FFF8E6; border-radius: 12px; padding: 20px; transition: all 0.2s ease; backdrop-filter: blur(8px);';
                    const attentionStyle = needsAttention
                        ? 'box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), 0 6px 30px rgba(1, 46, 64, 0.3); border: 2px solid rgba(239, 68, 68, 0.8); animation: revisionPulse 2s infinite;'
                        : 'box-shadow: 0 6px 30px rgba(1, 46, 64, 0.3); border: 2px solid rgba(5, 144, 140, 0.3);';
                    card.style.cssText = baseCardStyle + attentionStyle;

                    card.innerHTML = `
                        <!-- Collapsible Header -->
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; cursor: pointer; padding: 8px; margin: -8px -8px 14px -8px; border-radius: 8px; transition: background 0.2s ease;" onmouseover="this.style.background='rgba(5, 144, 140, 0.08)'" onmouseout="this.style.background='transparent'" onclick="toggleCardCollapse('${docId}')">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <span class="collapse-arrow" id="arrow-${docId}" style="font-size: 1.2rem; transition: transform 0.3s ease; color: #05908C;">▼</span>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <h3 style="font-size: 1.1rem; font-weight: 700; color: #000000; margin: 0;">${data.clientName}</h3>
                                        <span class="badge badge-${portalType === 'm2m' ? 'warning' : 'success'}" style="font-size: 0.7rem;">${portalType === 'm2m' ? 'M2M' : 'Contract'}</span>
                                        ${hasPendingRevision ? '<span class="badge badge-danger" style="font-size: 0.7rem; background: #ef4444; animation: pulse 2s infinite;">Revision Request</span>' : ''}
                                        ${hasUnreviewedWebsiteAccess ? '<span class="badge badge-danger" style="font-size: 0.7rem; background: #ef4444; animation: pulse 2s infinite;">Website Access</span>' : ''}
                                    </div>
                                    <p style="color: #000000; font-size: 0.85rem; margin: 0 0 8px 0;">${data.clientEmail || 'No email provided'}</p>
                                    <!-- Progress Bar in Header -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden; border: 1px solid #000000;">
                                            <div style="background: linear-gradient(90deg, #05908C 0%, #47a5a3 100%); height: 100%; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
                                        </div>
                                        <span style="font-size: 0.75rem; font-weight: 700; color: #000000; min-width: 45px; text-align: right;">${completedSteps}/6</span>
                                    </div>
                                </div>
                            </div>
                            <span class="badge badge-${data.active ? 'success' : 'secondary'}" onclick="event.stopPropagation()">${data.active ? 'Active' : 'Inactive'}</span>
                        </div>

                        <!-- Collapsible Content -->
                        <div class="card-content" id="content-${docId}" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                            <div style="padding-top: 4px;">

                        ${data.brandLogoUrl || data.brandColors || data.brandPrimaryColor || data.brandSecondaryColor || (data.brandAssets && data.brandAssets.length > 0) ? `
                            <div style="background: #E8F5F3; border-radius: 8px; padding: 12px; margin-bottom: 14px; border: 1px solid #05908C;">
                                <div style="font-size: 0.7rem; color: #012E40; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Brand Assets</div>

                                <!-- Logo & Colors -->
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: ${data.brandAssets && data.brandAssets.length > 0 ? '12px' : '0'};">
                                    ${data.brandLogoUrl ? `
                                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                                            <img src="${data.brandLogoUrl}" alt="${data.clientName} logo" style="width: 60px; height: 60px; object-fit: contain; border-radius: 6px; background: white; padding: 4px; border: 1px solid #d1d5db;" />
                                            <div style="display: flex; gap: 4px;">
                                                <a href="${data.brandLogoUrl}" target="_blank" style="padding: 3px 8px; background: #e8f5f3; color: #05908C; border-radius: 4px; font-size: 0.65rem; font-weight: 600; text-decoration: none; transition: all 0.2s ease; border: 1px solid #05908C; white-space: nowrap;" onmouseover="this.style.background='#d1fae5'" onmouseout="this.style.background='#e8f5f3'">
                                                    👁️ Preview
                                                </a>
                                                <button onclick="downloadFile('${data.brandLogoUrl}', '${data.clientName}-logo')" style="padding: 3px 8px; background: #05908C; color: white; border-radius: 4px; font-size: 0.65rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s ease; white-space: nowrap;" onmouseover="this.style.background='#047a77'" onmouseout="this.style.background='#05908C'">
                                                    📥 Download
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${(data.brandColors && data.brandColors.length > 0) || data.brandPrimaryColor || data.brandSecondaryColor ? `
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.7rem; color: #012E40; margin-bottom: 4px; font-weight: 600;">Brand Colors</div>
                                            <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                                                ${data.brandColors && data.brandColors.length > 0 ?
                                                    data.brandColors.map(color => `
                                                        <div style="display: flex; align-items: center; gap: 4px;">
                                                            <div style="width: 24px; height: 24px; border-radius: 4px; background: ${color}; border: 2px solid #000;"></div>
                                                            <span style="font-size: 0.75rem; color: #012E40; font-family: monospace;">${color}</span>
                                                        </div>
                                                    `).join('')
                                                :
                                                    `${data.brandPrimaryColor ? `
                                                        <div style="display: flex; align-items: center; gap: 4px;">
                                                            <div style="width: 24px; height: 24px; border-radius: 4px; background: ${data.brandPrimaryColor}; border: 2px solid #000;"></div>
                                                            <span style="font-size: 0.75rem; color: #012E40; font-family: monospace;">${data.brandPrimaryColor}</span>
                                                        </div>
                                                    ` : ''}
                                                    ${data.brandSecondaryColor ? `
                                                        <div style="display: flex; align-items: center; gap: 4px;">
                                                            <div style="width: 24px; height: 24px; border-radius: 4px; background: ${data.brandSecondaryColor}; border: 2px solid #000;"></div>
                                                            <span style="font-size: 0.75rem; color: #012E40; font-family: monospace;">${data.brandSecondaryColor}</span>
                                                        </div>
                                                    ` : ''}`
                                                }
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- Brand Asset Files -->
                                ${data.brandAssets && data.brandAssets.length > 0 ? `
                                    <div style="border-top: 1px solid #05908C; padding-top: 12px;">
                                        <div style="font-size: 0.7rem; color: #012E40; margin-bottom: 8px; font-weight: 600;">${data.brandAssets.length} Additional File${data.brandAssets.length > 1 ? 's' : ''}</div>
                                        <div style="display: flex; flex-direction: column; gap: 6px;">
                                            ${data.brandAssets.map(file => `
                                                <div style="display: flex; align-items: center; gap: 8px; padding: 6px; background: white; border-radius: 6px; transition: all 0.2s ease; border: 1px solid #d1d5db;">
                                                    <span style="font-size: 1rem;">${getFileIcon(file.type || file.name)}</span>
                                                    <span style="flex: 1; color: #012E40; font-size: 0.75rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</span>
                                                    <a href="${file.url}" target="_blank" style="padding: 4px 10px; background: #e8f5f3; color: #05908C; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-decoration: none; transition: all 0.2s ease; border: 1px solid #05908C;" onmouseover="this.style.background='#d1fae5'" onmouseout="this.style.background='#e8f5f3'">
                                                        👁️ Preview
                                                    </a>
                                                    <button onclick="downloadFile('${file.url}', '${file.name}')" style="padding: 4px 10px; background: #05908C; color: white; border-radius: 4px; font-size: 0.7rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s ease;" onmouseover="this.style.background='#047a77'" onmouseout="this.style.background='#05908C'">
                                                        📥 Download
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-size: 0.75rem; color: #000000; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Onboarding Progress</span>
                                <span style="font-size: 0.85rem; font-weight: 700; color: #000000;">${completedSteps}/6 Steps</span>
                            </div>
                            <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; border: 1px solid #000000;">
                                <div style="background: linear-gradient(90deg, #05908C 0%, #47a5a3 100%); height: 100%; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="display: flex; gap: 6px; margin-top: 10px;">
                                <div class="progress-step ${data.step1Complete ? 'complete' : ''}" style="flex: 1; text-align: center; padding: 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: ${data.step1Complete ? '#05908C' : '#d1d5db'}; color: ${data.step1Complete ? 'white' : '#000000'}; border: 1px solid #000000;">1</div>
                                <div class="progress-step ${data.step2Complete ? 'complete' : ''}" style="flex: 1; text-align: center; padding: 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: ${data.step2Complete ? '#05908C' : '#d1d5db'}; color: ${data.step2Complete ? 'white' : '#000000'}; border: 1px solid #000000;">2</div>
                                <div class="progress-step ${data.step3Complete ? 'complete' : ''}" style="flex: 1; text-align: center; padding: 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: ${data.step3Complete ? '#05908C' : '#d1d5db'}; color: ${data.step3Complete ? 'white' : '#000000'}; border: 1px solid #000000;">3</div>
                                <div class="progress-step ${data.step4Complete ? 'complete' : ''}" style="flex: 1; text-align: center; padding: 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: ${data.step4Complete ? '#05908C' : '#d1d5db'}; color: ${data.step4Complete ? 'white' : '#000000'}; border: 1px solid #000000;">4</div>
                                <div class="progress-step ${data.step5Complete ? 'complete' : ''}" style="flex: 1; text-align: center; padding: 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: ${data.step5Complete ? '#05908C' : '#d1d5db'}; color: ${data.step5Complete ? 'white' : '#000000'}; border: 1px solid #000000;">5</div>
                                <div class="progress-step ${data.step6Complete ? 'complete' : ''}" style="flex: 1; text-align: center; padding: 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: ${data.step6Complete ? '#05908C' : '#d1d5db'}; color: ${data.step6Complete ? 'white' : '#000000'}; border: 1px solid #000000;">6</div>
                            </div>
                        </div>

                        <div style="background: transparent; border-radius: 8px; padding: 10px; margin-bottom: 14px;">
                            <div style="font-size: 0.7rem; color: #000000; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Portal Link</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" value="${portalLink}" id="link-${docId}" readonly style="flex: 1; background: white; border: 1px solid #9ca3af; border-radius: 6px; padding: 8px; font-size: 0.8rem; color: #000000; font-family: monospace;">
                                <button class="copy-btn" onclick="copyLink('${docId}')" style="padding: 8px 16px; white-space: nowrap;">Copy</button>
                            </div>
                        </div>

                        ${hasPendingRevision ? `
                            <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 12px; margin-bottom: 14px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <div style="font-weight: 700; color: #991b1b; margin-bottom: 4px;">Revision Request Pending</div>
                                        <div style="font-size: 0.8rem; color: #7f1d1d;">Client requested creative changes</div>
                                    </div>
                                    <button class="btn" onclick="viewRevisionRequest('${docId}')" style="background: #ef4444; color: white; padding: 8px 16px; font-size: 0.85rem; white-space: nowrap;">View Details</button>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Creatives Section -->
                        ${data.creatives && data.creatives.length > 0 ? `
                            <div style="background: #FEF3C7; border-radius: 8px; padding: 12px; margin-bottom: 14px; border: 1px solid #F2A922;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <div style="font-size: 0.7rem; color: #012E40; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">${data.creatives.length} Creative${data.creatives.length > 1 ? 's' : ''} Uploaded</div>
                                    <button class="btn btn-small" onclick="uploadCreatives('${docId}', '${data.clientName}')" style="padding: 6px 12px; font-size: 0.75rem; background: #F2A922; color: #012E40;">Add More</button>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px;">
                                    ${data.creatives.map((creative, idx) => {
                                        const isVideo = creative.type && creative.type.startsWith('video/');
                                        const creativeId = `creative-${docId}-${idx}`;
                                        const previewBtnId = `preview-btn-${docId}-${idx}`;
                                        const thumbnailId = `thumbnail-${docId}-${idx}`;
                                        return `
                                        <div style="display: flex; flex-direction: column; gap: 4px;">
                                            ${isVideo ? `
                                                <div id="${thumbnailId}" class="creative-thumbnail" data-url="${creative.url}" data-name="${creative.name}" data-is-video="true" style="position: relative; width: 100%; aspect-ratio: 1; background: #000; border-radius: 6px; border: 2px solid #F2A922; overflow: hidden; cursor: pointer;">
                                                    <video id="${creativeId}" src="${creative.url}" preload="metadata" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;"></video>
                                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">▶️</div>
                                                </div>
                                            ` : `
                                                <img id="${thumbnailId}" class="creative-thumbnail" data-url="${creative.url}" data-name="${creative.name}" data-is-video="false" src="${creative.url}" alt="${creative.name}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 6px; border: 2px solid #F2A922; cursor: pointer;">
                                            `}
                                            <div style="display: flex; gap: 2px;">
                                                <button id="${previewBtnId}" class="preview-creative-btn" data-url="${creative.url}" data-name="${creative.name}" data-is-video="${isVideo}" style="flex: 1; padding: 3px 6px; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 0.6rem; font-weight: 600; text-align: center; transition: all 0.2s ease; border: 1px solid #F2A922; white-space: nowrap; cursor: pointer;" onmouseover="this.style.background='#fde68a'" onmouseout="this.style.background='#fef3c7'">
                                                    👁️
                                                </button>
                                                <button onclick="event.preventDefault(); event.stopPropagation(); downloadFile('${creative.url}', '${creative.name}')" style="flex: 1; padding: 3px 6px; background: #F2A922; color: #012E40; border-radius: 4px; font-size: 0.6rem; font-weight: 600; text-align: center; transition: all 0.2s ease; white-space: nowrap; border: 1px solid #F2A922; cursor: pointer;" onmouseover="this.style.background='#f59e0b'" onmouseout="this.style.background='#F2A922'">
                                                    📥
                                                </button>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <button class="btn btn-outline" onclick="uploadCreatives('${docId}', '${data.clientName}')" style="width: 100%; margin-bottom: 14px; padding: 10px; font-size: 0.85rem; border: 2px dashed #F2A922; color: #F2A922; background: #FBE9D1;">
                                Upload Creatives
                            </button>
                        `}

                        <!-- Website Access Details Section -->
                        ${data.websiteAccessMethod ? `
                            <div style="background: ${hasUnreviewedWebsiteAccess ? '#fee2e2' : '#f0fdf4'}; border-radius: 8px; padding: 14px; margin-bottom: 14px; border: 2px solid ${hasUnreviewedWebsiteAccess ? '#ef4444' : '#22c55e'};">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 0.7rem; color: #012E40; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                                        ${data.websiteAccessMethod === 'admin-contact' ? 'Website Admin Contact' : 'Direct Website Access'}
                                    </div>
                                    ${hasUnreviewedWebsiteAccess ? `
                                        <button class="btn btn-small" onclick="markWebsiteAccessReviewed('${docId}')" style="padding: 4px 10px; font-size: 0.7rem; background: #22c55e; color: white; border: none;">Mark Reviewed</button>
                                    ` : `
                                        <span style="font-size: 0.7rem; color: #22c55e; font-weight: 600;">✓ Reviewed</span>
                                    `}
                                </div>

                                ${data.websiteAccessMethod === 'admin-contact' && data.websiteAdminDetails ? `
                                    <div style="font-size: 0.85rem; line-height: 1.6; color: #012E40;">
                                        <div style="margin-bottom: 6px;"><strong>Name:</strong> ${data.websiteAdminDetails.name}</div>
                                        <div style="margin-bottom: 6px;"><strong>Email:</strong> <a href="mailto:${data.websiteAdminDetails.email}" style="color: #05908C; text-decoration: none;">${data.websiteAdminDetails.email}</a></div>
                                        <div style="margin-bottom: 6px;"><strong>Phone:</strong> ${data.websiteAdminDetails.phone !== 'Not provided' ? `<a href="tel:${data.websiteAdminDetails.phone}" style="color: #05908C; text-decoration: none;">${data.websiteAdminDetails.phone}</a>` : data.websiteAdminDetails.phone}</div>
                                        <div><strong>Platform:</strong> ${data.websiteAdminDetails.platform}</div>
                                    </div>
                                ` : ''}

                                ${data.websiteAccessMethod === 'direct-access' && data.websiteDirectAccess ? `
                                    <div style="font-size: 0.85rem; line-height: 1.6; color: #012E40;">
                                        <div style="margin-bottom: 6px;"><strong>Website:</strong> <a href="${data.websiteDirectAccess.websiteUrl}" target="_blank" style="color: #05908C; text-decoration: none;">${data.websiteDirectAccess.websiteUrl}</a></div>
                                        <div style="margin-bottom: 6px;"><strong>Login URL:</strong> ${data.websiteDirectAccess.loginUrl}</div>
                                        <div style="margin-bottom: 6px;"><strong>Username:</strong> <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.8rem;">${data.websiteDirectAccess.username}</code></div>
                                        <div style="margin-bottom: 6px;"><strong>Password:</strong> <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.8rem;">${data.websiteDirectAccess.password}</code></div>
                                        <div><strong>Platform:</strong> ${data.websiteDirectAccess.platform}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <!-- Deal Stage Info (if linked to deal) -->
                        <div id="deal-info-${docId}" style="margin-bottom: 14px;">
                            ${data.linkedDealId ? `
                                <div style="background: linear-gradient(135deg, #FBE9D1 0%, #FFF8E6 100%); border-radius: 8px; padding: 12px; border: 2px solid #F2A922;">
                                    <div style="font-size: 0.75rem; color: #F2A922; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">💼 Active Deal</div>
                                    <div class="deal-stage-data" style="font-size: 0.75rem; color: #012E40; margin-bottom: 8px;">Loading deal data...</div>
                                    <button onclick="viewLinkedDeal('${data.linkedDealId}'); event.stopPropagation();"
                                            style="padding: 8px 16px; background: #F2A922; color: #012E40; border: none;
                                                   border-radius: 6px; font-size: 0.8rem; cursor: pointer;
                                                   font-weight: 600; width: 100%; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#f59e0b'"
                                            onmouseout="this.style.background='#F2A922'">
                                        View Deal →
                                    </button>
                                </div>
                            ` : ''}
                        </div>

                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-${data.active ? 'secondary' : 'success'} btn-small" onclick="toggleStatus('${docId}', ${!data.active})" style="flex: 1; padding: 10px; font-size: 0.85rem;">
                                ${data.active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="btn btn-small" onclick="editClient('${docId}')" style="flex: 1; padding: 10px; font-size: 0.85rem;">Edit</button>
                        </div>

                        <button class="btn btn-outline" onclick="resetClientData('${docId}', '${data.clientName}')" style="width: 100%; margin-top: 10px; padding: 10px; font-size: 0.85rem; border: 2px solid #F2584E; color: #F2584E; background: transparent;">
                            Reset Portal Data
                        </button>
                            </div>
                        </div>
                    `;

                    card.addEventListener('mouseenter', () => {
                        card.style.boxShadow = '0 8px 32px rgba(1, 46, 64, 0.3)';
                        card.style.transform = 'translateY(-4px)';
                        card.style.borderColor = 'rgba(5, 144, 140, 0.6)';
                    });
                    card.addEventListener('mouseleave', () => {
                        card.style.boxShadow = '0 4px 20px rgba(1, 46, 64, 0.2)';
                        card.style.transform = 'translateY(0)';
                        card.style.borderColor = 'rgba(5, 144, 140, 0.3)';
                    });

                    grid.appendChild(card);
                });

                // Load deal data for clients with linked deals
                await loadDealDataForClients(snapshot.docs);

                // Attach event listeners to creative preview buttons and thumbnails
                attachCreativePreviewListeners();
            } catch (error) {
                console.error('Error loading clients:', error);
                showAlert('Error loading clients', 'error');
            }
        }

        // Attach event listeners to creative preview elements using event delegation
        function attachCreativePreviewListeners() {
            const clientsGrid = document.getElementById('clientsGrid');

            // Remove existing listener if any
            if (window.creativePreviewHandler) {
                clientsGrid.removeEventListener('click', window.creativePreviewHandler, true);
            }

            // Create new handler
            window.creativePreviewHandler = function(e) {
                // Check if clicked element or its parent is a preview button
                const previewBtn = e.target.closest('.preview-creative-btn');
                const thumbnail = e.target.closest('.creative-thumbnail');

                if (previewBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    const url = previewBtn.getAttribute('data-url');
                    const name = previewBtn.getAttribute('data-name');
                    const isVideo = previewBtn.getAttribute('data-is-video') === 'true';

                    console.log('🔵 Preview BUTTON clicked:', { url, name, isVideo });
                    window.openCreativePreview(url, name, isVideo);
                    return false;
                }

                if (thumbnail) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    const url = thumbnail.getAttribute('data-url');
                    const name = thumbnail.getAttribute('data-name');
                    const isVideo = thumbnail.getAttribute('data-is-video') === 'true';

                    console.log('🔵 THUMBNAIL clicked:', { url, name, isVideo });
                    window.openCreativePreview(url, name, isVideo);
                    return false;
                }
            };

            // Use event delegation - listen on the parent container in capture phase
            clientsGrid.addEventListener('click', window.creativePreviewHandler, true);

            console.log('✅ Creative preview listeners attached via event delegation');
        }

        // Load deal data for clients with linked deals
        async function loadDealDataForClients(clientDocs) {
            const clientsWithDeals = clientDocs.filter(doc => doc.data().linkedDealId);

            for (const clientDoc of clientsWithDeals) {
                const clientData = clientDoc.data();
                const docId = clientDoc.id;

                try {
                    const dealDoc = await db.collection('deals').doc(clientData.linkedDealId).get();

                    if (dealDoc.exists) {
                        const dealData = dealDoc.data();

                        // Find the stage name
                        const stage = PIPELINE_STAGES.find(s => s.id === dealData.stage);
                        const stageName = stage ? stage.name : dealData.stage;
                        const stageColor = stage ? stage.color : '#05908C';

                        // Calculate deal value
                        const dealValue = dealData.mrr && dealData.contractLength
                            ? dealData.mrr * dealData.contractLength
                            : (dealData.mrr || 0);
                        const formattedValue = dealValue > 0
                            ? `$${dealValue.toLocaleString()}`
                            : '$0';

                        // Update the deal info section
                        const dealInfoElement = document.querySelector(`#deal-info-${docId} .deal-stage-data`);

                        if (dealInfoElement) {
                            dealInfoElement.innerHTML = `
                                <div style="margin-bottom: 4px;"><strong>${dealData.companyName}</strong></div>
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <span style="background: ${stageColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">${stageName}</span>
                                </div>
                                <div style="font-weight: 600; color: #F2A922; font-size: 0.9rem;">${formattedValue}</div>
                            `;
                        }
                    } else {
                        // Deal not found
                        const dealInfoElement = document.querySelector(`#deal-info-${docId} .deal-stage-data`);
                        if (dealInfoElement) {
                            dealInfoElement.innerHTML = '<div style="color: #991b1b;">⚠️ Deal not found</div>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading deal data for client:', error);
                }
            }
        }

        // Cross-tab navigation: View linked deal from client
        window.viewLinkedDeal = function(dealId) {
            // Switch to Sales Pipeline tab
            switchAdminTab('sales-pipeline');

            // Scroll to and highlight the deal card
            setTimeout(() => {
                const dealCard = document.getElementById(`deal-${dealId}`);
                if (dealCard) {
                    dealCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Add highlight animation
                    dealCard.style.transition = 'all 0.3s ease';
                    dealCard.style.boxShadow = '0 0 30px rgba(242, 169, 34, 0.8), 0 6px 30px rgba(1, 46, 64, 0.3)';
                    dealCard.style.transform = 'scale(1.05)';

                    // Remove highlight after 2 seconds
                    setTimeout(() => {
                        dealCard.style.boxShadow = '0 6px 12px rgba(0, 0, 0, 0.15)';
                        dealCard.style.transform = 'scale(1)';
                    }, 2000);
                }
            }, 300);
        };

        // Copy portal link
        function copyLink(clientId) {
            const input = document.getElementById(`link-${clientId}`);
            input.select();
            document.execCommand('copy');
            showAlert('Portal link copied to clipboard!');
        }
        
        // Toggle client status
        async function toggleStatus(clientId, activate) {
            try {
                await db.collection('clients').doc(clientId).update({
                    active: activate,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                showAlert(`Client ${activate ? 'activated' : 'deactivated'} successfully`);
                loadClients();
            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('Error updating client status', 'error');
            }
        }

        // Mark website access as reviewed
        async function markWebsiteAccessReviewed(clientId) {
            try {
                await db.collection('clients').doc(clientId).update({
                    hasUnreviewedWebsiteAccess: false,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                showAlert('Website access marked as reviewed');
                loadClients();
            } catch (error) {
                console.error('Error marking website access as reviewed:', error);
                showAlert('Error updating status', 'error');
            }
        }

        // Open reset portal confirmation modal
        async function resetClientData(clientId, clientName) {
            // Check if client has linked deal
            const clientDoc = await db.collection('clients').doc(clientId).get();
            const clientData = clientDoc.data();

            if (clientData.linkedDealId) {
                const confirmReset = confirm(`Warning: "${clientName}" is linked to an active deal.\n\nResetting this portal will unlink it from the deal and clear all onboarding data.\n\nDo you want to continue?`);

                if (!confirmReset) {
                    return;
                }
            }

            // Store client info in hidden fields
            document.getElementById('resetClientId').value = clientId;
            document.getElementById('resetClientName').value = clientName;
            document.getElementById('resetClientNameDisplay').textContent = clientName;

            // Reset checkbox and button state
            const checkbox = document.getElementById('confirmResetCheckbox');
            const button = document.getElementById('confirmResetButton');
            checkbox.checked = false;
            button.disabled = true;
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';

            // Show modal
            document.getElementById('resetPortalModal').style.display = 'flex';
        }

        // Close reset portal modal
        function closeResetPortalModal() {
            document.getElementById('resetPortalModal').style.display = 'none';
            document.getElementById('confirmResetCheckbox').checked = false;
        }

        // Enable/disable reset button based on checkbox
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('confirmResetCheckbox');
            const button = document.getElementById('confirmResetButton');

            if (checkbox && button) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                    } else {
                        button.disabled = true;
                        button.style.opacity = '0.5';
                        button.style.cursor = 'not-allowed';
                    }
                });
            }

            // Close modal when clicking outside
            const resetModal = document.getElementById('resetPortalModal');
            if (resetModal) {
                resetModal.addEventListener('click', function(e) {
                    if (e.target === resetModal) {
                        closeResetPortalModal();
                    }
                });
            }
        });

        // Confirm and execute reset portal data
        async function confirmResetPortalData() {
            const clientId = document.getElementById('resetClientId').value;
            const clientName = document.getElementById('resetClientName').value;

            try {
                // Get current client data to preserve specific fields
                const clientDoc = await db.collection('clients').doc(clientId).get();
                const currentData = clientDoc.data();

                // Remove link from deal if exists
                if (currentData.linkedDealId) {
                    try {
                        await db.collection('deals').doc(currentData.linkedDealId).update({
                            clientPortalId: null
                        });
                        console.log('✓ Removed client link from deal');
                    } catch (err) {
                        console.error('Error removing deal link:', err);
                    }
                }

                // Reset all progress and form data
                await db.collection('clients').doc(clientId).update({
                    // Step completion flags
                    step1Complete: false,
                    step2Complete: false,
                    step3Complete: false,
                    step4Complete: false,
                    step5Complete: false,
                    step6Complete: false,

                    // Progress tracking
                    currentStep: 0,
                    completedSteps: [],
                    progress: 0,

                    // Brand assets
                    brandColors: [],
                    brandPrimaryColor: null,
                    brandSecondaryColor: null,
                    brandLogoUrl: null,
                    brandAssets: [],

                    // Creatives
                    creatives: [],

                    // Meta/Facebook setup
                    metaBusinessManagerId: null,
                    metaAdAccountId: null,
                    metaPageId: null,
                    metaPixelId: null,
                    metaBusinessManagerUrl: null,
                    metaBusinessManagerEmail: null,

                    // Google Analytics
                    ga4PropertyId: null,
                    ga4MeasurementId: null,
                    googleAnalyticsEmail: null,

                    // Website access
                    websiteAccessMethod: null,
                    websiteUrl: null,
                    websiteUsername: null,
                    websitePassword: null,
                    hostingProvider: null,
                    hasUnreviewedWebsiteAccess: false,

                    // Revision requests
                    revisionRequests: [],

                    // Contract/payment info (reset to null)
                    contractType: currentData?.contractType || null,
                    paymentPlan: null,

                    // Remove deal link
                    linkedDealId: null,
                    dealStage: null,

                    // Timestamp
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeResetPortalModal();
                showAlert(`Portal data reset successfully for ${clientName}`, 'success');
                loadClients();
            } catch (error) {
                console.error('Error resetting client data:', error);
                showAlert('Error resetting client data: ' + error.message, 'error');
            }
        }

        // Edit client - Open modal with current data
        async function editClient(clientId) {
            try {
                const doc = await db.collection('clients').doc(clientId).get();
                if (!doc.exists) {
                    showAlert('Client not found', 'error');
                    return;
                }
                
                const data = doc.data();
                currentEditingClient = clientId;
                
                // Populate form with current data
                document.getElementById('editClientId').value = clientId;
                document.getElementById('editClientName').value = data.clientName || '';
                document.getElementById('editClientEmail').value = data.clientEmail || '';
                document.getElementById('editClientStatus').value = data.active ? 'true' : 'false';
                
                // Progress checkboxes
                document.getElementById('editStep1').checked = data.step1Complete || false;
                document.getElementById('editStep2').checked = data.step2Complete || false;
                document.getElementById('editStep3').checked = data.step3Complete || false;
                document.getElementById('editStep4').checked = data.step4Complete || false;
                document.getElementById('editStep5').checked = data.step5Complete || false;
                
                // DocuSign links
                document.getElementById('editDpaLink').value = data.dpaLink || '';
                document.getElementById('editService6Link').value = data.service6Link || '';
                document.getElementById('editService12Link').value = data.service12Link || '';
                
                // Stripe links
                document.getElementById('editStripe6Monthly').value = data.stripe6Monthly || '';
                document.getElementById('editStripe6Upfront').value = data.stripe6Upfront || '';
                document.getElementById('editStripe12Monthly').value = data.stripe12Monthly || '';
                document.getElementById('editStripe12Upfront').value = data.stripe12Upfront || '';

                // Show modal
                document.getElementById('editModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading client data:', error);
                showAlert('Error loading client data', 'error');
            }
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingClient = null;
        }

        // View revision request details
        async function viewRevisionRequest(clientId) {
            try {
                // Get revision requests for this client
                const snapshot = await db.collection('revisionRequests')
                    .where('clientId', '==', clientId)
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    alert('No pending revision requests found.');
                    return;
                }

                const revisionData = snapshot.docs[0].data();
                const revisionId = snapshot.docs[0].id;

                // Build HTML for revision details
                let changesHtml = '';
                if (revisionData.selectedChanges && revisionData.selectedChanges.length > 0) {
                    changesHtml = '<ul style="margin: 0; padding-left: 20px;">';
                    revisionData.selectedChanges.forEach(change => {
                        const label = change.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        changesHtml += `<li style="margin-bottom: 6px;">${label}</li>`;
                    });
                    changesHtml += '</ul>';
                }

                let attachmentsHtml = '';
                if (revisionData.attachments && revisionData.attachments.length > 0) {
                    attachmentsHtml = '<div style="margin-top: 12px;"><strong>Attachments:</strong><br>';
                    revisionData.attachments.forEach(file => {
                        attachmentsHtml += `<a href="${file.url}" target="_blank" style="color: #05908C; display: block; margin-top: 4px;">• ${file.name}</a>`;
                    });
                    attachmentsHtml += '</div>';
                }

                const timelineText = revisionData.timeline === 'rush' ? 'Rush' :
                                   revisionData.timeline === 'no-rush' ? 'No Rush' :
                                   'Standard (2-3 days)';

                const createdDate = revisionData.createdAt ?
                    new Date(revisionData.createdAt.toDate()).toLocaleString() :
                    'Unknown';

                // Show confirmation dialog with revision details
                const message = `
                    <div style="text-align: left; max-width: 600px;">
                        <h3 style="margin-bottom: 16px; color: #012E40;">Revision Request Details</h3>

                        <div style="margin-bottom: 16px;">
                            <strong>Client:</strong> ${revisionData.clientName}<br>
                            <strong>Submitted:</strong> ${createdDate}<br>
                            <strong>Timeline:</strong> ${timelineText}
                        </div>

                        ${changesHtml ? `
                            <div style="margin-bottom: 16px;">
                                <strong>Selected Changes:</strong>
                                ${changesHtml}
                            </div>
                        ` : ''}

                        ${revisionData.notes ? `
                            <div style="margin-bottom: 16px;">
                                <strong>Additional Notes:</strong>
                                <div style="background: #f9fafb; padding: 12px; border-radius: 6px; margin-top: 6px; white-space: pre-wrap;">${revisionData.notes}</div>
                            </div>
                        ` : ''}

                        ${attachmentsHtml}
                    </div>
                `;

                // Use custom modal instead of alert
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(1, 46, 64, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 30px; max-width: min(700px, calc(100vw - 40px)); width: 90%; max-height: 80vh; overflow-y: auto;">
                        ${message}
                        <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end; flex-wrap: wrap;">
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 10px 20px; background: #d1d5db; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; min-height: 44px;">Close</button>
                            <button onclick="resolveRevision('${revisionId}', '${clientId}', this)" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; min-height: 44px;">Mark as Resolved</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

            } catch (error) {
                console.error('Error viewing revision request:', error);
                alert('Error loading revision request details. Please try again.');
            }
        }

        // Resolve revision request
        async function resolveRevision(revisionId, clientId, button) {
            try {
                button.disabled = true;
                button.textContent = 'Resolving...';

                // Update revision request status
                await db.collection('revisionRequests').doc(revisionId).update({
                    status: 'resolved',
                    resolvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update client document to remove pending revision flag
                await db.collection('clients').doc(clientId).update({
                    hasPendingRevision: false
                });

                // Close modal
                button.closest('div[style*="fixed"]').remove();

                showAlert('Revision request marked as resolved');
                loadClients(); // Refresh client list

            } catch (error) {
                console.error('Error resolving revision:', error);
                alert('Error resolving revision request. Please try again.');
                button.disabled = false;
                button.textContent = 'Mark as Resolved';
            }
        }

        // Upload creatives
        window.uploadCreatives = function(clientId, clientName) {
            const modal = document.createElement('div');
            modal.id = 'uploadCreativesModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(1, 46, 64, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: min(600px, calc(100vw - 20px)); width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
                    <div style="background: linear-gradient(135deg, #F2A922 0%, #F59E0B 100%); padding: clamp(16px, 4vw, 24px); border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                        <h3 style="margin: 0; color: #012E40; font-size: clamp(1.1rem, 3vw, 1.4rem); font-weight: 700;">Upload Creatives</h3>
                        <button onclick="closeUploadCreativesModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #012E40; padding: 0; line-height: 1; min-width: 44px; min-height: 44px;">&times;</button>
                    </div>

                    <div style="padding: clamp(20px, 5vw, 30px);">
                        <p style="color: #012E40; margin-bottom: 20px; font-size: 1rem;">
                            Upload ad creatives for <strong>${clientName}</strong>. They'll see these in their portal for approval.
                        </p>

                        <div id="creativesDropZone" style="border: 2px dashed #F2A922; border-radius: 8px; padding: 40px; text-align: center; background: #FBE9D1; cursor: pointer; transition: all 0.2s ease; margin-bottom: 20px;">
                            <input type="file" id="creativesInput" multiple accept="image/*,video/mp4,video/quicktime,video/webm" style="display: none;">
                            <div style="color: #012E40;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">🎨🎬</div>
                                <p style="margin-bottom: 4px; font-weight: 600; font-size: 1.1rem;">Click to upload or drag & drop</p>
                                <small style="color: #6b7280;">Images (JPG, PNG, GIF) & Videos (MP4, MOV, WebM) • Max 100MB per file</small>
                            </div>
                        </div>

                        <div id="creativesPreviewList" style="display: none; margin-bottom: 20px;">
                            <h4 style="color: #012E40; margin-bottom: 10px; font-size: 0.95rem;">Selected Files:</h4>
                            <div id="creativesPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;"></div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 30px;">
                            <button onclick="closeUploadCreativesModal()" style="flex: 1; padding: 12px; background: #d1d5db; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                            <button id="uploadCreativesBtn" onclick="submitCreatives('${clientId}')" disabled style="flex: 1; padding: 12px; background: #F2A922; color: #012E40; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; opacity: 0.5;">Upload Creatives</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Setup file input and drag & drop
            const dropZone = document.getElementById('creativesDropZone');
            const fileInput = document.getElementById('creativesInput');

            dropZone.onclick = () => fileInput.click();

            fileInput.onchange = (e) => handleCreativesFileSelect(e.target.files);

            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#F59E0B';
                dropZone.style.background = '#FDE68A';
            };

            dropZone.ondragleave = () => {
                dropZone.style.borderColor = '#F2A922';
                dropZone.style.background = '#FBE9D1';
            };

            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#F2A922';
                dropZone.style.background = '#FBE9D1';
                handleCreativesFileSelect(e.dataTransfer.files);
            };
        };

        function handleCreativesFileSelect(files) {
            // Accept both images and videos
            window.selectedCreativeFiles = Array.from(files).filter(f =>
                f.type.startsWith('image/') || f.type.startsWith('video/')
            );

            // Filter out files larger than 100MB
            const maxSize = 100 * 1024 * 1024; // 100MB
            const oversizedFiles = window.selectedCreativeFiles.filter(f => f.size > maxSize);
            if (oversizedFiles.length > 0) {
                alert(`Some files are too large (max 100MB):\n${oversizedFiles.map(f => f.name).join('\n')}`);
                window.selectedCreativeFiles = window.selectedCreativeFiles.filter(f => f.size <= maxSize);
            }

            const previewList = document.getElementById('creativesPreviewList');
            const preview = document.getElementById('creativesPreview');
            const uploadBtn = document.getElementById('uploadCreativesBtn');

            if (window.selectedCreativeFiles.length > 0) {
                previewList.style.display = 'block';
                uploadBtn.disabled = false;
                uploadBtn.style.opacity = '1';

                preview.innerHTML = window.selectedCreativeFiles.map((file, index) => {
                    const url = URL.createObjectURL(file);
                    const isVideo = file.type.startsWith('video/');

                    return `
                        <div style="position: relative;">
                            ${isVideo ? `
                                <div style="position: relative; width: 100%; aspect-ratio: 1; background: #000; border-radius: 8px; border: 2px solid #F2A922; overflow: hidden;">
                                    <video src="${url}" style="width: 100%; height: 100%; object-fit: cover;"></video>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">▶️</div>
                                </div>
                            ` : `
                                <img src="${url}" alt="${file.name}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 2px solid #F2A922;">
                            `}
                            <div style="position: absolute; bottom: 4px; left: 4px; right: 4px; background: rgba(1, 46, 64, 0.9); color: white; padding: 4px; border-radius: 4px; font-size: 0.7rem; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${isVideo ? '🎬 ' : ''}${file.name}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        window.submitCreatives = async function(clientId) {
            const uploadBtn = document.getElementById('uploadCreativesBtn');
            const originalText = uploadBtn.textContent;

            if (!window.selectedCreativeFiles || window.selectedCreativeFiles.length === 0) {
                alert('Please select at least one creative image');
                return;
            }

            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';

                const storageRef = firebase.storage().ref();
                const uploadedCreatives = [];

                for (const file of window.selectedCreativeFiles) {
                    const fileName = `${Date.now()}-${file.name}`;
                    const fileRef = storageRef.child(`clients/${clientId}/creatives/${fileName}`);

                    await fileRef.put(file);
                    const fileUrl = await fileRef.getDownloadURL();

                    uploadedCreatives.push({
                        name: file.name,
                        url: fileUrl,
                        type: file.type,
                        size: file.size,
                        uploadedAt: new Date().toISOString()
                    });
                }

                // Get existing creatives
                const clientDoc = await db.collection('clients').doc(clientId).get();
                const existingCreatives = clientDoc.data()?.creatives || [];

                // Update client document
                await db.collection('clients').doc(clientId).update({
                    creatives: [...existingCreatives, ...uploadedCreatives],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showAlert(`Successfully uploaded ${uploadedCreatives.length} creative(s)!`);
                closeUploadCreativesModal();
                loadClients(); // Refresh client list

            } catch (error) {
                console.error('Error uploading creatives:', error);
                alert('Error uploading creatives. Please try again.');
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            }
        };

        window.closeUploadCreativesModal = function() {
            const modal = document.getElementById('uploadCreativesModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
                window.selectedCreativeFiles = null;
            }
        };

        // Open creative preview modal (for videos and images)
        window.openCreativePreview = function(url, name, isVideo, event) {
            // Prevent any default behavior
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            console.log('Opening preview for:', name, 'isVideo:', isVideo, 'URL:', url);

            const modal = document.createElement('div');
            modal.id = 'creativePreviewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            // Escape special characters in strings
            const escapedUrl = url;
            const escapedName = name.replace(/'/g, "\\'");

            modal.innerHTML = `
                <div style="max-width: 90vw; max-height: 90vh; position: relative; display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="color: white; margin: 0; font-size: 1.2rem;">${isVideo ? '🎬' : '🖼️'} ${escapedName}</h3>
                        <button onclick="closeCreativePreview()" style="background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #012E40;">&times;</button>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: center; background: #000; border-radius: 8px; overflow: hidden;">
                        ${isVideo ? `
                            <video src="${escapedUrl}" controls autoplay style="max-width: 100%; max-height: 80vh; width: auto; height: auto;">
                                Your browser does not support the video tag.
                            </video>
                        ` : `
                            <img src="${escapedUrl}" alt="${escapedName}" style="max-width: 100%; max-height: 80vh; width: auto; height: auto; object-fit: contain;">
                        `}
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="event.preventDefault(); event.stopPropagation(); downloadFile('${escapedUrl}', '${escapedName}')" style="padding: 12px 24px; background: #F2A922; color: #012E40; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            📥 Download
                        </button>
                        <a href="${escapedUrl}" target="_blank" rel="noopener noreferrer" style="padding: 12px 24px; background: white; color: #012E40; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                            🔗 Open in New Tab
                        </a>
                    </div>
                </div>
            `;

            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeCreativePreview();
                }
            };

            // Close on Escape key
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeCreativePreview();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        };

        window.closeCreativePreview = function() {
            const modal = document.getElementById('creativePreviewModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        };


        // Reset all steps
        function resetAllSteps() {
            if (confirm('Reset all progress steps for this client? This cannot be undone.')) {
                document.getElementById('editStep1').checked = false;
                document.getElementById('editStep2').checked = false;
                document.getElementById('editStep3').checked = false;
                document.getElementById('editStep4').checked = false;
                document.getElementById('editStep5').checked = false;
            }
        }
        
        // Complete all steps
        function completeAllSteps() {
            if (confirm('Mark all steps as complete for this client?')) {
                document.getElementById('editStep1').checked = true;
                document.getElementById('editStep2').checked = true;
                document.getElementById('editStep3').checked = true;
                document.getElementById('editStep4').checked = true;
                document.getElementById('editStep5').checked = true;
            }
        }
        
        // Save client changes
        document.getElementById('editClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentEditingClient) return;
            
            const updateData = {
                clientName: document.getElementById('editClientName').value,
                clientEmail: document.getElementById('editClientEmail').value || null,
                active: document.getElementById('editClientStatus').value === 'true',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Progress tracking
                step1Complete: document.getElementById('editStep1').checked,
                step2Complete: document.getElementById('editStep2').checked,
                step3Complete: document.getElementById('editStep3').checked,
                step4Complete: document.getElementById('editStep4').checked,
                step5Complete: document.getElementById('editStep5').checked,
                
                // DocuSign links (null if empty)
                dpaLink: document.getElementById('editDpaLink').value || null,
                service6Link: document.getElementById('editService6Link').value || null,
                service12Link: document.getElementById('editService12Link').value || null,
                
                // Stripe links (null if empty)
                stripe6Monthly: document.getElementById('editStripe6Monthly').value || null,
                stripe6Upfront: document.getElementById('editStripe6Upfront').value || null,
                stripe12Monthly: document.getElementById('editStripe12Monthly').value || null,
                stripe12Upfront: document.getElementById('editStripe12Upfront').value || null
            };
            
            try {
                await db.collection('clients').doc(currentEditingClient).update(updateData);
                showAlert('Client updated successfully!');
                closeEditModal();
                loadClients();
            } catch (error) {
                console.error('Error updating client:', error);
                showAlert('Error updating client. Please try again.', 'error');
            }
        });
        
        // Delete client
        async function deleteClient() {
            if (!currentEditingClient) return;
            
            const clientName = document.getElementById('editClientName').value;
            const confirmText = `Are you sure you want to PERMANENTLY DELETE the client portal for "${clientName}"?\n\nThis action cannot be undone and will:\n- Delete all client data\n- Break their portal link\n- Remove all progress tracking\n\nType "DELETE" to confirm:`;
            
            const userInput = prompt(confirmText);
            
            if (userInput === 'DELETE') {
                try {
                    await db.collection('clients').doc(currentEditingClient).delete();
                    showAlert(`Client "${clientName}" deleted successfully`);
                    closeEditModal();
                    loadClients();
                } catch (error) {
                    console.error('Error deleting client:', error);
                    showAlert('Error deleting client. Please try again.', 'error');
                }
            } else if (userInput !== null) {
                showAlert('Deletion cancelled - incorrect confirmation text', 'error');
            }
        }
        
        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('editModal')) {
                closeEditModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('editModal').style.display === 'flex') {
                closeEditModal();
            }
            if (e.key === 'Escape' && document.getElementById('dealModal').style.display === 'flex') {
                closeDealModal();
            }
        });

        // ===== SALES CRM FUNCTIONS =====

        // Pipeline stages configuration
        const PIPELINE_STAGES = [
            { id: 'qualified', name: 'Qualified', color: '#85C7B3' },
            { id: 'cold-outreach', name: 'Cold Outreach', color: '#05908C' },
            { id: 'follow-up', name: 'Follow-Up', color: '#47a5a3' },
            { id: 'discovery-scheduled', name: 'Discovery Scheduled', color: '#6BA8A5' },
            { id: 'discovery-completed', name: 'Discovery Completed', color: '#4A9694' },
            { id: 'onboarding-portal', name: 'Onboarding Portal', color: '#3A8583' },
            { id: 'campaign-live', name: 'Campaign Live', color: '#2A7472' },
            { id: 'follow-up-resell', name: 'Follow-Up & Resell', color: '#1A6361' }
        ];

        // Load clients for deal form dropdown
        async function loadClientsForDealForm() {
            try {
                const snapshot = await db.collection('clients').orderBy('createdAt', 'desc').get();
                const select = document.getElementById('dealClientPortalId');

                // Clear existing options except the first one
                select.innerHTML = '<option value="">No client portal linked</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;

                    // Calculate progress
                    const completedSteps = [
                        data.step1Complete,
                        data.step2Complete,
                        data.step3Complete,
                        data.step4Complete,
                        data.step5Complete
                    ].filter(Boolean).length;
                    const progressPercent = Math.round((completedSteps / 5) * 100);

                    // Create option with detailed info
                    const option = document.createElement('option');
                    option.value = docId;
                    option.textContent = `${data.clientName} • ${data.portalType === 'm2m' ? 'M2M' : 'Contract'} • ${progressPercent}% Complete • ${data.active ? 'Active' : 'Inactive'}`;

                    // Check if already linked to another deal (we'll validate this)
                    if (data.linkedDealId) {
                        option.textContent += ' (Already Linked)';
                        option.disabled = true;
                        option.style.color = '#9ca3af';
                    }

                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading clients for deal form:', error);
            }
        }

        // Create Portal for Deal (Admin function)
        async function createPortalForDealAdmin(dealId) {
            if (!confirm('Create a new client portal for this deal?')) return;

            try {
                // Get deal data
                const dealDoc = await db.collection('deals').doc(dealId).get();
                if (!dealDoc.exists) {
                    alert('Deal not found');
                    return;
                }

                const dealData = dealDoc.data();

                // Create new client portal
                const portalData = {
                    clientName: dealData.companyName,
                    contactName: dealData.contactName || '',
                    clientEmail: dealData.email || '',
                    phone: dealData.phone || '',
                    active: true,
                    portalType: 'contract',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    linkedDealId: dealId,
                    // Onboarding progress
                    step1Complete: false,
                    step2Complete: false,
                    step3Complete: false,
                    step4Complete: false,
                    step5Complete: false,
                    step6Complete: false
                };

                const portalRef = await db.collection('clients').add(portalData);

                // Link portal to deal
                await db.collection('deals').doc(dealId).update({
                    clientPortalId: portalRef.id,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Client portal created successfully!');

                // Reload pipeline to show updated card
                loadCRMPipeline();

            } catch (error) {
                console.error('Error creating portal:', error);
                alert('Error creating portal. Please try again.');
            }
        }

        // Open deal modal
        async function openDealModal(dealId = null, linkedPortalId = null) {
            const modal = document.getElementById('dealModal');
            const form = document.getElementById('dealForm');
            const title = document.getElementById('dealModalTitle');

            // Load reps for dropdown
            await loadRepsForDealForm();

            // Load clients for dropdown
            await loadClientsForDealForm();

            if (dealId) {
                // Edit mode
                title.textContent = 'Edit Deal';
                const doc = await db.collection('deals').doc(dealId).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('dealId').value = dealId;
                    document.getElementById('dealCompanyName').value = data.companyName || '';
                    document.getElementById('dealContactName').value = data.contactName || '';
                    document.getElementById('dealEmail').value = data.email || '';
                    document.getElementById('dealPhone').value = data.phone || '';
                    document.getElementById('dealAssignedTo').value = data.assignedTo || '';
                    document.getElementById('dealStage').value = data.stage || 'qualified';
                    document.getElementById('dealMRR').value = data.mrr || '';
                    document.getElementById('dealContractLength').value = data.contractLength || '';
                    document.getElementById('dealClientPortalId').value = data.clientPortalId || '';
                    document.getElementById('dealNotes').value = data.notes || '';

                    // Show website quote section if linked
                    if (data.websiteQuoteId) {
                        document.getElementById('websiteQuoteSection').style.display = 'block';
                        document.getElementById('dealWebsiteQuoteId').value = data.websiteQuoteId;
                    } else {
                        document.getElementById('websiteQuoteSection').style.display = 'none';
                    }
                }
            } else {
                // Create mode
                title.textContent = linkedPortalId ? 'Create Deal for Portal' : 'Add New Deal';
                form.reset();
                document.getElementById('dealId').value = '';
                document.getElementById('websiteQuoteSection').style.display = 'none';

                // If creating deal for existing portal, pre-fill the portal ID
                if (linkedPortalId) {
                    document.getElementById('dealClientPortalId').value = linkedPortalId;

                    // Try to load portal data to pre-fill company/contact info
                    try {
                        const portalDoc = await db.collection('clients').doc(linkedPortalId).get();
                        if (portalDoc.exists) {
                            const portalData = portalDoc.data();
                            document.getElementById('dealCompanyName').value = portalData.clientName || '';
                            document.getElementById('dealContactName').value = portalData.contactName || '';
                            document.getElementById('dealEmail').value = portalData.clientEmail || '';
                            document.getElementById('dealPhone').value = portalData.phone || '';
                        }
                    } catch (error) {
                        console.error('Error loading portal data:', error);
                    }
                }
            }

            modal.style.display = 'flex';
        }

        // Close deal modal
        function closeDealModal() {
            document.getElementById('dealModal').style.display = 'none';
            document.getElementById('dealForm').reset();
        }

        // View linked website quote
        window.viewLinkedWebsiteQuote = function() {
            const quoteId = document.getElementById('dealWebsiteQuoteId').value;
            if (quoteId) {
                // Switch to website forms tab and highlight the form
                switchAdminTab('website-forms');
                closeDealModal();

                // Scroll to the quote card after a brief delay
                setTimeout(() => {
                    const quoteCard = document.querySelector(`[data-quote-id="${quoteId}"]`);
                    if (quoteCard) {
                        quoteCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        quoteCard.style.boxShadow = '0 0 20px rgba(245, 158, 11, 0.5)';
                        setTimeout(() => {
                            quoteCard.style.boxShadow = '';
                        }, 2000);
                    }
                }, 300);
            }
        };

        // Load reps and admins for deal form dropdown
        async function loadRepsForDealForm() {
            const select = document.getElementById('dealAssignedTo');
            const currentValue = select.value; // Preserve selection

            // Clear existing options except first
            select.innerHTML = '<option value="">Select Person...</option>';

            const snapshot = await db.collection('salesReps')
                .where('active', '==', true)
                .orderBy('name')
                .get();

            // Separate admins and reps
            const admins = [];
            const reps = [];

            snapshot.forEach(doc => {
                const data = doc.data();
                if (data?.role === 'admin') {
                    admins.push({ id: doc.id, name: data?.name || 'Unknown Admin' });
                } else {
                    reps.push({ id: doc.id, name: data?.name || 'Unknown Rep' });
                }
            });

            // Add admins group
            if (admins.length > 0) {
                const adminGroup = document.createElement('optgroup');
                adminGroup.label = 'Admins';
                admins.forEach(admin => {
                    const option = document.createElement('option');
                    option.value = admin.id;
                    option.textContent = `${admin.name} (Admin)`;
                    adminGroup.appendChild(option);
                });
                select.appendChild(adminGroup);
            }

            // Add sales reps group
            if (reps.length > 0) {
                const repsGroup = document.createElement('optgroup');
                repsGroup.label = 'Sales Reps';
                reps.forEach(rep => {
                    const option = document.createElement('option');
                    option.value = rep.id;
                    option.textContent = `${rep.name} (Sales Rep)`;
                    repsGroup.appendChild(option);
                });
                select.appendChild(repsGroup);
            }

            // Restore selection
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Store reps data globally for pipeline
        let repsMap = {};
        let isPipelineLoading = false; // Track loading state to prevent duplicate loads

        // Load and render CRM pipeline
        async function loadCRMPipeline(retryCount = 0) {
            const MAX_RETRIES = 3;
            const board = document.getElementById('crmPipelineBoard');

            // Safety check: ensure board element exists
            if (!board) {
                console.warn('⚠️ Pipeline board element not found, deferring load...');
                // Wait a bit and try again (in case DOM is still loading)
                setTimeout(() => {
                    const retryBoard = document.getElementById('crmPipelineBoard');
                    if (retryBoard) {
                        loadCRMPipeline(retryCount);
                    } else {
                        console.error('❌ Pipeline board element not found after retry');
                    }
                }, 500);
                return;
            }

            // Prevent duplicate simultaneous loads
            if (isPipelineLoading) {
                console.log('⏳ Pipeline already loading, skipping duplicate request');
                return;
            }

            isPipelineLoading = true;

            try {
                // Show loading indicator
                board.innerHTML = '<div style="text-align: center; padding: 40px; color: #012E40;"><div style="font-size: 2rem; margin-bottom: 12px;">⏳</div><div>Loading sales pipeline...</div></div>';

                // Verify admin is authenticated
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    throw new Error('User not authenticated');
                }
                console.log('Loading CRM pipeline for user:', currentUser.uid, currentUser.email);

                // Load all sales reps first to map names
                console.log('📊 Loading sales reps...');
                const repsSnapshot = await db.collection('salesReps').get();
                repsMap = {};
                repsSnapshot.forEach(doc => {
                    repsMap[doc.id] = doc.data()?.name || 'Unknown Rep';
                });
                console.log(`✅ Loaded ${repsSnapshot.size} sales reps`);

                // Fetch all deals with timeout protection
                console.log('📊 Loading deals...');
                const snapshot = await Promise.race([
                    db.collection('deals').get(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout loading deals')), 15000))
                ]);

                const deals = [];
                const archivedDeals = { completed: [], 'closed-lost': [] };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const deal = { id: doc.id, ...data };

                    if (data.stage === 'completed' || data.stage === 'closed-lost') {
                        archivedDeals[data.stage].push(deal);
                    } else {
                        deals.push(deal);
                    }
                });
                console.log(`✅ Loaded ${deals.length} active deals, ${archivedDeals.completed.length + archivedDeals['closed-lost'].length} archived`);

                // Fetch all active clients without linked deals and create virtual deals
                const clientsSnapshot = await db.collection('clients').get();
                clientsSnapshot.forEach(clientDoc => {
                    const clientData = clientDoc.data();
                    const clientId = clientDoc.id;

                    // Only create virtual deal if:
                    // 1. Client is active
                    // 2. Client has no linked deal
                    // 3. Client has started onboarding (at least one step complete OR has progress)
                    if (clientData.active && !clientData.linkedDealId) {
                        const hasProgress = clientData.step1Complete ||
                                          clientData.step2Complete ||
                                          clientData.step3Complete ||
                                          clientData.step4Complete ||
                                          clientData.step5Complete ||
                                          clientData.step6Complete;

                        if (hasProgress) {
                            // Create a virtual deal for this client
                            deals.push({
                                id: `virtual-${clientId}`,
                                companyName: clientData.clientName,
                                contactName: clientData.clientEmail,
                                email: clientData.clientEmail,
                                phone: null,
                                assignedTo: 'unassigned',
                                stage: 'onboarding-portal',
                                mrr: 0,
                                contractLength: 0,
                                clientPortalId: clientId,
                                notes: null,
                                isVirtualDeal: true, // Flag to identify this as a virtual deal
                                createdAt: clientData.createdAt,
                                updatedAt: clientData.lastUpdated || clientData.createdAt
                            });
                        }
                    }
                });

                // Render pipeline board
                await renderPipelineBoard(deals);

                // Update metrics
                updateMetrics(deals);

                // Mark loading as complete
                isPipelineLoading = false;
                console.log('✅ Pipeline loaded successfully');

            } catch (error) {
                // Reset loading flag on error
                isPipelineLoading = false;
                console.error('❌ Error loading CRM pipeline:', error);
                console.error('Error code:', error.code);
                console.error('Error details:', error);

                // Implement retry logic for transient errors
                if (retryCount < MAX_RETRIES && (
                    error.code === 'unavailable' ||
                    error.code === 'deadline-exceeded' ||
                    error.message?.includes('Timeout') ||
                    error.message?.includes('network')
                )) {
                    console.log(`🔄 Retrying... (attempt ${retryCount + 1}/${MAX_RETRIES})`);

                    // Show retry message
                    if (board) {
                        board.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #012E40;">
                                <div style="font-size: 2rem; margin-bottom: 12px;">🔄</div>
                                <div>Connection issue. Retrying... (${retryCount + 1}/${MAX_RETRIES})</div>
                            </div>
                        `;
                    }

                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, retryCount)));

                    // Reset loading flag before retry
                    isPipelineLoading = false;
                    return loadCRMPipeline(retryCount + 1);
                }

                // Show error message to user
                if (board) {
                    board.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc2626;">
                            <div style="font-size: 2rem; margin-bottom: 12px;">⚠️</div>
                            <div style="font-weight: 600; margin-bottom: 8px;">Failed to load sales pipeline</div>
                            <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">${error.message}</div>
                            <button onclick="loadCRMPipeline()" style="padding: 10px 20px; background: #05908C; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                🔄 Try Again
                            </button>
                        </div>
                    `;
                }

                // Check if user document exists for debugging
                try {
                    const currentUser = firebase.auth().currentUser;
                    if (currentUser) {
                        const userDoc = await db.collection('salesReps').doc(currentUser.uid).get();
                        console.log('User document exists:', userDoc.exists);
                        if (userDoc.exists) {
                            console.log('User data:', userDoc.data());
                        } else {
                            showAlert('Admin user document not found in salesReps collection. Please contact support.', 'error');
                            return;
                        }
                    }
                } catch (checkError) {
                    console.error('Error checking user document:', checkError);
                }

                showAlert('Error loading pipeline: ' + error.message, 'error');
            }
        }

        // Drag and drop handlers for admin pipeline
        let draggedDealId = null;
        let draggedDealStage = null;

        function handleDealDragStart(event) {
            const dealId = event.target.getAttribute('data-deal-id');

            // Prevent dragging virtual deals
            if (dealId && dealId.startsWith('virtual-')) {
                event.preventDefault();
                return false;
            }

            draggedDealId = dealId;
            draggedDealStage = event.target.getAttribute('data-deal-stage');
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDealDragEnd(event) {
            event.target.style.opacity = '1';
        }

        function handleDealDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.style.backgroundColor = '#e8f5e9';
        }

        function handleDealDragLeave(event) {
            event.currentTarget.style.backgroundColor = '';
        }

        async function handleDealDrop(event) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = '';

            const newStage = event.currentTarget.getAttribute('data-stage');

            if (!draggedDealId || !newStage || draggedDealStage === newStage) {
                return;
            }

            // Get stage names for confirmation
            const oldStageName = PIPELINE_STAGES.find(s => s.id === draggedDealStage)?.name;
            const newStageName = PIPELINE_STAGES.find(s => s.id === newStage)?.name;

            // Confirm the move
            if (!confirm(`Move this deal from "${oldStageName}" to "${newStageName}"?`)) {
                return;
            }

            try {
                // Update the deal in Firestore
                await db.collection('deals').doc(draggedDealId).update({
                    stage: newStage,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Reload the pipeline
                await loadCRMPipeline();

                showAlert(`Deal moved to ${newStageName}!`, 'success');
            } catch (error) {
                console.error('Error moving deal:', error);
                showAlert('Error moving deal: ' + error.message, 'error');
            }
        }

        // Render pipeline board
        async function renderPipelineBoard(deals) {
            // Render to Sales Pipeline tab only
            const board = document.getElementById('crmPipelineBoard');
            if (!board) return;

            board.innerHTML = '';

            PIPELINE_STAGES.forEach(stage => {
                const stageDeals = deals.filter(d => d.stage === stage.id);

                const column = document.createElement('div');
                column.style.cssText = `
                    background: linear-gradient(135deg, #FFECB3 0%, #FFF8E6 100%);
                    border-radius: 10px;
                    padding: 15px;
                    min-height: 400px;
                `;

                column.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: ${stage.color}; margin: 0; font-size: 1rem;">${stage.name}</h3>
                        <span style="background: ${stage.color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${stageDeals.length}</span>
                    </div>
                    <div class="pipeline-deals"
                         data-stage="${stage.id}"
                         ondragover="handleDealDragOver(event)"
                         ondrop="handleDealDrop(event)"
                         ondragleave="handleDealDragLeave(event)"
                         style="min-height: 350px; transition: background-color 0.2s;">
                        ${stageDeals.map(deal => renderDealCard(deal, stageDeals.length)).join('')}
                    </div>
                `;

                board.appendChild(column);
            });

            // Load client data for all linked deals
            await loadClientDataForDeals(deals);
        }

        // Load client data for deals with linked portals - OPTIMIZED FOR PARALLEL LOADING
        async function loadClientDataForDeals(deals) {
            const dealsWithClients = deals.filter(d => d.clientPortalId);

            if (dealsWithClients.length === 0) {
                console.log('📊 No deals with linked clients to load');
                return;
            }

            console.log(`📊 Loading client data for ${dealsWithClients.length} deals...`);

            // Load all clients in parallel instead of sequentially
            const clientPromises = dealsWithClients.map(async (deal) => {
                try {
                    const clientDoc = await db.collection('clients').doc(deal.clientPortalId).get();

                    if (clientDoc.exists) {
                        const clientData = clientDoc.data();

                        // Calculate progress
                        const completedSteps = [
                            clientData.step1Complete,
                            clientData.step2Complete,
                            clientData.step3Complete,
                            clientData.step4Complete,
                            clientData.step5Complete,
                            clientData.step6Complete
                        ].filter(Boolean).length;
                        const progressPercent = Math.round((completedSteps / 6) * 100);

                        // Update new unified card format
                        const clientInfo = document.querySelector(`#client-info-${deal.id} .client-portal-data`);
                        if (clientInfo) {
                            clientInfo.innerHTML = `
                                <div style="margin-bottom: 4px;">
                                    <div style="background: #d1d5db; height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="background: #05908C; height: 100%; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center; font-weight: 600; font-size: 0.75rem;">
                                    ${progressPercent}% Complete (${completedSteps}/6)
                                </div>
                            `;
                        }
                    } else {
                        // Client not found
                        const clientInfo = document.querySelector(`#client-info-${deal.id} .client-portal-data`);
                        if (clientInfo) {
                            clientInfo.innerHTML = '<div style="color: #991b1b; font-size: 0.75rem;">⚠️ Portal not found</div>';
                        }
                    }
                } catch (error) {
                    console.error(`❌ Error loading client data for deal ${deal.id}:`, error);

                    // Show error in UI
                    const clientInfo = document.querySelector(`#client-info-${deal.id} .client-portal-data`);
                    if (clientInfo) {
                        clientInfo.innerHTML = '<div style="color: #991b1b; font-size: 0.75rem;">⚠️ Error loading</div>';
                    }
                }
            });

            // Wait for all client data to load in parallel
            try {
                await Promise.all(clientPromises);
                console.log(`✅ Successfully loaded client data for ${dealsWithClients.length} deals`);
            } catch (error) {
                console.error('❌ Error loading some client data:', error);
                // Individual errors are already handled above, this is just for logging
            }
        }

        // Cross-tab navigation: View linked client from deal
        window.viewLinkedClient = function(clientId) {
            // Switch to Clients tab
            switchAdminTab('clients');

            // Scroll to and highlight the client card
            setTimeout(() => {
                const clientCard = document.querySelector(`[data-client-id="${clientId}"]`);
                if (clientCard) {
                    clientCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Add highlight animation
                    clientCard.style.transition = 'all 0.3s ease';
                    clientCard.style.boxShadow = '0 0 30px rgba(242, 169, 34, 0.8), 0 6px 30px rgba(1, 46, 64, 0.3)';
                    clientCard.style.transform = 'scale(1.02)';

                    // Remove highlight after 2 seconds
                    setTimeout(() => {
                        clientCard.style.boxShadow = '0 6px 30px rgba(1, 46, 64, 0.3)';
                        clientCard.style.transform = 'scale(1)';
                    }, 2000);
                }
            }, 300);
        };

        // Render deal card with compressed/full view
        function renderDealCard(deal, stageCount) {
            // UNIFIED STAGE-BASED RENDERING
            // Pre-onboarding stages: qualified → discovery-completed
            // Onboarding+ stages: onboarding-portal → follow-up-resell

            const preOnboardingStages = ['qualified', 'cold-outreach', 'follow-up', 'discovery-scheduled', 'discovery-completed'];
            const isPreOnboarding = preOnboardingStages.includes(deal.stage);

            // Common calculations
            const daysInStage = deal.lastUpdated
                ? Math.floor((new Date() - (deal.lastUpdated.toDate ? deal.lastUpdated.toDate() : new Date(deal.lastUpdated))) / (1000 * 60 * 60 * 24))
                : 0;
            const mrr = deal.mrr ? `$${deal.mrr.toLocaleString()}/mo` : '';
            const hasPortal = !!deal.clientPortalId;
            const isDeal = !deal.isVirtualDeal;

            // Status color based on days
            let statusBg, statusColor;
            if (daysInStage <= 3) {
                statusBg = '#d1fae5'; statusColor = '#065f46';
            } else if (daysInStage <= 7) {
                statusBg = '#fef3c7'; statusColor = '#92400e';
            } else {
                statusBg = '#fee2e2'; statusColor = '#991b1b';
            }

            if (isPreOnboarding) {
                return renderPreOnboardingCard(deal, daysInStage, statusBg, statusColor, mrr, hasPortal, isDeal);
            } else {
                return renderOnboardingCard(deal, daysInStage, statusBg, statusColor, mrr, hasPortal, isDeal);
            }
        }

        // Pre-Onboarding Card (Qualified → Discovery Completed)
        function renderPreOnboardingCard(deal, daysInStage, statusBg, statusColor, mrr, hasPortal, isDeal) {
            return `
                <div class="deal-card"
                     id="deal-${deal.id}"
                     draggable="${isDeal ? 'true' : 'false'}"
                     data-deal-id="${deal.id}"
                     data-deal-stage="${deal.stage}"
                     ${isDeal ? 'ondragstart="handleDealDragStart(event)" ondragend="handleDealDragEnd(event)"' : ''}
                     style="background: linear-gradient(135deg, #FFF8E6 0%, #FFFFFF 100%);
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 8px;
                            border-left: 4px solid #F2A922;
                            cursor: pointer;
                            transition: all 0.15s ease;
                            border: 2px solid rgba(242, 169, 34, 0.3);
                            box-shadow: 0 2px 6px rgba(242, 169, 34, 0.15);
                            position: relative;
                            overflow: hidden;">

                    <!-- Header with Company Name and Days Badge -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 8px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: #012E40; font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${deal.companyName || 'Unnamed'}
                            </div>
                        </div>
                        <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; flex-shrink: 0;">
                            ${daysInStage}d
                        </span>
                    </div>

                    <!-- Contact Info -->
                    <div style="margin-bottom: 10px;">
                        <div style="font-size: 0.8rem; color: #64748B; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            👤 ${deal.contactName || 'No contact'}
                        </div>
                        ${mrr ? `
                            <div style="font-size: 0.85rem; color: #05908C; font-weight: 600; margin-top: 4px;">
                                💰 ${mrr}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #EEF4D9;">
                        ${isDeal ? `
                            <button onclick="openDealModal('${deal.id}'); event.stopPropagation();"
                                    style="flex: 1; padding: 6px 10px; background: #E8F5F3; border: 1px solid #05908C; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #05908C; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ✏️ Edit
                            </button>
                        ` : `
                            <button onclick="editClient('${deal.clientPortalId}'); event.stopPropagation();"
                                    style="flex: 1; padding: 6px 10px; background: #E8F5F3; border: 1px solid #05908C; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #05908C; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ✏️ Edit Portal
                            </button>
                        `}

                        ${hasPortal ? `
                            <button onclick="viewLinkedClient('${deal.clientPortalId}'); event.stopPropagation();"
                                    style="flex: 1; padding: 6px 10px; background: #05908C; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                🔗 Portal
                            </button>
                        ` : `
                            <button onclick="createPortalForDealAdmin('${deal.id}'); event.stopPropagation();"
                                    style="flex: 1; padding: 6px 10px; background: #05908C; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                + Portal
                            </button>
                        `}

                        ${!isDeal ? `
                            <button onclick="openDealModal(null, '${deal.clientPortalId}'); event.stopPropagation();"
                                    style="flex: 1; padding: 6px 10px; background: #FBE9D1; border: 1px solid #F2A922; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #92400e; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                + Deal
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Onboarding+ Card (Onboarding Portal → Resell)
        function renderOnboardingCard(deal, daysInStage, statusBg, statusColor, mrr, hasPortal, isDeal) {
            return `
                <div class="deal-card"
                     id="deal-${deal.id}"
                     draggable="${isDeal ? 'true' : 'false'}"
                     data-deal-id="${deal.id}"
                     data-deal-stage="${deal.stage}"
                     ${isDeal ? 'ondragstart="handleDealDragStart(event)" ondragend="handleDealDragEnd(event)"' : ''}
                     style="background: linear-gradient(135deg, #E8F5F3 0%, #FFFFFF 100%);
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 8px;
                            border-left: 4px solid #85C7B3;
                            cursor: pointer;
                            transition: all 0.15s ease;
                            border: 2px solid rgba(133, 199, 179, 0.3);
                            box-shadow: 0 2px 6px rgba(5, 144, 140, 0.15);
                            position: relative;
                            overflow: hidden;">

                    <!-- Header with Company Name and Days Badge -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 8px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: #012E40; font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${deal.companyName || 'Unnamed'}
                            </div>
                        </div>
                        <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; flex-shrink: 0;">
                            ${daysInStage}d
                        </span>
                    </div>

                    <!-- Portal Status or Create Button -->
                    ${hasPortal ? `
                        <div style="margin-bottom: 10px;">
                            <button onclick="viewLinkedClient('${deal.clientPortalId}'); event.stopPropagation();"
                                    style="width: 100%; padding: 8px 12px; background: linear-gradient(135deg, #85C7B3 0%, #05908C 100%); color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; box-sizing: border-box;">
                                🔗 Open Client Portal
                            </button>
                        </div>
                    ` : `
                        <div style="margin-bottom: 10px;">
                            <div style="background: #FEF3C7; color: #F59E0B; padding: 6px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-bottom: 6px; text-align: center; border: 1px solid #F59E0B;">
                                ⚠️ Portal Not Created
                            </div>
                            <button onclick="createPortalForDealAdmin('${deal.id}'); event.stopPropagation();"
                                    style="width: 100%; padding: 8px 12px; background: #05908C; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; box-sizing: border-box;">
                                + Create Client Portal
                            </button>
                        </div>
                    `}

                    <!-- MRR and Contact -->
                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #D1F2EB;">
                        ${mrr ? `
                            <div style="font-size: 0.85rem; color: #05908C; font-weight: 600; margin-bottom: 4px;">
                                💰 ${mrr}
                            </div>
                        ` : ''}
                        <div style="font-size: 0.75rem; color: #64748B; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            👤 ${deal.contactName || 'No contact'}
                        </div>
                    </div>

                    <!-- Progress Info (if portal exists) -->
                    ${hasPortal ? `
                        <div id="client-info-${deal.id}" style="margin-bottom: 10px;">
                            <div class="client-portal-data" style="font-size: 0.75rem; color: #05908C; font-weight: 500;">
                                Loading progress...
                            </div>
                        </div>
                    ` : ''}

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 6px;">
                        ${isDeal ? `
                            <button onclick="openDealModal('${deal.id}'); event.stopPropagation();"
                                    style="flex: 1; padding: 6px 10px; background: #E8F5F3; border: 1px solid #05908C; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #05908C; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ✏️ Edit
                            </button>
                        ` : `
                            <button onclick="editClient('${deal.clientPortalId}'); event.stopPropagation();"
                                    style="flex: 1; padding: 6px 10px; background: #E8F5F3; border: 1px solid #05908C; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #05908C; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ✏️ Edit
                            </button>
                        `}

                        ${!isDeal ? `
                            <button onclick="openDealModal(null, '${deal.clientPortalId}'); event.stopPropagation();"
                                    style="flex: 1; padding: 6px 10px; background: #FBE9D1; border: 1px solid #F2A922; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #92400e; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                + Deal
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // DEPRECATED: Old rendering code below (kept temporarily for reference)
        function renderDealCard_OLD(deal, stageCount) {
            // SPECIAL HANDLING FOR VIRTUAL DEALS (clients without linked deals)
            if (deal.isVirtualDeal) {
                return `
                    <div class="deal-card virtual-deal-card"
                         id="deal-${deal.id}"
                         draggable="false"
                         style="background: linear-gradient(135deg, #E8F5F3 0%, #d1fae5 100%);
                                border-radius: 8px;
                                padding: 12px;
                                margin-bottom: 8px;
                                border-left: 4px solid #05908C;
                                border: 2px solid #05908C;
                                cursor: pointer;
                                transition: all 0.15s ease;
                                box-shadow: 0 2px 6px rgba(5, 144, 140, 0.3);
                                position: relative;">

                        <!-- Edit Button in top-right corner -->
                        <div style="position: absolute; top: 8px; right: 8px;">
                            <button onclick="editClient('${deal.clientPortalId}'); event.stopPropagation();"
                                    style="padding: 4px 10px; background: white; border: 2px solid #05908C;
                                           border-radius: 4px; font-size: 0.7rem; cursor: pointer;
                                           color: #05908C; font-weight: 600; transition: all 0.2s ease;"
                                    onmouseover="this.style.background='#E8F5F3'"
                                    onmouseout="this.style.background='white'">
                                ✏️ Edit
                            </button>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; padding-right: 70px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #012E40; font-size: 0.9rem; margin-bottom: 4px;">
                                    ${deal.companyName || 'Unnamed Client'}
                                </div>
                                <div style="font-size: 0.75rem; color: #64748B;">
                                    ${deal.contactName || 'No contact'}
                                </div>
                            </div>
                            <span style="background: #05908C; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: 600;">
                                PORTAL ONLY
                            </span>
                        </div>

                        <div id="client-info-virtual-${deal.id}" style="background: white; border-radius: 6px; padding: 8px; margin-bottom: 8px;">
                            <div style="font-size: 0.7rem; color: #05908C; font-weight: 600; margin-bottom: 4px;">📊 Client Portal Progress</div>
                            <div class="client-portal-data" style="font-size: 0.7rem; color: #012E40;">Loading...</div>
                        </div>

                        <div style="display: flex; gap: 6px;">
                            <button onclick="viewLinkedClient('${deal.clientPortalId}'); event.stopPropagation();"
                                    style="flex: 1; padding: 8px 12px; background: #05908C; color: white; border: none;
                                           border-radius: 6px; font-size: 0.75rem; cursor: pointer; font-weight: 600;
                                           transition: all 0.2s ease;"
                                    onmouseover="this.style.background='#047a77'"
                                    onmouseout="this.style.background='#05908C'">
                                👁️ View Portal
                            </button>
                            <button onclick="openDealModal(null, '${deal.clientPortalId}'); event.stopPropagation();"
                                    style="flex: 1; padding: 8px 12px; background: #FBE9D1; color: #92400e; border: 2px solid #F2A922;
                                           border-radius: 6px; font-size: 0.75rem; cursor: pointer; font-weight: 600;
                                           transition: all 0.2s ease;"
                                    onmouseover="this.style.background='#fde68a'"
                                    onmouseout="this.style.background='#FBE9D1'">
                                ➕ Create Deal
                            </button>
                        </div>
                    </div>
                `;
            }

            // REGULAR DEAL RENDERING
            const repName = repsMap[deal.assignedTo] || 'Unassigned';
            const isCompressed = stageCount > 1;

            // Calculate deal value (MRR × Contract Length or just MRR)
            const dealValue = deal.mrr && deal.contractLength
                ? deal.mrr * deal.contractLength
                : (deal.mrr || 0);
            const formattedValue = dealValue > 0
                ? `$${dealValue.toLocaleString()}`
                : '$0';

            // Calculate days in stage
            const lastUpdated = deal.lastUpdated?.toDate() || deal.createdAt?.toDate() || new Date();
            const daysInStage = Math.floor((new Date() - lastUpdated) / (1000 * 60 * 60 * 24));

            // Determine status color based on days in stage
            let statusBg, statusColor;
            if (daysInStage <= 3) {
                statusBg = '#d1fae5'; statusColor = '#065f46'; // Green
            } else if (daysInStage <= 7) {
                statusBg = '#fef3c7'; statusColor = '#92400e'; // Yellow
            } else {
                statusBg = '#fee2e2'; statusColor = '#991b1b'; // Red
            }

            if (isCompressed) {
                // COMPRESSED VIEW - Click to expand
                return `
                    <div class="deal-card"
                         id="deal-${deal.id}"
                         draggable="true"
                         data-deal-id="${deal.id}"
                         data-deal-stage="${deal.stage}"
                         ondragstart="handleDealDragStart(event)"
                         ondragend="handleDealDragEnd(event)"
                         onclick="toggleExpandCard('${deal.id}', event)"
                         style="background: linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%);
                                border-radius: 8px;
                                padding: 10px 12px;
                                margin-bottom: 8px;
                                border-left: 4px solid #F2A922;
                                cursor: pointer;
                                transition: all 0.15s ease;
                                border: 2px solid rgba(0, 0, 0, 0.75);
                                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);">

                        <div class="card-summary">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #012E40; font-size: 0.9rem;">
                                        ${deal.companyName || 'Unnamed Deal'}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #64748B; margin-top: 2px;">
                                        ${deal.contactName || 'No contact'}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="background: ${statusBg}; color: ${statusColor};
                                                padding: 3px 8px; border-radius: 12px;
                                                font-size: 0.7rem; font-weight: 600;">
                                        ${daysInStage}d
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden details shown on expand -->
                        <div class="card-details" style="display: none; margin-top: 12px;
                                                         padding-top: 12px; border-top: 2px solid #85C7B3;">
                            <!-- Edit & Delete Controls -->
                            <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                                <button onclick="openDealModal('${deal.id}'); event.stopPropagation();"
                                        style="padding: 6px 12px; background: #E8F5F3; border: 2px solid rgba(0, 0, 0, 0.75);
                                               border-radius: 4px; font-size: 0.75rem; cursor: pointer;
                                               color: #000000; font-weight: 600;">
                                    Edit
                                </button>
                                <button onclick="confirmDeleteDeal('${deal.id}'); event.stopPropagation();"
                                        style="padding: 6px 12px; background: #fef2f2; border: 2px solid rgba(0, 0, 0, 0.75);
                                               border-radius: 4px; font-size: 0.75rem; cursor: pointer;
                                               color: #000000; font-weight: 600;">
                                    Delete
                                </button>
                            </div>

                            <!-- Deal Value -->
                            <div style="background: linear-gradient(135deg, #F2A922 0%, #FCD34D 100%);
                                        color: #000000; padding: 8px 12px; border-radius: 6px;
                                        margin-bottom: 10px; text-align: center; font-weight: 700;
                                        font-size: 1rem; border: 1px solid #F59E0B;">
                                ${formattedValue}
                            </div>

                            <!-- Rep & Additional Info -->
                            <div style="font-size: 0.85rem; color: #000000; margin-bottom: 6px;">
                                👤 <strong>${repName}</strong>
                            </div>
                            ${deal.clientPortalId ? `
                                <div id="client-info-compressed-${deal.id}" style="background: #E8F5F3; border-radius: 6px; padding: 8px; margin-bottom: 8px; border: 1px solid #05908C;">
                                    <div style="font-size: 0.75rem; color: #05908C; font-weight: 600; margin-bottom: 4px;">🔗 Client Portal Linked</div>
                                    <div class="client-portal-data" style="font-size: 0.7rem; color: #012E40; margin-bottom: 6px;">Loading...</div>
                                    <div style="display: flex; gap: 4px;">
                                        <button onclick="viewLinkedClient('${deal.clientPortalId}'); event.stopPropagation();"
                                                style="flex: 1; padding: 4px 10px; background: #05908C; color: white; border: none;
                                                       border-radius: 4px; font-size: 0.7rem; cursor: pointer;
                                                       font-weight: 600; transition: all 0.2s ease;"
                                                onmouseover="this.style.background='#047a77'"
                                                onmouseout="this.style.background='#05908C'">
                                            👁️ View
                                        </button>
                                        <button onclick="editClient('${deal.clientPortalId}'); event.stopPropagation();"
                                                style="flex: 1; padding: 4px 10px; background: white; border: 1px solid #05908C;
                                                       border-radius: 4px; font-size: 0.7rem; cursor: pointer;
                                                       color: #05908C; font-weight: 600; transition: all 0.2s ease;"
                                                onmouseover="this.style.background='#E8F5F3'"
                                                onmouseout="this.style.background='white'">
                                            ✏️ Edit
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${deal.websiteQuoteId ? '<div style="font-size: 0.75rem; color: #F59E0B; font-weight: 600; margin-bottom: 4px;">📝 From Website Form</div>' : ''}
                        </div>
                    </div>
                `;
            } else {
                // FULL VIEW - Always expanded when only 1 deal in stage
                return `
                    <div class="deal-card"
                         id="deal-${deal.id}"
                         draggable="true"
                         data-deal-id="${deal.id}"
                         data-deal-stage="${deal.stage}"
                         ondragstart="handleDealDragStart(event)"
                         ondragend="handleDealDragEnd(event)"
                         style="background: linear-gradient(135deg, #FFFFFF 0%, #EEF4D9 100%);
                                border-radius: 10px;
                                padding: 14px;
                                margin-bottom: 12px;
                                border-left: 4px solid #F2A922;
                                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
                                border: 2px solid rgba(0, 0, 0, 0.75);
                                position: relative;
                                cursor: move;">

                        <!-- Edit & Delete Controls in top-right corner -->
                        <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 6px;">
                            <button onclick="openDealModal('${deal.id}'); event.stopPropagation();"
                                    style="padding: 6px 12px; background: #E8F5F3; border: 2px solid rgba(0, 0, 0, 0.75);
                                           border-radius: 4px; font-size: 0.75rem; cursor: pointer;
                                           color: #000000; font-weight: 600;">
                                Edit
                            </button>
                            <button onclick="confirmDeleteDeal('${deal.id}'); event.stopPropagation();"
                                    style="padding: 6px 12px; background: #fef2f2; border: 2px solid rgba(0, 0, 0, 0.75);
                                           border-radius: 4px; font-size: 0.75rem; cursor: pointer;
                                           color: #000000; font-weight: 600;">
                                Delete
                            </button>
                        </div>

                        <!-- Company Name with padding for buttons -->
                        <div style="display: flex; justify-content: space-between; align-items: start;
                                    margin-bottom: 8px; padding-right: 140px;">
                            <div style="font-weight: 700; color: #012E40; font-size: 1.1rem;">
                                ${deal.companyName}
                            </div>
                        </div>

                        <!-- Contact Name -->
                        <div style="font-size: 0.85rem; color: #64748B; margin-bottom: 8px;">
                            ${deal.contactName || 'No contact'}
                        </div>

                        <!-- Deal Value -->
                        <div style="background: linear-gradient(135deg, #F2A922 0%, #FCD34D 100%);
                                    color: #000000; padding: 10px 14px; border-radius: 6px;
                                    margin-bottom: 10px; text-align: center; font-weight: 700;
                                    font-size: 1.2rem; border: 1px solid #F59E0B;">
                            ${formattedValue}
                        </div>

                        <!-- Status & Timeline Info -->
                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                            <span style="background: ${statusBg}; color: ${statusColor};
                                        padding: 4px 10px; border-radius: 12px;
                                        font-size: 0.75rem; font-weight: 600;">
                                ${daysInStage} days in stage
                            </span>
                        </div>

                        <!-- Rep & Additional Info -->
                        <div style="font-size: 0.9rem; color: #000000; margin-bottom: 6px;">
                            👤 <strong>${repName}</strong>
                        </div>
                        ${deal.clientPortalId ? `
                            <div id="client-info-full-${deal.id}" style="background: #E8F5F3; border-radius: 8px; padding: 12px; margin-bottom: 10px; border: 2px solid #05908C;">
                                <div style="font-size: 0.8rem; color: #05908C; font-weight: 600; margin-bottom: 6px;">🔗 Client Portal Linked</div>
                                <div class="client-portal-data" style="font-size: 0.75rem; color: #012E40; margin-bottom: 8px;">Loading client data...</div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="viewLinkedClient('${deal.clientPortalId}'); event.stopPropagation();"
                                            style="flex: 1; padding: 8px 16px; background: #05908C; color: white; border: none;
                                                   border-radius: 6px; font-size: 0.8rem; cursor: pointer;
                                                   font-weight: 600; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#047a77'"
                                            onmouseout="this.style.background='#05908C'">
                                        👁️ View Portal
                                    </button>
                                    <button onclick="editClient('${deal.clientPortalId}'); event.stopPropagation();"
                                            style="flex: 1; padding: 8px 16px; background: white; border: 2px solid #05908C;
                                                   border-radius: 6px; font-size: 0.8rem; cursor: pointer;
                                                   color: #05908C; font-weight: 600; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#E8F5F3'"
                                            onmouseout="this.style.background='white'">
                                        ✏️ Edit Portal
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        ${deal.websiteQuoteId ? '<div style="font-size: 0.8rem; color: #F59E0B; font-weight: 600;">📝 From Website Form</div>' : ''}
                    </div>
                `;
            }
        }

        // Toggle expand/collapse for compressed deal cards
        function toggleExpandCard(dealId, event) {
            // Prevent toggle if user clicks buttons or select dropdowns
            if (event.target.tagName === 'BUTTON' || event.target.tagName === 'SELECT') {
                return;
            }

            const card = document.getElementById('deal-' + dealId);
            if (!card) return;

            const detailsDiv = card.querySelector('.card-details');
            if (detailsDiv) {
                const isExpanded = detailsDiv.style.display !== 'none';
                // Toggle visibility
                detailsDiv.style.display = isExpanded ? 'none' : 'block';
                // Change background gradient on toggle
                card.style.background = isExpanded
                    ? 'linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%)'
                    : 'linear-gradient(135deg, #FFFFFF 0%, #EEF4D9 100%)';
            }
        }

        // Confirm and delete deal (archives it)
        async function confirmDeleteDeal(dealId) {
            // Get deal data first to check for client link
            const dealDoc = await db.collection('deals').doc(dealId).get();
            const dealData = dealDoc.data();

            let confirmMessage = 'Are you sure you want to delete this deal? This will archive it.';

            if (dealData.clientPortalId) {
                confirmMessage = `This deal is linked to a client portal.\n\nWhat would you like to do?\n\nOK = Archive deal and unlink from client\nCancel = Keep everything`;
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Remove link from client if exists
                if (dealData.clientPortalId) {
                    try {
                        await db.collection('clients').doc(dealData.clientPortalId).update({
                            linkedDealId: null,
                            dealStage: null
                        });
                        console.log('✓ Removed client link from deal');
                    } catch (err) {
                        console.error('Error removing client link:', err);
                    }
                }

                // Archive the deal instead of deleting
                await db.collection('deals').doc(dealId).update({
                    archived: true,
                    archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    stage: 'closed-lost',
                    stageWhenLost: dealData.stage,
                    clientPortalId: null, // Remove the link
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success message
                showToast('Deal archived successfully', 'success');

                // Reload pipeline
                await loadCRMPipeline();

            } catch (error) {
                console.error('Error archiving deal:', error);
                showToast('Error archiving deal: ' + error.message, 'error');
            }
        }

        // Update metrics dashboard
        function updateMetrics(deals) {
            const totalValue = deals.reduce((sum, deal) => {
                return sum + (deal.mrr && deal.contractLength ? deal.mrr * deal.contractLength : 0);
            }, 0);

            const monthlyMRR = deals
                .filter(d => d.stage === 'campaign-live' || d.stage === 'follow-up-resell')
                .reduce((sum, deal) => sum + (deal.mrr || 0), 0);

            const avgDeal = deals.length > 0 ? totalValue / deals.length : 0;

            document.getElementById('totalPipelineValue').textContent = `$${totalValue.toLocaleString()}`;
            document.getElementById('activeDealsCount').textContent = deals.length;
            document.getElementById('monthlyMRR').textContent = `$${monthlyMRR.toLocaleString()}`;
            document.getElementById('avgDealSize').textContent = `$${Math.round(avgDeal).toLocaleString()}`;
        }

        // Load CRM, Website Forms, and CMS Clients when switching tabs
        const originalSwitchAdminTab = switchAdminTab;
        switchAdminTab = function(tabName) {
            originalSwitchAdminTab(tabName);
            if (tabName === 'sales-crm') {
                loadCRMPipeline();
            } else if (tabName === 'website-forms') {
                loadWebsiteQuotes();
            } else if (tabName === 'cms-clients') {
                loadCMSClients();
            }
        };

        // Load clients on page load (removed - now called after auth check)
        document.addEventListener('DOMContentLoaded', () => {
            // loadClients(); // Moved to onAuthStateChanged callback

            // Attach deal form event listener after DOM is loaded
            const dealForm = document.getElementById('dealForm');
            if (dealForm) {
                dealForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    let dealId = document.getElementById('dealId').value;  // Changed from const to let
                    const websiteQuoteId = document.getElementById('dealWebsiteQuoteId').value || null;

                    const dealData = {
                        companyName: document.getElementById('dealCompanyName').value,
                        contactName: document.getElementById('dealContactName').value || null,
                        email: document.getElementById('dealEmail').value || null,
                        phone: document.getElementById('dealPhone').value || null,
                        assignedTo: document.getElementById('dealAssignedTo').value,
                        stage: document.getElementById('dealStage').value,
                        mrr: parseFloat(document.getElementById('dealMRR').value) || 0,
                        contractLength: parseInt(document.getElementById('dealContractLength').value) || 0,
                        clientPortalId: document.getElementById('dealClientPortalId').value || null,
                        websiteQuoteId: websiteQuoteId, // Preserve website quote link
                        notes: document.getElementById('dealNotes').value || null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    try {
                        let isNewDeal = !dealId;
                        let oldDealData = null;
                        let wasAssignmentChange = false;
                        let wasStageChange = false;
                        let oldClientPortalId = null;

                        if (dealId) {
                            // Get old data to detect changes
                            const oldDoc = await db.collection('deals').doc(dealId).get();
                            oldDealData = oldDoc.data();
                            wasAssignmentChange = oldDealData.assignedTo !== dealData.assignedTo;
                            wasStageChange = oldDealData.stage !== dealData.stage;
                            oldClientPortalId = oldDealData.clientPortalId;

                            // Update existing deal
                            await db.collection('deals').doc(dealId).update(dealData);
                            showAlert('Deal updated successfully!');
                        } else {
                            // Create new deal
                            dealData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            const newDealRef = await db.collection('deals').add(dealData);
                            dealId = newDealRef.id;
                            showAlert('Deal created successfully!');
                        }

                        // Handle bidirectional linking with client portal
                        const newClientPortalId = dealData.clientPortalId;

                        // If client link changed, update both old and new clients
                        if (oldClientPortalId !== newClientPortalId) {
                            // Remove link from old client (if exists)
                            if (oldClientPortalId) {
                                try {
                                    await db.collection('clients').doc(oldClientPortalId).update({
                                        linkedDealId: null,
                                        dealStage: null
                                    });
                                    console.log('✓ Removed deal link from old client');
                                } catch (err) {
                                    console.error('Error removing old client link:', err);
                                }
                            }

                            // Add link to new client (if selected)
                            if (newClientPortalId) {
                                try {
                                    await db.collection('clients').doc(newClientPortalId).update({
                                        linkedDealId: dealId,
                                        dealStage: dealData.stage
                                    });
                                    console.log('✓ Added deal link to new client');
                                } catch (err) {
                                    console.error('Error adding new client link:', err);
                                }
                            }
                        } else if (newClientPortalId && wasStageChange) {
                            // If client link didn't change but stage did, update client's stage
                            try {
                                await db.collection('clients').doc(newClientPortalId).update({
                                    dealStage: dealData.stage
                                });
                                console.log('✓ Updated client deal stage');
                            } catch (err) {
                                console.error('Error updating client deal stage:', err);
                            }
                        }

                        // Create notifications based on what changed
                        if (window.createNotification) {
                            // Notification 1: Deal assigned to a rep (not "unassigned")
                            if ((isNewDeal || wasAssignmentChange) && dealData.assignedTo && dealData.assignedTo !== 'unassigned') {
                                await window.createNotification({
                                    type: 'DEAL_ASSIGNED',
                                    recipientId: dealData.assignedTo,
                                    recipientType: 'sales-rep',
                                    message: `New deal assigned: ${dealData.companyName}`,
                                    actionUrl: `sales-dashboard.html`,
                                    relatedId: dealId,
                                    metadata: {
                                        companyName: dealData.companyName,
                                        stage: dealData.stage
                                    }
                                });
                                console.log('✓ Sales rep notification created for deal assignment');
                            }

                            // Notification 2: Deal stage changed (only for existing deals with assigned rep)
                            if (!isNewDeal && wasStageChange && dealData.assignedTo && dealData.assignedTo !== 'unassigned') {
                                await window.createNotification({
                                    type: 'DEAL_STAGE_CHANGE',
                                    recipientId: dealData.assignedTo,
                                    recipientType: 'sales-rep',
                                    message: `${dealData.companyName} moved to ${dealData.stage}`,
                                    actionUrl: `sales-dashboard.html`,
                                    relatedId: dealId,
                                    metadata: {
                                        companyName: dealData.companyName,
                                        oldStage: oldDealData.stage,
                                        newStage: dealData.stage
                                    }
                                });
                                console.log('✓ Sales rep notification created for stage change');
                            }
                        }

                        closeDealModal();
                        loadCRMPipeline();
                    } catch (error) {
                        console.error('Error saving deal:', error);
                        showAlert('Error saving deal: ' + error.message, 'error');
                    }
                });
            }
        });

        // Load archived deals for admin (all deals)
        async function loadAdminArchivedDeals() {
            console.log('Loading archived deals for admin...');

            try {
                // Load all archived deals
                const archivedSnapshot = await db.collection('deals')
                    .where('archived', '==', true)
                    .orderBy('archivedAt', 'desc')
                    .get();

                // Also load all reps to map rep IDs to names
                const repsSnapshot = await db.collection('salesReps').get();
                const repsMap = {};
                repsSnapshot.forEach(doc => {
                    repsMap[doc.id] = doc.data().name;
                });

                const stageNames = {
                    'qualified': 'Qualified',
                    'cold-outreach': 'Cold Outreach',
                    'follow-up': 'Follow-Up',
                    'discovery-scheduled': 'Discovery Scheduled',
                    'discovery-completed': 'Discovery Completed',
                    'proposal-sent': 'Proposal Sent',
                    'negotiation': 'Negotiation',
                    'onboarding': 'Onboarding',
                    'campaign-live': 'Campaign Live'
                };

                if (archivedSnapshot.empty) {
                    document.getElementById('adminArchivedDealsBody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px; color: #64748B;">No archived deals</td></tr>';
                    return;
                }

                let html = '';
                archivedSnapshot.forEach(doc => {
                    const data = doc.data();
                    const archivedDate = data.archivedAt ? data.archivedAt.toDate().toLocaleDateString() : 'N/A';
                    const stageWhenLost = stageNames[data.stageWhenLost] || data.stageWhenLost || 'Unknown';
                    const repName = repsMap[data.assignedTo] || 'Unknown Rep';

                    html += `
                        <tr style="border-bottom: 1px solid #E2E8F0;">
                            <td style="padding: 12px; color: #0F172A;">${data.companyName || 'Unnamed'}</td>
                            <td style="padding: 12px; color: #64748B;">${data.contactName || 'N/A'}</td>
                            <td style="padding: 12px; color: #64748B;">${repName}</td>
                            <td style="padding: 12px; color: #0F172A;">${stageWhenLost}</td>
                            <td style="padding: 12px; color: #64748B;">${archivedDate}</td>
                        </tr>
                    `;
                });

                document.getElementById('adminArchivedDealsBody').innerHTML = html;
            } catch (error) {
                console.error('Error loading archived deals:', error);
                document.getElementById('adminArchivedDealsBody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px; color: #d32f2f;">Error loading archived deals: ' + error.message + '</td></tr>';
            }
        }

        // ===== MESSAGING SYSTEM (REMOVED) =====
        // Messaging functionality has been removed from the admin dashboard

        // Format time ago
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';

            return date.toLocaleDateString();
        }

        // Open chat with specific client
        function openChat(clientId, clientName) {
            currentChatClientId = clientId;

            // Update UI
            document.getElementById('chatEmptyState').style.display = 'none';
            document.getElementById('chatThreadContainer').style.display = 'flex';
            document.getElementById('chatClientName').textContent = clientName;

            // Clear previous messages
            document.getElementById('chatMessages').innerHTML = '';

            // Stop listening to previous chat
            if (messagesListener) {
                messagesListener();
            }

            // Listen to messages in this thread
            messagesListener = firebase.firestore()
                .collection('messages')
                .doc(clientId)
                .collection('thread')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';

                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const isAdmin = msg.sender === 'admin';

                        const messageDiv = document.createElement('div');
                        messageDiv.style.cssText = `
                            display: flex;
                            justify-content: ${isAdmin ? 'flex-end' : 'flex-start'};
                        `;

                        messageDiv.innerHTML = `
                            <div style="
                                max-width: 70%;
                                padding: 12px 16px;
                                border-radius: 12px;
                                background: ${isAdmin ? 'rgba(5, 144, 140, 0.7)' : 'white'};
                                color: #000000;
                                border: 1px solid ${isAdmin ? 'rgba(5, 144, 140, 0.9)' : '#e5e7eb'};
                            ">
                                <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; color: ${isAdmin ? '#012E40' : '#64748B'};">
                                    ${msg.senderName || (isAdmin ? 'Admin' : 'Client')}
                                </div>
                                <div style="font-size: 0.9rem; margin-bottom: 4px; word-wrap: break-word;">
                                    ${msg.text}
                                </div>
                                <div style="font-size: 0.7rem; color: #64748B; text-align: right;">
                                    ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString() : ''}
                                </div>
                            </div>
                        `;

                        messagesContainer.appendChild(messageDiv);
                    });

                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    // Mark messages as read by admin
                    markMessagesAsRead(clientId);
                });
        }



        // Send message from admin
        const messageFormElement = document.getElementById('replyMessageForm');
        if (messageFormElement) {
            messageFormElement.addEventListener('submit', async (e) => {
                e.preventDefault();

                const input = document.getElementById('replyMessageText');
                const messageText = input.value.trim();

            if (!messageText || !currentChatClientId) return;

            try {
                const currentUser = firebase.auth().currentUser;
                const adminName = currentUser.displayName || currentUser.email || 'Admin';

                // Add message to thread
                await firebase.firestore()
                    .collection('messages')
                    .doc(currentChatClientId)
                    .collection('thread')
                    .add({
                        text: messageText,
                        sender: 'admin',
                        senderName: adminName,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false
                    });

                // Update conversation metadata
                await firebase.firestore()
                    .collection('messages')
                    .doc(currentChatClientId)
                    .set({
                        lastMessage: messageText,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        unreadByClient: firebase.firestore.FieldValue.increment(1),
                        unreadByAdmin: 0,
                        clientName: document.getElementById('chatClientName').textContent
                    }, { merge: true });

                // Create notification for client about admin reply
                if (window.createNotification) {
                    await window.createNotification({
                        type: 'MESSAGE_REPLY',
                        recipientId: currentChatClientId,
                        recipientType: 'client',
                        message: `Admin replied to your message`,
                        actionUrl: `client.html?id=${currentChatClientId}#messages`,
                        relatedId: currentChatClientId,
                        metadata: {
                            messagePreview: messageText.substring(0, 50) + (messageText.length > 50 ? '...' : '')
                        }
                    });
                    console.log('✓ Client notification created for admin message reply');
                }

                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Error sending message: ' + error.message, 'error');
            }
            });
        }

        // ===================================
        // WEBSITE FORMS FUNCTIONS
        // ===================================

        let allWebsiteQuotes = [];
        let currentQuoteFilter = 'all';

        // Load website forms
        async function loadWebsiteQuotes() {
            try {
                const snapshot = await db.collection('websiteQuotes').orderBy('createdAt', 'desc').get();

                allWebsiteQuotes = [];
                snapshot.forEach(doc => {
                    allWebsiteQuotes.push({ id: doc.id, ...doc.data() });
                });

                updateQuoteStats();
                displayWebsiteQuotes();
            } catch (error) {
                console.error('Error loading website forms:', error);
                document.getElementById('websiteQuotesList').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #dc2626;">
                        <p>Error loading forms. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        // Update stats
        function updateQuoteStats() {
            const stats = {
                incomplete: 0,
                completed: 0,
                quoteSent: 0,
                won: 0
            };

            allWebsiteQuotes.forEach(quote => {
                if (quote.status === 'incomplete') stats.incomplete++;
                else if (quote.status === 'completed') stats.completed++;
                else if (quote.status === 'quote-sent') stats.quoteSent++;
                else if (quote.status === 'won') stats.won++;
            });

            document.getElementById('quotesIncomplete').textContent = stats.incomplete;
            document.getElementById('quotesCompleted').textContent = stats.completed;
            document.getElementById('quotesQuoteSent').textContent = stats.quoteSent;
            document.getElementById('quotesWon').textContent = stats.won;
        }

        // Filter quotes
        window.filterQuotes = function(filter) {
            currentQuoteFilter = filter;

            // Update active filter button
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`filter-${filter}`).classList.add('active');

            displayWebsiteQuotes();
        };

        // Display website quotes
        function displayWebsiteQuotes() {
            const container = document.getElementById('websiteQuotesList');

            // Filter quotes
            let filteredQuotes = allWebsiteQuotes;
            if (currentQuoteFilter !== 'all') {
                filteredQuotes = allWebsiteQuotes.filter(quote => quote.status === currentQuoteFilter);
            }

            if (filteredQuotes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                        <div style="width: 64px; height: 64px; margin: 0 auto 20px; border: 3px solid #e5e7eb; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                        </div>
                        <p style="font-size: 1.1rem; font-weight: 500;">No ${currentQuoteFilter === 'all' ? '' : currentQuoteFilter} forms found</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredQuotes.forEach(quote => {
                const statusColors = {
                    'incomplete': '#6b7280',
                    'completed': '#F2A922',
                    'quote-sent': '#3b82f6',
                    'won': '#22c55e',
                    'lost': '#ef4444'
                };

                const statusColor = statusColors[quote.status] || '#6b7280';
                const createdDate = quote.createdAt ? new Date(quote.createdAt.toDate()).toLocaleDateString() : 'N/A';
                const completionPercent = quote.completionPercent || 0;

                html += `
                    <div data-quote-id="${quote.id}" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.95) 100%); border: 1px solid rgba(5, 144, 140, 0.15); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06); backdrop-filter: blur(10px); transition: all 0.3s ease;">
                        <!-- Header Section -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(5, 144, 140, 0.1);">
                            <div style="display: flex; gap: 20px; flex: 1;">
                                ${quote.logoUrl ? `
                                    <div style="flex-shrink: 0;">
                                        <img src="${quote.logoUrl}" alt="${quote.businessName} logo" style="width: 80px; height: 80px; object-fit: contain; border-radius: 8px; border: 1px solid rgba(5, 144, 140, 0.1); background: white; padding: 8px;" />
                                    </div>
                                ` : ''}
                                <div style="flex: 1;">
                                    <h3 style="font-size: 1.4rem; font-weight: 700; color: #012E40; margin-bottom: 12px; letter-spacing: -0.02em;">
                                        ${quote.businessName || 'Unnamed Business'}
                                    </h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; color: #6b7280; font-size: 0.9rem;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                            </svg>
                                            <span>${createdDate}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                                <polyline points="22,6 12,13 2,6"></polyline>
                                            </svg>
                                            <span>${quote.email || 'No email'}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                            </svg>
                                            <span>${quote.phone || 'No phone'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-left: 20px;">
                                <span style="display: inline-flex; align-items: center; padding: 8px 16px; border-radius: 24px; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.05em; background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}dd 100%); color: white; box-shadow: 0 2px 8px ${statusColor}40; text-transform: uppercase;">
                                    ${(quote.status || 'incomplete').replace('-', ' ')}
                                </span>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div style="background: linear-gradient(135deg, rgba(5, 144, 140, 0.03) 0%, rgba(242, 169, 34, 0.03) 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(5, 144, 140, 0.08);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                                <div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Business Type</div>
                                    <div style="font-weight: 600; color: #012E40; font-size: 0.95rem;">${quote.businessType || 'Not specified'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Budget Range</div>
                                    <div style="font-weight: 600; color: #012E40; font-size: 0.95rem;">${quote.budgetRange || 'Not specified'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Deadline</div>
                                    <div style="font-weight: 600; color: #012E40; font-size: 0.95rem;">${quote.deadlineDate || 'Flexible'}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Progress</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                                            <div style="height: 100%; width: ${completionPercent}%; background: linear-gradient(90deg, #05908C 0%, #F2A922 100%); border-radius: 10px; transition: width 0.3s ease;"></div>
                                        </div>
                                        <span style="font-weight: 700; color: #05908C; font-size: 0.9rem; min-width: 40px;">${completionPercent}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="window.open('view-quote.html?id=${quote.id}', '_blank')" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(5, 144, 140, 0.85) 0%, rgba(4, 122, 114, 0.85) 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(5, 144, 140, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(5, 144, 140, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(5, 144, 140, 0.2)'">
                                📋 Full View
                            </button>
                            ${quote.logoUrl ? `
                            <button onclick="window.open('${quote.logoUrl}', '_blank')" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.85) 0%, rgba(124, 58, 237, 0.85) 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(139, 92, 246, 0.2)'">
                                🖼️ Logo
                            </button>
                            ` : ''}
                            <button onclick="viewQuoteDetails('${quote.id}')" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.85) 0%, rgba(79, 70, 229, 0.85) 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(99, 102, 241, 0.2)'">
                                Quick View
                            </button>
                            <button onclick="generateAIPrompt('${quote.id}')" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(242, 169, 34, 0.85) 0%, rgba(217, 148, 25, 0.85) 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(242, 169, 34, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(242, 169, 34, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(242, 169, 34, 0.2)'">
                                Generate AI Prompt
                            </button>
                            <button onclick="copyQuoteLink('${quote.id}')" style="padding: 12px 24px; background: white; color: #05908C; border: 2px solid #05908C; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(5, 144, 140, 0.05)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.transform='translateY(0)'">
                                Copy Link
                            </button>
                            <button onclick="deleteQuote('${quote.id}', '${quote.businessName || 'this quote'}')" style="padding: 12px 24px; background: white; color: #dc2626; border: 2px solid #dc2626; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease;" onmouseover="this.style.background='#fef2f2'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='white'; this.style.transform='translateY(0)'">
                                🗑️ Delete
                            </button>
                            <select onchange="updateQuoteStatus('${quote.id}', this.value)" style="padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-weight: 600; cursor: pointer; background: white; color: #374151; font-size: 0.9rem; transition: all 0.2s ease;" onmouseover="this.style.borderColor='#05908C'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <option value="">Change Status...</option>
                                <option value="incomplete" ${quote.status === 'incomplete' ? 'selected' : ''}>Incomplete</option>
                                <option value="completed" ${quote.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="quote-sent" ${quote.status === 'quote-sent' ? 'selected' : ''}>Quote Sent</option>
                                <option value="won" ${quote.status === 'won' ? 'selected' : ''}>Won</option>
                                <option value="lost" ${quote.status === 'lost' ? 'selected' : ''}>Lost</option>
                            </select>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // View form details
        window.viewQuoteDetails = function(quoteId) {
            const quote = allWebsiteQuotes.find(q => q.id === quoteId);
            if (!quote) return;

            const details = `
                <div style="max-height: 70vh; overflow-y: auto; color: #000000;">
                    <h3 style="font-size: 1.5rem; margin-bottom: 20px; color: #012E40;">Form Details</h3>

                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #05908C; margin-bottom: 15px;">Business Information</h4>
                        <p style="color: #000000;"><strong>Business Name:</strong> ${quote.businessName || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Owner:</strong> ${quote.ownerName || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Email:</strong> ${quote.email || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Phone:</strong> ${quote.phone || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Type:</strong> ${quote.businessType || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Years in Business:</strong> ${quote.yearsInBusiness || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Locations:</strong> ${quote.locations || 'N/A'}</p>
                        <p style="margin-top: 10px; color: #000000;"><strong>Description:</strong><br>${quote.businessDescription || 'N/A'}</p>
                        <p style="margin-top: 10px; color: #000000;"><strong>What Makes Them Special:</strong><br>${quote.whatMakesSpecial || 'N/A'}</p>
                    </div>

                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #05908C; margin-bottom: 15px;">Project Details</h4>
                        <p style="color: #000000;"><strong>Budget:</strong> ${quote.budgetRange || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Deadline:</strong> ${quote.deadlineDate || 'Flexible'}</p>
                        <p style="color: #000000;"><strong>Decision Maker:</strong> ${quote.decisionMaker || 'N/A'}</p>
                        <p style="margin-top: 10px; color: #000000;"><strong>Why Now:</strong><br>${quote.whyNow || 'N/A'}</p>
                    </div>

                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #05908C; margin-bottom: 15px;">Design Preferences</h4>
                        <p style="color: #000000; margin-bottom: 12px;"><strong>Logo File:</strong> ${quote.logoUrl ? `<a href="${quote.logoUrl}" target="_blank" download style="color: #05908C; text-decoration: underline; font-weight: 600;">📥 Download ${quote.logoFileName || 'logo'}</a>` : 'Not uploaded'}</p>
                        ${quote.logoUrl ? `<div style="margin-bottom: 16px;"><img src="${quote.logoUrl}" alt="Business Logo" style="max-width: 300px; max-height: 200px; border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; background: white; cursor: pointer;" onclick="window.open('${quote.logoUrl}', '_blank')" title="Click to view full size"/></div>` : ''}
                        <p style="color: #000000;"><strong>Main Color:</strong> ${quote.brandColors?.main || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Secondary Color:</strong> ${quote.brandColors?.secondary || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Accent Color:</strong> ${quote.brandColors?.accent || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Overall Style:</strong> ${quote.overallStyle?.join(', ') || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Font Style:</strong> ${quote.fontStyle?.join(', ') || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Image Style:</strong> ${quote.imageStyle?.join(', ') || 'N/A'}</p>
                    </div>

                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #05908C; margin-bottom: 15px;">Favorite Website</h4>
                        <p style="color: #000000;"><strong>URL:</strong> <a href="${quote.favoriteWebsite?.url}" target="_blank" style="color: #05908C;">${quote.favoriteWebsite?.url || 'N/A'}</a></p>
                        <p style="color: #000000;"><strong>Likes About Look:</strong> ${quote.favoriteWebsite?.likesAboutLook || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Likes About Function:</strong> ${quote.favoriteWebsite?.likesAboutFunction || 'N/A'}</p>
                    </div>

                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #05908C; margin-bottom: 15px;">Customer Profile</h4>
                        <p style="color: #000000;"><strong>Age Range:</strong> ${quote.customerProfile?.ageRange || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Gender:</strong> ${quote.customerProfile?.gender || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Income Level:</strong> ${quote.customerProfile?.incomeLevel || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Location:</strong> ${quote.customerProfile?.location || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Tech Comfort:</strong> ${quote.customerProfile?.techComfort || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Care About:</strong> ${quote.customerCareAbout?.join(', ') || 'N/A'}</p>
                        <p style="color: #000000;"><strong>Find Via:</strong> ${quote.howCustomersFind?.join(', ') || 'N/A'}</p>
                    </div>
                </div>
            `;

            showAlert(details, 'info');
        };

        // Generate AI Prompt from form data
        window.generateAIPrompt = function(quoteId) {
            const quote = allWebsiteQuotes.find(q => q.id === quoteId);
            if (!quote) return;

            // Helper function to determine tech stack based on features
            const determineTechStack = () => {
                const features = quote.specialFeatures || [];
                const needsEcommerce = quote.needsEcommerce === 'yes';
                const hasComplexFeatures = features.includes('search') || features.includes('language') || features.includes('user-accounts');
                const productCount = parseInt(quote.productCount) || 0;

                if (needsEcommerce && productCount > 50) {
                    return 'Next.js + Shopify Storefront API (large product catalog with custom frontend)';
                } else if (needsEcommerce) {
                    return 'Next.js + Stripe integration (custom e-commerce solution)';
                } else if (hasComplexFeatures) {
                    return 'Next.js with React (requires interactive features and client-side state management)';
                } else {
                    return 'HTML5/CSS3/Vanilla JavaScript (static site with optimal performance)';
                }
            };

            // Helper function to get industry-specific requirements
            const getIndustryRequirements = () => {
                const industry = (quote.businessType || '').toLowerCase();

                const industrySpecs = {
                    'restaurant': `
INDUSTRY-SPECIFIC REQUIREMENTS (Restaurant):
- Prominent menu display (easy to read, organized by category)
- Location and hours highly visible (above the fold)
- Mobile-first design (80%+ of customers browse menus on phones)
- Fast loading images (hungry customers are impatient)
- Click-to-call phone number (sticky on mobile)
- Map integration for directions
- High-quality food photography
${quote.specialFeatures?.includes('ecommerce') ? '- Online ordering system with cart and checkout' : ''}
${quote.specialFeatures?.includes('booking') ? '- Reservation system integration' : ''}`,

                    'law firm': `
INDUSTRY-SPECIFIC REQUIREMENTS (Law Firm):
- Professional, trustworthy design (conservative color palette)
- Attorney profiles with credentials and specializations
- Case intake form (multi-step with validation)
- Practice areas clearly organized
- Testimonials/case results (build credibility)
- Blog for SEO and thought leadership
- ADA accessibility compliance (legal requirement)
- Secure contact forms (attorney-client privilege)
- Mobile responsive (but desktop-optimized for reading)`,

                    'ecommerce': `
INDUSTRY-SPECIFIC REQUIREMENTS (E-commerce):
- Product catalog with filtering and search
- Shopping cart with persistence (localStorage)
- Checkout flow (guest and account options)
- Payment gateway integration (Stripe recommended)
- Product image galleries with zoom
- Customer reviews and ratings
- Inventory management system
- Order tracking
- Customer account dashboard
- Mobile-optimized checkout (reduce cart abandonment)
- Fast loading (every 100ms delay = 1% lost sales)`,

                    'real estate': `
INDUSTRY-SPECIFIC REQUIREMENTS (Real Estate):
- Property listing system with search/filter
- Map integration (property locations)
- Photo galleries for each property
- Property detail pages (specs, features, pricing)
- Lead capture forms (schedule showing)
- Mortgage calculator
- Neighborhood information
- Agent profiles
- Testimonials from buyers/sellers
- IDX integration (if applicable)`,

                    'medical': `
INDUSTRY-SPECIFIC REQUIREMENTS (Medical/Healthcare):
- HIPAA compliance considerations
- Patient portal or contact forms (secure)
- Insurance information clearly displayed
- Services/conditions treated
- Provider credentials and photos
- Appointment booking system
- Patient resources/education
- Accessibility (ADA/WCAG 2.1 AA minimum)
- Trust signals (certifications, affiliations)`,

                    'default': `
INDUSTRY-SPECIFIC REQUIREMENTS:
- Clear value proposition above the fold
- Intuitive navigation
- Mobile-responsive design
- Fast loading times
- Clear calls-to-action
- Contact information easily accessible`
                };

                for (const [key, value] of Object.entries(industrySpecs)) {
                    if (industry.includes(key)) return value;
                }
                return industrySpecs.default;
            };

            // Helper function to format array items
            const formatArray = (arr, fallback = 'Not specified') => {
                return arr && arr.length > 0 ? arr.join(', ') : fallback;
            };

            // Build the comprehensive prompt
            const techStack = determineTechStack();
            const industryReqs = getIndustryRequirements();

            const prompt = `You are building a professional website using Claude Code in VS Code.

PROJECT OVERVIEW:
Client: ${quote.businessName || '[Business Name]'}
Industry: ${quote.businessType || '[Business Type]'}
Location: ${quote.locations || '[Location]'}
Years in Business: ${quote.yearsInBusiness || 'Not specified'}

DEVELOPMENT ENVIRONMENT & DEPLOYMENT:
- Code Editor: VS Code with Claude Code extension
- Version Control: GitHub repository
- Deployment Platform: Vercel (automatic deployments on git push)
- Backend Services: Google Cloud Console (Firebase, Cloud Functions if needed)
- Tech Stack: ${techStack}

WORKFLOW:
1. Build locally in VS Code using Claude Code
2. Commit and push to GitHub repository
3. Vercel automatically deploys from GitHub
4. Domain connects through Vercel
5. Any backend needs use Firebase (Auth, Firestore, Storage, Functions)

═══════════════════════════════════════════════════════════

SECTION 1: BUSINESS UNDERSTANDING

About the Business:
${quote.businessDescription || 'No description provided'}

Competitor Websites:
${quote.competitor1Url ? '1. ' + quote.competitor1Url : ''}
${quote.competitor2Url ? '2. ' + quote.competitor2Url : ''}
${!quote.competitor1Url && !quote.competitor2Url ? 'Not specified' : ''}

${quote.competitor1Url || quote.competitor2Url ? 'ACTION: Visit competitor sites to understand market positioning, common features, and design patterns in this industry.' : ''}

═══════════════════════════════════════════════════════════

SECTION 2: CURRENT WEBSITE ANALYSIS
${quote.hasCurrentWebsite === 'yes' ? `
Current Website: ${quote.currentWebsiteUrl || 'URL not provided'}
Age: ${quote.websiteAge || 'Not specified'}
Built By: ${quote.builtBy || 'Not specified'}
What Works Well: ${quote.whatWorksWell || 'Not specified'}
Current Problems: ${formatArray(quote.currentProblems)}
Monthly Visitors: ${quote.monthlyVisitors || 'Not specified'}
Traffic Sources: ${quote.trafficSources || 'Not specified'}

ACTION: Analyze the current site's structure and improve upon it.
` : 'No current website - building from scratch.'}

═══════════════════════════════════════════════════════════

SECTION 3: DESIGN INSPIRATION

Reference Website: ${quote.favoriteWebsite?.url || 'No reference provided'}
${quote.favoriteWebsite?.url ? `ACTION: Visit this URL and analyze the design patterns, layout, and user experience.` : ''}

What They Love About The Look:
${quote.favoriteWebsite?.likesAboutLook || 'Not specified'}

What They Love About Functionality:
${formatArray(quote.favoriteWebsite?.likesAboutFunction)}

Color Preferences:
${quote.favoriteWebsite?.likesAboutColors || 'See brand colors below'}

Layout Preferences:
${quote.favoriteWebsite?.likesAboutLayout || 'Not specified'}

Specific Features They Like:
${formatArray(quote.favoriteWebsite?.specificFeatures)}

═══════════════════════════════════════════════════════════

SECTION 4: DESIGN SYSTEM

Create a comprehensive design system using CSS custom properties:

:root {
  /* Brand Colors */
  --color-primary: ${quote.brandColors?.main || '#05908C'};
  --color-secondary: ${quote.brandColors?.secondary || '#012E40'};
  --color-accent: ${quote.brandColors?.accent || '#F2A922'};
  --color-background: ${quote.brandColors?.background || '#FFFFFF'};

  /* Semantic Colors (derive from brand) */
  --color-text-primary: #1f2937;
  --color-text-secondary: #6b7280;
  --color-border: #e5e7eb;
  --color-success: #22c55e;
  --color-error: #ef4444;
  --color-warning: #f59e0b;

  /* Typography Scale */
  --font-heading: 'Your Choice', serif;
  --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --text-xs: 0.75rem;
  --text-sm: 0.875rem;
  --text-base: 1rem;
  --text-lg: 1.125rem;
  --text-xl: 1.25rem;
  --text-2xl: 1.5rem;
  --text-3xl: 1.875rem;
  --text-4xl: 2.25rem;

  /* Spacing Scale (8px base) */
  --space-1: 0.5rem;
  --space-2: 1rem;
  --space-3: 1.5rem;
  --space-4: 2rem;
  --space-6: 3rem;
  --space-8: 4rem;
  --space-12: 6rem;
  --space-16: 8rem;

  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);

  /* Border Radius */
  --radius-sm: 0.375rem;
  --radius-md: 0.5rem;
  --radius-lg: 0.75rem;
  --radius-xl: 1rem;
  --radius-full: 9999px;

  /* Breakpoints (use in media queries) */
  --breakpoint-sm: 640px;
  --breakpoint-md: 768px;
  --breakpoint-lg: 1024px;
  --breakpoint-xl: 1280px;
}

${quote.logoUrl ? `Logo File Available: ${quote.logoUrl}\nLogo Filename: ${quote.logoFileName}` : 'No logo uploaded - use text-based branding'}

═══════════════════════════════════════════════════════════

SECTION 5: TARGET AUDIENCE

Demographics:
- Age Range: ${quote.customerProfile?.ageRange || 'Not specified'}
- Location: ${quote.customerProfile?.location || 'Not specified'}

How Customers Find This Business:
${formatArray(quote.howCustomersFind)}

Online Reviews:
${quote.onlineReviews && quote.onlineReviews.length > 0
    ? quote.onlineReviews.map(r => `${r.platform}: ${r.stars} stars`).join(', ')
    : 'Not specified'}

DESIGN IMPLICATIONS:
${quote.customerProfile?.ageRange?.includes('18-35') ? '- Modern, bold design with interactive elements and animations' : ''}
${quote.customerProfile?.ageRange?.includes('55') || quote.customerProfile?.ageRange?.includes('65') ? '- Large, readable text (minimum 16px body, 18px+ preferred)\n- High contrast for readability\n- Simple, clear navigation\n- Obvious call-to-action buttons' : ''}
${quote.customerProfile?.location === 'local' ? '- Emphasize location, local keywords, map integration' : ''}
${quote.customerProfile?.location === 'international' ? '- Consider multi-language support, currency options' : ''}

═══════════════════════════════════════════════════════════

SECTION 6: PAGES & SITE STRUCTURE

Required Pages:
${formatArray(quote.pagesNeeded, 'No pages specified - suggest: Home, About, Services, Contact')}

${quote.otherPages ? `Additional Pages:\n${quote.otherPages}` : ''}

${quote.servicePages ? `Service Pages Approach: ${quote.servicePages}` : ''}

Legal Pages Needed:
${formatArray(quote.legalPages)}

FILE STRUCTURE:
${techStack.includes('Next.js') ? `
Next.js Project Structure:
/
├── app/ (App Router - Next.js 13+)
│   ├── layout.js (root layout with nav/footer)
│   ├── page.js (homepage)
${quote.pagesNeeded?.includes('about') ? '│   ├── about/page.js' : ''}
${quote.pagesNeeded?.includes('services') ? '│   ├── services/page.js' : ''}
${quote.pagesNeeded?.includes('contact') ? '│   ├── contact/page.js' : ''}
${quote.pagesNeeded?.includes('portfolio') ? '│   ├── portfolio/page.js' : ''}
${quote.pagesNeeded?.includes('testimonials') ? '│   ├── testimonials/page.js' : ''}
│   └── api/ (API routes for forms, integrations)
├── components/
│   ├── Header.jsx
│   ├── Footer.jsx
│   ├── Button.jsx
│   └── [other reusable components]
├── styles/
│   ├── globals.css (design system variables)
│   └── [component-specific styles]
├── public/
│   ├── images/
│   └── assets/
├── lib/ (utility functions, Firebase config)
└── package.json

Deploy to Vercel: Connect GitHub repo, auto-deploys on push to main
` : `
Static HTML/CSS/JS Structure:
/
├── index.html (Homepage)
${quote.pagesNeeded?.includes('about') ? '├── about.html' : ''}
${quote.pagesNeeded?.includes('services') ? '├── services.html' : ''}
${quote.pagesNeeded?.includes('contact') ? '├── contact.html' : ''}
${quote.pagesNeeded?.includes('portfolio') ? '├── portfolio.html' : ''}
${quote.pagesNeeded?.includes('testimonials') ? '├── testimonials.html' : ''}
├── css/
│   ├── reset.css (normalize browser styles)
│   ├── variables.css (design tokens)
│   ├── components.css (reusable components)
│   └── main.css (page-specific styles)
├── js/
│   ├── utils.js (helper functions)
│   ├── components.js (interactive components)
│   └── main.js (initialization)
├── images/
├── assets/
└── vercel.json (Vercel configuration)

Deploy to Vercel: Drag & drop or connect GitHub repo
`}

═══════════════════════════════════════════════════════════

SECTION 7: FEATURES & FUNCTIONALITY

Contact Methods Needed:
${formatArray(quote.contactFeatures)}

Forms Required:
${quote.formsNeeded || 'Contact form (minimum)'}

Social Media Integration:
${quote.socialMedia || 'Not specified'}

Special Features:
${formatArray(quote.specialFeatures)}

${quote.specialFeatures?.includes('booking') ? `
BOOKING SYSTEM IMPLEMENTATION:
- Integrate with Cal.com or Calendly (embed or API)
- Allow users to select service/appointment type
- Calendar view with availability
- Email confirmations
- Timezone handling
` : ''}

${quote.specialFeatures?.includes('live-chat') ? `
LIVE CHAT IMPLEMENTATION:
- Consider Tawk.to (free) or Intercom
- Position in bottom-right corner
- Only show after 5 seconds on page
- Mobile-optimized
` : ''}

${quote.specialFeatures?.includes('search') ? `
SEARCH FUNCTIONALITY:
- Implement client-side search with Fuse.js
- Search across pages, services, blog posts
- Real-time results as user types
- Highlight matching terms
` : ''}

═══════════════════════════════════════════════════════════

SECTION 8: E-COMMERCE & CONTENT

${quote.needsEcommerce === 'yes' ? `
E-COMMERCE REQUIREMENTS:
E-commerce Features Needed:
${formatArray(quote.ecommerceFeatures)}

Estimated Product Count: ${quote.productCount || 'Not specified'}

IMPLEMENTATION:
${quote.productCount && parseInt(quote.productCount) > 50
    ? 'Recommend WooCommerce due to high product count'
    : 'Can use static HTML with Stripe integration or Snipcart for simple shop'}

Required Features:
- Product listing page with grid layout
- Individual product pages
- Shopping cart (localStorage persistence)
- Checkout flow with Stripe
- Order confirmation emails
- Admin panel for managing products/orders
` : 'No e-commerce functionality needed.'}

Content Strategy:
${quote.writtenContent === 'need-help' ? 'Client needs copywriting assistance - use placeholder text, suggest professional copywriter' : ''}
${quote.writtenContent === 'have-content' ? 'Client has content ready - create content blocks ready for their copy' : ''}
${quote.writtenContent === 'write-it' ? 'You will write the content - draft compelling copy for each section' : ''}

${quote.contentProvided ? `Content Details:\n${quote.contentProvided}` : ''}

Photos/Videos:
${formatArray(quote.photosVideos)}

${quote.documents ? `Additional Documents:\n${quote.documents}` : ''}

═══════════════════════════════════════════════════════════

SECTION 9: UPDATES & MAINTENANCE

What Client Wants to Update:
${formatArray(quote.wantToUpdate)}

Update Frequency: ${quote.updateFrequency || 'Not specified'}
Who Updates: ${quote.whoUpdates || 'Not specified'}

IMPLEMENTATION NOTES:
${quote.whoUpdates === 'me' || quote.whoUpdates === 'both'
    ? 'Client wants to update content themselves - Consider using Next.js with a simple CMS-like admin panel built with Firebase, or provide clear documentation for editing content files'
    : 'Developer will handle all content updates - static HTML/CSS/JS is perfect for this use case'}

═══════════════════════════════════════════════════════════

SECTION 10: MARKETING & SEO

Target Keywords:
${quote.searchKeywords || 'Not specified - research industry keywords'}

Service Area:
${quote.serviceArea || 'Not specified'}

Current Marketing:
${formatArray(quote.currentMarketing)}

SEO REQUIREMENTS:
- Semantic HTML5 (proper heading hierarchy h1 > h2 > h3)
- Meta tags (title, description, Open Graph, Twitter Card)
- Alt text on all images (descriptive, include keywords naturally)
- Structured data (Schema.org - LocalBusiness, Organization, etc.)
- XML sitemap
- Robots.txt
- Fast loading (< 3 seconds on 3G)
- Mobile-friendly (Google mobile-first indexing)
- Clean URLs (no query parameters if possible)
${quote.customerProfile?.location === 'local' ? '- Local SEO optimization (NAP consistency, Google Business integration)' : ''}

═══════════════════════════════════════════════════════════

SECTION 11: TECHNICAL REQUIREMENTS

Domain Status: ${quote.domainStatus || 'Not specified'}
${quote.domainName ? `Domain Name: ${quote.domainName}` : ''}

${industryReqs}

CORE TECHNICAL STANDARDS:
✓ Mobile-First Responsive Design
  - Breakpoints: 640px (sm), 768px (md), 1024px (lg), 1280px (xl)
  - Test on iPhone SE, iPhone 12, iPad, Desktop
  - Touch targets minimum 44x44px
  - No horizontal scroll on any device

✓ Performance Optimization
  - Images: WebP format with fallbacks, lazy loading, max 200KB per image
  - CSS: Minified, critical CSS inlined, non-critical deferred
  - JavaScript: Minified, async/defer loading, no render-blocking
  - Fonts: Subset fonts, preload critical fonts
  - Target: Lighthouse score 90+ (Performance, Accessibility, Best Practices, SEO)

✓ Cross-Browser Compatibility
  - Chrome (latest 2 versions)
  - Safari (latest 2 versions)
  - Firefox (latest 2 versions)
  - Edge (latest 2 versions)
  - Graceful degradation for older browsers

✓ Accessibility (WCAG 2.1 AA)
  - Semantic HTML5 elements
  - ARIA labels where needed
  - Keyboard navigation (tab order, focus states)
  - Color contrast ratio 4.5:1 minimum for text
  - Alt text on images
  - Skip to main content link
  - Screen reader tested

✓ Security Best Practices
  - HTTPS only (enforce with meta tag)
  - Input validation on forms
  - Sanitize user inputs
  - CSRF protection on forms
  - Content Security Policy headers (if applicable)

✓ Code Quality
  - W3C valid HTML
  - Valid CSS (no errors)
  - ESLint compliant JavaScript
  - Consistent code formatting (2-space indentation)
  - Commented code (explain complex logic)
  - No console.logs in production

═══════════════════════════════════════════════════════════

SECTION 12: GOALS & SUCCESS METRICS

Primary Goal:
${quote.primaryGoal || 'Not specified'}

Secondary Goals:
${quote.secondaryGoals || 'Not specified'}

What Success Looks Like:
${formatArray(quote.successLooksLike)}

Tracking Methods:
${formatArray(quote.trackingMethods)}

ANALYTICS IMPLEMENTATION:
${quote.trackingMethods?.includes('google-analytics') ? '- Add Google Analytics 4 tracking code\n- Track: page views, button clicks, form submissions' : ''}
${quote.trackingMethods?.includes('facebook-pixel') ? '- Add Meta Pixel for ad tracking' : ''}
${quote.trackingMethods?.includes('heatmaps') ? '- Integrate Hotjar or Microsoft Clarity for user behavior tracking' : ''}

═══════════════════════════════════════════════════════════

SECTION 13: SPECIAL REQUESTS & NOTES

Specific Wants:
${quote.specificWants || 'None specified'}

Things to Avoid:
${quote.dontWant || 'None specified'}

Client Concerns:
${quote.concerns || 'None specified'}

Additional Questions:
${quote.additionalQuestions || 'None'}

Additional Notes:
${quote.additionalNotes || 'None'}

═══════════════════════════════════════════════════════════

BUILD PROCESS - FOLLOW THESE STEPS:

PHASE 1: FOUNDATION (Complete this first)
1. Create file structure (as outlined above)
2. Create reset.css (normalize browser styles)
3. Create variables.css with design system (all CSS custom properties)
4. Create base component styles (buttons, forms, cards, etc.)
5. Set up responsive grid system

PHASE 2: HOMEPAGE BUILD
1. Header/Navigation (sticky on scroll if appropriate)
2. Hero section (compelling headline, subheadline, CTA, hero image/video)
3. Key features/services section (3-6 items with icons)
4. Social proof (testimonials, logos, stats)
5. Call-to-action section
6. Footer (contact info, social links, legal pages)

PHASE 3: ADDITIONAL PAGES
Build each page from Section 6 following the same design system

PHASE 4: INTERACTIVE FEATURES
Implement features from Section 7:
- Contact forms with validation
- Mobile menu toggle
- Image galleries/lightboxes
- Booking integration
- E-commerce functionality
- Any custom features

PHASE 5: OPTIMIZATION
1. Compress all images (TinyPNG or similar)
2. Minify CSS and JavaScript
3. Add lazy loading to images
4. Test on mobile devices (real devices if possible)
5. Run Lighthouse audit (fix issues to reach 90+ scores)
6. Validate HTML/CSS (W3C validators)
7. Test accessibility (aXe DevTools or WAVE)
8. Cross-browser testing

PHASE 6: PRE-LAUNCH CHECKLIST
□ All pages created and linked properly
□ All images have alt text
□ Forms tested (validation, submissions)
□ Mobile responsive on all devices
□ Fast loading (< 3 seconds)
□ SEO meta tags on all pages
□ Analytics tracking installed
□ Favicon added
□ 404 page created
□ Contact information accurate
□ Social media links working
□ Legal pages (privacy policy, terms) if needed

═══════════════════════════════════════════════════════════

IMPORTANT REMINDERS:
- Build mobile-first, then enhance for larger screens
- Use semantic HTML5 (header, nav, main, section, article, aside, footer)
- Keep CSS organized and commented
- Use meaningful class names (BEM methodology recommended)
- Test after each major component
- Commit code frequently with descriptive messages
- Ask clarifying questions if requirements are unclear
- Prioritize performance and accessibility
- Make it easy for the client to update content (if required)

Start with Phase 1 and work through systematically. Show your progress after each phase for review.`;

            // Show in modal with copy button
            const modalContent = `
                <div>
                    <h3 style="margin-bottom: 20px;">AI Prompt Generated</h3>
                    <textarea id="aiPromptText" style="width: 100%; height: 400px; padding: 15px; border: 1.5px solid #d1d5db; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">${prompt}</textarea>
                    <button onclick="copyAIPrompt()" style="margin-top: 15px; padding: 12px 24px; background: #05908C; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;">
                        Copy to Clipboard
                    </button>
                </div>
            `;

            showAlert(modalContent, 'info');
        };

        // Copy AI Prompt
        window.copyAIPrompt = function() {
            const textarea = document.getElementById('aiPromptText');
            if (textarea) {
                textarea.select();
                document.execCommand('copy');
                showAlert('Prompt copied to clipboard!', 'success');
            }
        };

        // Copy quote link
        window.copyQuoteLink = function(quoteId) {
            const link = `${PORTAL_BASE_URL}/client.html?id=${quoteId}`;
            navigator.clipboard.writeText(link).then(() => {
                showAlert('Quote link copied to clipboard!', 'success');
            });
        };

        // Copy admin form link (from info box)
        window.copyAdminFormLink = function() {
            const input = document.getElementById('adminFormLinkInput');
            input.select();
            input.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(input.value).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied! ✓';
                button.style.background = '#059669';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#0284c7';
                }, 2000);
            }).catch(err => {
                showAlert('Link copied!', 'success');
            });
        };

        // Update quote status
        window.updateQuoteStatus = async function(quoteId, newStatus) {
            if (!newStatus) return;

            try {
                await db.collection('websiteQuotes').doc(quoteId).update({
                    status: newStatus,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                showAlert('Quote status updated!', 'success');
                await loadWebsiteQuotes();
            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('Error updating status: ' + error.message, 'error');
            }
        };

        // Delete quote
        window.deleteQuote = async function(quoteId, businessName) {
            // Confirmation dialog
            const confirmed = confirm(`Are you sure you want to delete the quote for "${businessName}"?\n\nThis action cannot be undone and will permanently remove all form responses and uploaded files.`);

            if (!confirmed) {
                return;
            }

            try {
                // Delete the quote from Firestore
                await db.collection('websiteQuotes').doc(quoteId).delete();

                showAlert('Quote deleted successfully!', 'success');

                // Reload the quotes list
                await loadWebsiteQuotes();
            } catch (error) {
                console.error('Error deleting quote:', error);
                showAlert('Error deleting quote: ' + error.message, 'error');
            }
        };

        // ============================================
        // SETTINGS MANAGEMENT
        // ============================================

        // Load settings from Firestore
        window.loadSettings = async function() {
            try {
                const settingsDoc = await db.collection('settings').doc('config').get();

                if (settingsDoc.exists) {
                    const settings = settingsDoc.data();

                    // Company Information
                    document.getElementById('settingsSupportEmail').value = settings.support?.email || '';
                    document.getElementById('settingsSupportPhone').value = settings.support?.phone || '';

                    // Notifications - Client Portal Activity
                    document.getElementById('settingsNotifyClientStepComplete').checked = settings.notifications?.clientStepComplete || false;
                    document.getElementById('settingsNotifyLogoUpload').checked = settings.notifications?.logoUpload || false;
                    document.getElementById('settingsNotifyBrandColorsSubmit').checked = settings.notifications?.brandColorsSubmit || false;
                    document.getElementById('settingsNotifyWebsiteAccess').checked = settings.notifications?.websiteAccess || false;
                    document.getElementById('settingsNotifyCreativeApproval').checked = settings.notifications?.creativeApproval || false;
                    document.getElementById('settingsNotifyRevisionRequest').checked = settings.notifications?.revisionRequest || false;

                    // Notifications - Website Discovery Forms
                    document.getElementById('settingsNotifyNewQuotes').checked = settings.notifications?.newQuotes || false;
                    document.getElementById('settingsNotifyQuoteCompleted').checked = settings.notifications?.quoteCompleted || false;

                    // Notifications - Sales Pipeline
                    document.getElementById('settingsNotifyDealCreated').checked = settings.notifications?.dealCreated || false;
                    document.getElementById('settingsNotifyDealAssigned').checked = settings.notifications?.dealAssigned || false;
                    document.getElementById('settingsNotifyDealChanges').checked = settings.notifications?.dealChanges || false;
                    document.getElementById('settingsNotifyDealWon').checked = settings.notifications?.dealWon || false;
                    document.getElementById('settingsNotifyDealLost').checked = settings.notifications?.dealLost || false;

                    // Notifications - Client Management
                    document.getElementById('settingsNotifyNewClients').checked = settings.notifications?.newClients || false;
                    document.getElementById('settingsNotifyClientActivated').checked = settings.notifications?.clientActivated || false;
                    document.getElementById('settingsNotifyClientDeactivated').checked = settings.notifications?.clientDeactivated || false;

                    // Notifications - Messages
                    document.getElementById('settingsNotifyNewMessages').checked = settings.notifications?.newMessages || false;

                    // Notifications - Team & System
                    document.getElementById('settingsNotifyNewTeamMember').checked = settings.notifications?.newTeamMember || false;
                    document.getElementById('settingsNotifySystemErrors').checked = settings.notifications?.systemErrors || false;

                    showAlert('Settings loaded successfully', 'success');
                } else {
                    // No settings exist yet, load from config.js defaults
                    document.getElementById('settingsSupportEmail').value = DLM_CONFIG.support?.email || '';
                    document.getElementById('settingsSupportPhone').value = DLM_CONFIG.support?.phone || '';

                    showAlert('Loaded default settings. Click "Save All Changes" to persist them.', 'info');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert('Error loading settings: ' + error.message, 'error');
            }
        };

        // Save all settings to Firestore
        window.saveAllSettings = async function() {
            try {
                const settings = {
                    support: {
                        email: document.getElementById('settingsSupportEmail').value,
                        phone: document.getElementById('settingsSupportPhone').value
                    },
                    notifications: {
                        // Client Portal Activity
                        clientStepComplete: document.getElementById('settingsNotifyClientStepComplete').checked,
                        logoUpload: document.getElementById('settingsNotifyLogoUpload').checked,
                        brandColorsSubmit: document.getElementById('settingsNotifyBrandColorsSubmit').checked,
                        websiteAccess: document.getElementById('settingsNotifyWebsiteAccess').checked,
                        creativeApproval: document.getElementById('settingsNotifyCreativeApproval').checked,
                        revisionRequest: document.getElementById('settingsNotifyRevisionRequest').checked,

                        // Website Discovery Forms
                        newQuotes: document.getElementById('settingsNotifyNewQuotes').checked,
                        quoteCompleted: document.getElementById('settingsNotifyQuoteCompleted').checked,

                        // Sales Pipeline
                        dealCreated: document.getElementById('settingsNotifyDealCreated').checked,
                        dealAssigned: document.getElementById('settingsNotifyDealAssigned').checked,
                        dealChanges: document.getElementById('settingsNotifyDealChanges').checked,
                        dealWon: document.getElementById('settingsNotifyDealWon').checked,
                        dealLost: document.getElementById('settingsNotifyDealLost').checked,

                        // Client Management
                        newClients: document.getElementById('settingsNotifyNewClients').checked,
                        clientActivated: document.getElementById('settingsNotifyClientActivated').checked,
                        clientDeactivated: document.getElementById('settingsNotifyClientDeactivated').checked,

                        // Messages
                        newMessages: document.getElementById('settingsNotifyNewMessages').checked,

                        // Team & System
                        newTeamMember: document.getElementById('settingsNotifyNewTeamMember').checked,
                        systemErrors: document.getElementById('settingsNotifySystemErrors').checked
                    },
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: firebase.auth().currentUser?.email || 'unknown'
                };

                await db.collection('settings').doc('config').set(settings, { merge: true });

                showAlert('Settings saved successfully!', 'success');

                // Update global DLM_CONFIG object
                Object.assign(DLM_CONFIG, settings);

            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('Error saving settings: ' + error.message, 'error');
            }
        };

        // Load settings when switching to settings tab
        document.addEventListener('DOMContentLoaded', function() {
            const settingsTab = document.querySelector('[data-tab="settings"]');
            if (settingsTab) {
                settingsTab.addEventListener('click', function() {
                    setTimeout(loadSettings, 100);
                });
            }
        });

        // ============================================
        // NOTIFICATIONS SYSTEM (OLD BELL ICON - REMOVED)
        // ============================================
        // The old notification bell and dropdown system has been removed.
        // Notifications are now displayed in a dedicated section on the Dashboard tab.
        // See loadDashboardNotifications() and renderDashboardNotifications() functions.

        // ===================================
        // CMS CLIENTS FUNCTIONS
        // ===================================

        // Generate random password
        window.generatePassword = function() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('cmsClientPassword').value = password;
        };

        // Add CMS Client form submission
        document.getElementById('addCMSClientForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const clientName = document.getElementById('cmsClientName').value.trim();
            const email = document.getElementById('cmsClientEmail').value.trim();
            const password = document.getElementById('cmsClientPassword').value;

            try {
                // Generate client ID
                const clientId = clientName.toLowerCase().replace(/[^a-z0-9]/g, '-') + '-' + Date.now();

                // Create CMS client document with temporary password
                // User will create their Firebase Auth account on first login
                await db.collection('cmsClients').doc(clientId).set({
                    clientName: clientName,
                    email: email,
                    tempPassword: password,  // Temporary password for first login
                    userId: null,  // Will be set when user first logs in
                    active: true,
                    accountCreated: false,  // Flag to indicate account needs to be created
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: firebase.auth().currentUser.email
                });

                // Initialize website content structure
                await db.collection('websiteContent').doc(clientId).collection('pages').doc('homepage').set({
                    heroHeadline: `Welcome to ${clientName}`,
                    heroSubheadline: 'We deliver exceptional results',
                    heroImage: '',
                    heroButtonText: 'Get Started',
                    heroButtonLink: '/contact',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showAlert(`CMS Client created! Login: ${email} | Password: ${password}`, 'success');

                // Reset form
                document.getElementById('addCMSClientForm').reset();

                // Reload clients list
                loadCMSClients();

                // Send welcome email info to console (you'll handle email separately)
                console.log(`
                    ===== NEW CMS CLIENT CREATED =====
                    Client: ${clientName}
                    Email: ${email}
                    Password: ${password}
                    CMS Login: ${window.location.origin}/cms/login.html
                    Website URL: ${window.location.origin}/sites/${clientId}/
                    ==================================
                `);

            } catch (error) {
                console.error('Error creating CMS client:', error);

                let errorMessage = 'Error creating CMS client.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                }

                showAlert(errorMessage, 'error');
            }
        });

        // Load CMS Clients
        async function loadCMSClients() {
            try {
                const snapshot = await db.collection('cmsClients')
                    .where('active', '==', true)
                    .orderBy('createdAt', 'desc')
                    .get();

                const list = document.getElementById('cmsClientsList');

                if (snapshot.empty) {
                    list.innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">No CMS clients yet</p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 16px;">';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const clientId = doc.id;

                    html += `
                        <div style="border: 2px solid #E8F5F3; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="color: #012E40; margin-bottom: 8px;">${data.clientName}</h4>
                                <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 4px;">📧 ${data.email}</p>
                                <p style="color: #64748b; font-size: 0.85rem;">🔗 /sites/${clientId}/</p>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <a href="/cms/login.html" target="_blank" style="padding: 8px 16px; background: #05908C; color: white; border-radius: 6px; text-decoration: none; font-size: 0.9rem;">
                                    CMS Login
                                </a>
                                <a href="/sites/${clientId}/" target="_blank" style="padding: 8px 16px; background: #F2A922; color: #012E40; border-radius: 6px; text-decoration: none; font-size: 0.9rem;">
                                    View Site
                                </a>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                list.innerHTML = html;

            } catch (error) {
                console.error('Error loading CMS clients:', error);
                document.getElementById('cmsClientsList').innerHTML = '<p style="color: #dc2626;">Error loading clients</p>';
            }
        }

    </script>

    <!-- Deal Creation/Edit Modal -->
    <div class="modal-overlay" id="dealModal" style="display: none;">
        <div class="modal" style="max-width: min(700px, calc(100vw - 20px));">
            <div class="modal-header">
                <h2 id="dealModalTitle">Add New Deal</h2>
                <button type="button" class="close-btn" onclick="closeDealModal()">&times;</button>
            </div>

            <form id="dealForm">
                <input type="hidden" id="dealId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="dealCompanyName">Company Name *</label>
                        <input type="text" id="dealCompanyName" required>
                    </div>
                    <div class="form-group">
                        <label for="dealContactName">Contact Name</label>
                        <input type="text" id="dealContactName">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dealEmail">Email</label>
                        <input type="email" id="dealEmail">
                    </div>
                    <div class="form-group">
                        <label for="dealPhone">Phone</label>
                        <input type="tel" id="dealPhone">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dealAssignedTo">Assigned To (Admin or Sales Rep) *</label>
                        <select id="dealAssignedTo" required>
                            <option value="">Select Rep...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dealStage">Stage *</label>
                        <select id="dealStage" required>
                            <option value="qualified">Qualified</option>
                            <option value="cold-outreach">Cold Outreach</option>
                            <option value="follow-up">Follow-Up</option>
                            <option value="discovery-scheduled">Discovery Scheduled</option>
                            <option value="discovery-completed">Discovery Completed</option>
                            <option value="onboarding-portal">Onboarding Portal</option>
                            <option value="campaign-live">Campaign Live</option>
                            <option value="follow-up-resell">Follow-Up & Resell</option>
                            <option value="completed">✅ Completed</option>
                            <option value="closed-lost">❌ Closed/Lost</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dealMRR">Monthly Recurring Revenue (MRR)</label>
                        <input type="number" id="dealMRR" placeholder="0" min="0" step="100">
                    </div>
                    <div class="form-group">
                        <label for="dealContractLength">Contract Length (months)</label>
                        <input type="number" id="dealContractLength" placeholder="6" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="dealClientPortalId">Link to Client Portal (Optional)</label>
                    <select id="dealClientPortalId" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; background: white;">
                        <option value="">No client portal linked</option>
                    </select>
                    <small style="color: #666; font-size: 0.85rem;">Select an existing client portal to link to this deal</small>
                </div>

                <!-- Website Quote Link (Read-only, auto-filled) -->
                <div class="form-group" id="websiteQuoteSection" style="display: none;">
                    <label style="color: #F59E0B; font-weight: 600;">📝 Website Quote</label>
                    <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #92400E; font-size: 0.9rem;">This deal was auto-created from a website quote submission</span>
                        <button type="button" onclick="viewLinkedWebsiteQuote()" style="background: #F59E0B; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                            View Quote
                        </button>
                    </div>
                    <input type="hidden" id="dealWebsiteQuoteId">
                </div>

                <div class="form-group">
                    <label for="dealNotes">Notes</label>
                    <textarea id="dealNotes" rows="4" placeholder="Add any notes about this deal..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeDealModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Deal</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
