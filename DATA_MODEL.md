# Drive Lead Media - Unified Client Data Model

## Overview
This document defines the unified data model for the Drive Lead Media client portal system, establishing clear relationships between all data entities.

---

## Collections Structure

### 1. `clients` Collection
**Purpose:** Central client records for onboarding portals (contract & month-to-month)

**Document ID:** Auto-generated by Firestore

**Fields:**
```javascript
{
  // Core Identity
  clientName: string,              // Business/client name
  clientEmail: string,             // Primary contact email
  clientPhone: string,             // Phone number (optional)

  // Portal Configuration
  portalType: string,              // "contract" | "m2m"
  active: boolean,                 // Portal status (default: true)
  createdAt: timestamp,            // Portal creation date
  updatedAt: timestamp,            // Last modification

  // Onboarding Progress (Steps 1-5)
  step1Complete: boolean,          // Agreements signed
  step2Complete: boolean,          // Payment setup
  step3Complete: boolean,          // Brand kit uploaded
  step4Complete: boolean,          // Meta setup complete
  step5Complete: boolean,          // Tracking installed

  // Step 1: Agreement Links
  dpaLink: string,                 // DocuSign DPA URL
  serviceAgreementLink: string,    // Service agreement URL

  // Step 2: Payment Links
  stripeLink: string,              // Stripe payment URL
  paymentType: string,             // "monthly" | "upfront"

  // Step 3: Brand Assets
  brandLogoUrl: string,            // Firebase Storage URL
  brandLogoFileName: string,       // Original filename
  brandPrimaryColor: string,       // Hex color code
  brandSecondaryColor: string,     // Hex color code

  // Step 4: Meta Setup (tracked via completion flag)

  // Step 5: Website Access
  websiteAccessType: string,       // "connect" | "temporary"
  adminName: string,               // Website admin name
  adminEmail: string,              // Website admin email
  adminPhone: string,              // Website admin phone

  // Relationships
  websiteQuoteId: string,          // LINK → websiteQuotes collection
  dealId: string,                  // LINK → deals collection
  messageIds: [string],            // LINK → messages collection (array)
}
```

---

### 2. `websiteQuotes` Collection
**Purpose:** Website discovery form submissions

**Document ID:** Custom format `WQ_{timestamp}` (e.g., WQ_1704067200000)

**Fields:**
```javascript
{
  // Status
  status: string,                  // "incomplete" | "completed" | "quote-sent" | "won" | "lost"
  completionPercent: number,       // 0-100 progress
  createdAt: timestamp,
  completedAt: timestamp,
  updatedAt: timestamp,

  // Section 1: Business
  businessName: string,
  ownerName: string,
  phone: string,
  email: string,
  businessDescription: string,
  yearsInBusiness: string,
  businessType: string,
  locations: string,
  budgetRange: string,             // "under-2k" | "2k-5k" | "5k-10k" | "10k-20k" | "20k+" | "not-sure"
  competitor1Url: string,
  competitor2Url: string,

  // Section 2: Current Website
  hasCurrentWebsite: string,       // "yes" | "no"
  currentWebsiteUrl: string,
  websiteAge: string,
  builtBy: string,
  currentProblems: [string],
  whatWorksWell: string,
  monthlyVisitors: string,
  trafficSources: string,

  // Section 3: Inspiration
  favoriteWebsite: {
    url: string,
    likesAboutLook: string,
    likesAboutFunction: [string],
    likesAboutColors: string,
    likesAboutLayout: string,
    specificFeatures: [string]
  },

  // Section 4: Look & Feel
  brandColors: {
    main: string,
    secondary: string,
    accent: string,
    background: string
  },

  // Section 5: Customers
  customerProfile: {
    ageRange: string,
    location: string
  },
  howCustomersFind: [string],
  onlineReviews: {
    google: string,
    facebook: string,
    yelp: string,
    other: string
  },

  // Section 6: Pages Needed
  pagesNeeded: [string],

  // Section 7: Features
  socialMedia: {
    facebook: string,
    instagram: string,
    x: string,
    youtube: string,
    linkedin: string,
    tiktok: string
  },
  searchKeywords: string,

  // Section 8: Contact Features
  contactFeatures: [string],

  // Section 9: E-commerce
  needsEcommerce: string,          // "yes" | "no"
  productCount: string,
  acceptsPayments: string,         // "yes" | "no"
  paymentMethods: [string],

  // Section 10: Special Features
  specialFeatures: [string],

  // Section 11: Domain
  domainStatus: string,            // "own" | "need"
  domainName: string,

  // Section 12: Special Requests
  specialRequests: string,

  // Relationships
  autoCreatedDealId: string,       // LINK → deals collection (auto-created on completion)
}
```

---

### 3. `deals` Collection
**Purpose:** Sales CRM pipeline tracking

**Document ID:** Auto-generated by Firestore

**Fields:**
```javascript
{
  // Core Info
  companyName: string,
  contactName: string,
  email: string,
  phone: string,

  // Sales Status
  assignedTo: string,              // Sales rep ID or "unassigned"
  stage: string,                   // "Lead" | "Qualified" | "Proposal" | "Negotiation" | "Won" | "Lost"

  // Financial
  mrr: number,                     // Monthly recurring revenue
  contractLength: number,          // Contract duration in months
  value: number,                   // Total deal value (calculated: mrr * contractLength)

  // Timestamps
  createdAt: timestamp,
  updatedAt: timestamp,
  closedDate: timestamp,           // When deal was won/lost
  archivedAt: timestamp,           // When deal was archived

  // Status
  archived: boolean,               // true if deal is lost

  // Notes
  notes: string,                   // Free-form notes about the deal

  // Relationships
  clientPortalId: string,          // LINK → clients collection (when portal created)
  websiteQuoteId: string,          // LINK → websiteQuotes collection (if auto-created from quote)
}
```

---

### 4. `messages` Collection
**Purpose:** Client ↔ Admin messaging system

**Document ID:** Auto-generated by Firestore

**Fields:**
```javascript
{
  // Message Content
  clientId: string,                // LINK → clients collection
  clientName: string,              // Denormalized for display
  message: string,                 // Message text

  // Sender Info
  sender: string,                  // "client" | "admin"
  senderName: string,              // Display name

  // Status
  read: boolean,                   // Has admin read the message?

  // Timestamps
  timestamp: timestamp,            // When message was sent

  // Relationships
  clientId: string,                // LINK → clients collection
}
```

---

### 5. `salesReps` Collection
**Purpose:** Sales team member profiles

**Document ID:** Auto-generated by Firestore

**Fields:**
```javascript
{
  // Core Info
  name: string,
  email: string,
  phone: string,

  // Status
  active: boolean,

  // Timestamps
  createdAt: timestamp,

  // Relationships (calculated dynamically)
  // dealIds: [string] - Found by querying deals.assignedTo === repId
}
```

---

### 6. `notifications` Collection
**Purpose:** In-portal notification system for admins, sales reps, and clients

**Document ID:** Auto-generated by Firestore

**Fields:**
```javascript
{
  // Notification Type
  type: string,                    // "QUOTE_SUBMITTED" | "CLIENT_STEP_COMPLETE" | "DEAL_ASSIGNED" | "DEAL_STAGE_CHANGE" | "MESSAGE_RECEIVED" | "MESSAGE_REPLY"

  // Recipient Information
  recipientId: string,             // User ID (admin UID, sales rep UID, or client ID)
  recipientType: string,           // "admin" | "sales-rep" | "client"

  // Notification Content
  message: string,                 // Display message (e.g., "New website quote from ABC Corp")
  actionUrl: string | null,        // URL to navigate when clicked (e.g., "admin.html?tab=website-quotes")

  // Related Entity
  relatedId: string | null,        // ID of related entity (clientId, dealId, quoteId, etc.)

  // Additional Context
  metadata: object,                // Type-specific metadata (e.g., {companyName, budgetRange, dealId})

  // Status
  read: boolean,                   // Read status (default: false)

  // Timestamps
  createdAt: timestamp,            // When notification was created
  readAt: timestamp | null         // When notification was marked as read (optional)
}
```

**Notification Types:**
- `QUOTE_SUBMITTED`: New website quote submitted → Notify admin
- `CLIENT_STEP_COMPLETE`: Client completed onboarding step → Notify admin
- `DEAL_ASSIGNED`: Deal assigned to sales rep → Notify rep
- `DEAL_STAGE_CHANGE`: Deal moved to new stage → Notify assigned rep
- `MESSAGE_RECEIVED`: Client sent message → Notify admin
- `MESSAGE_REPLY`: Admin replied to message → Notify client

**Indexes Required:**
```javascript
// Composite index for recipient queries
recipientId ASC, recipientType ASC, createdAt DESC

// Composite index for unread count
recipientId ASC, recipientType ASC, read ASC
```

---

## Relationship Map

```
┌─────────────────────────────────────────────────────────────────┐
│                     UNIFIED CLIENT DATA MODEL                    │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │ websiteQuotes│ (Discovery Form)
    └──────┬───────┘
           │
           │ autoCreatedDealId
           ├──────────────────────────┐
           │                          ▼
           │                    ┌──────────┐
           │                    │  deals   │ (CRM Pipeline)
           │                    └────┬─────┘
           │                         │
           │                         │ clientPortalId
           │                         │
           │                         ▼
           │                    ┌──────────┐
           └───────────────────▶│ clients  │ (Portal Onboarding)
                                └────┬─────┘
                                     │
                                     │ clientId
                                     ▼
                                ┌──────────┐
                                │ messages │ (Chat)
                                └──────────┘

                                ┌──────────┐
                                │salesReps │
                                └────┬─────┘
                                     │
                                     │ assignedTo
                                     ▼
                                ┌──────────┐
                                │  deals   │
                                └──────────┘
```

---

## Data Flow Examples

### Flow 1: Website Quote → Deal → Client Portal
```
1. Client fills website discovery form
   → Creates document in websiteQuotes collection
   → Status: "incomplete" → "completed"

2. On completion, auto-creates CRM deal
   → Creates document in deals collection
   → deal.websiteQuoteId = quote.id
   → deal.stage = "Lead"
   → quote.autoCreatedDealId = deal.id

3. Admin assigns deal to sales rep
   → deal.assignedTo = repId

4. Deal progresses to "Won"
   → Admin creates client portal

5. Client portal created
   → Creates document in clients collection
   → client.websiteQuoteId = quote.id (optional link)
   → deal.clientPortalId = client.id
```

### Flow 2: Direct Client Portal Creation
```
1. Admin creates client portal directly
   → Creates document in clients collection
   → No websiteQuote or deal

2. Client completes onboarding
   → Updates client.step1Complete through client.step5Complete

3. Client sends message
   → Creates document in messages collection
   → message.clientId = client.id
```

---

## Query Patterns

### Get All Data for a Client Portal
```javascript
// 1. Get client record
const client = await db.collection('clients').doc(clientId).get();

// 2. Get related deal (if exists)
const deal = await db.collection('deals')
  .where('clientPortalId', '==', clientId)
  .get();

// 3. Get related website quote (if exists)
if (client.websiteQuoteId) {
  const quote = await db.collection('websiteQuotes')
    .doc(client.websiteQuoteId)
    .get();
}

// 4. Get all messages
const messages = await db.collection('messages')
  .where('clientId', '==', clientId)
  .orderBy('timestamp', 'desc')
  .get();
```

### Get All Data for a Deal
```javascript
// 1. Get deal record
const deal = await db.collection('deals').doc(dealId).get();

// 2. Get related website quote (if exists)
if (deal.websiteQuoteId) {
  const quote = await db.collection('websiteQuotes')
    .doc(deal.websiteQuoteId)
    .get();
}

// 3. Get related client portal (if exists)
if (deal.clientPortalId) {
  const client = await db.collection('clients')
    .doc(deal.clientPortalId)
    .get();
}

// 4. Get assigned sales rep
const rep = await db.collection('salesReps')
  .doc(deal.assignedTo)
  .get();
```

### Get All Data for a Website Quote
```javascript
// 1. Get quote record
const quote = await db.collection('websiteQuotes').doc(quoteId).get();

// 2. Get auto-created deal (if exists)
if (quote.autoCreatedDealId) {
  const deal = await db.collection('deals')
    .doc(quote.autoCreatedDealId)
    .get();
}

// Alternative: Find deal by websiteQuoteId
const deals = await db.collection('deals')
  .where('websiteQuoteId', '==', quoteId)
  .get();
```

---

## Best Practices

### 1. Always Link Related Records
- When creating a deal from a quote: Set `deal.websiteQuoteId` AND `quote.autoCreatedDealId`
- When creating a portal from a deal: Set `deal.clientPortalId` AND optionally `client.dealId`
- When sending a message: Always set `message.clientId`

### 2. Denormalize Display Data
- Store `clientName` in messages for faster display without joins
- Store `businessName` in deals for quick pipeline view
- Calculate `value` from `mrr * contractLength` when displaying

### 3. Use Consistent Naming
- All IDs end with `Id` (clientId, dealId, quoteId, etc.)
- All timestamps end with `At` (createdAt, updatedAt, completedAt, etc.)
- All boolean flags end with complete/active (step1Complete, active, etc.)

### 4. Soft Deletes
- Use `archived: true` instead of deleting deals
- Use `active: false` instead of deleting clients
- Preserve data for historical reporting

---

## Migration Notes

### Existing Data Compatibility
All existing code is compatible with this data model. The relationships are already implemented via the field linkages described above.

### Future Enhancements
Consider adding:
1. `clients.dealId` - Direct back-reference to originating deal
2. `clients.messageIds` - Array of message IDs for faster lookups
3. Composite indexes for common query patterns
4. `audit` collection for change tracking
