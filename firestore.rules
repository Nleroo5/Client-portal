rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
             get(/databases/$(database)/documents/salesReps/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if user is a sales rep
    function isRep() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/salesReps/$(request.auth.uid));
    }

    // Helper function to check if rep owns the resource
    function isRepOwner(repId) {
      return request.auth != null && request.auth.uid == repId;
    }

    // Client Portals - Allow unauthenticated read access (clients access via URL with client ID)
    // Admin can write, anyone can read (portal is password-protected at app level)
    match /clients/{clientId} {
      allow read: if true;  // Allow unauthenticated read (protected by temp password in portal)
      allow write: if isAdmin();
      allow update: if true;  // Allow clients to update their own progress steps
    }

    // Sales Reps - Allow unauthenticated users to list active reps (for login dropdown)
    // Authenticated reps can read their own data, admins can read/write/delete all
    match /salesReps/{repId} {
      // Allow admins to read all reps
      allow read: if isAdmin();

      // Allow anyone to read basic info of active reps (for login page dropdown)
      // Allow authenticated users to read their own document (needed for isAdmin check)
      allow read: if resource.data.active == true ||
                     (request.auth != null && request.auth.uid == repId);

      // EMERGENCY: Allow authenticated users to create their own admin document ONCE
      // This is for initial admin setup or recovery from accidental deletion
      allow create: if request.auth != null &&
                       request.auth.uid == repId &&
                       request.resource.data.email == request.auth.token.email &&
                       request.resource.data.role == 'admin';

      allow update, delete: if isAdmin();
    }

    // Deals - Reps can read their own, update limited stages. Admins can do everything.
    match /deals/{dealId} {
      // Admins can do everything (put this first for priority)
      allow read, write, delete: if isAdmin();

      // Reps can read deals assigned to them
      allow read: if isRep() &&
                     resource.data.assignedTo == request.auth.uid;

      // Reps can create deals
      allow create: if isRep() &&
                       request.resource.data.assignedTo == request.auth.uid &&
                       request.resource.data.stage in ['qualified', 'cold-outreach', 'follow-up', 'discovery-scheduled'];

      // Reps can only update deals assigned to them and only to allowed stages
      allow update: if isRep() &&
                       resource.data.assignedTo == request.auth.uid &&
                       (
                         // Can only change stage to allowed stages or mark as lost
                         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['stage']) ||
                         request.resource.data.stage in ['qualified', 'cold-outreach', 'follow-up', 'discovery-scheduled', 'closed-lost']
                       );
    }

    // Scorecard - Admins can write, reps can read all scorecards (for leaderboard)
    match /scorecard/{scorecardId} {
      // Reps can read all scorecards to view leaderboard
      allow read: if isRep();

      // Only admins can write scorecard data
      allow write: if isAdmin();
    }

    // Targets - Admins only (deprecated, but keeping for backwards compatibility)
    match /targets/{targetId} {
      allow read: if isRep();
      allow write: if isAdmin();
    }

    // Deal audit trail
    match /dealAudit/{auditId} {
      allow read: if isRep() || isAdmin();
      allow write: if isRep() || isAdmin();
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
