<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - Drive Lead Media</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Young+Serif:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="sales-styles.css?v=6.0">
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>Drive Lead Media</h1>
            <p class="welcome-text">Welcome back, <span id="repNameDisplay">Loading...</span></p>
        </div>
        <div class="header-right">
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="deals" onclick="switchTab('deals')">
            My Deals
        </button>
        <button class="nav-tab" data-tab="week" onclick="switchTab('week')">
            This Week
        </button>
        <button class="nav-tab" data-tab="team" onclick="switchTab('team')">
            Leaderboard
        </button>
        <button class="nav-tab" data-tab="actions" onclick="switchTab('actions')">
            Tasks
        </button>
        <button class="nav-tab" data-tab="archived" onclick="switchTab('archived')">
            Archived
        </button>
    </div>

    <!-- Main Content Container -->
    <div class="dashboard-container">

        <!-- Tab 1: My Deals -->
        <div class="tab-content active" id="tab-deals">
            <!-- Pipeline Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%); padding: 20px; border-radius: 12px; border: 2px solid #F2A922; box-shadow: 0 8px 16px rgba(1, 46, 64, 0.15);">
                <div>
                    <div style="font-family: 'Bitter', serif; font-size: 1.25rem; font-weight: 700; color: #000000;">My Pipeline</div>
                    <div style="font-size: 0.9rem; color: #012E40; margin-top: 4px;"><span id="totalDealsCount">0</span> active deals</div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 16px; background: #EEF4D9; border-radius: 6px; border: 2px solid #85C7B3;">
                        <input type="checkbox" id="filterActionNeeded" onchange="loadMyPipeline()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 0.9rem; font-weight: 600; color: #000000;">Action needed today</span>
                    </label>
                    <button class="btn btn-primary" onclick="openNewDealModal()" style="background: #05908C !important; color: #000000 !important; border: 2px solid #05908C !important; font-weight: 700;">+ New Deal</button>
                </div>
            </div>

            <div class="pipeline-board" id="pipelineBoard">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading your deals...</p>
                </div>
            </div>
        </div>

        <!-- Tab 2: This Week -->
        <div class="tab-content" id="tab-week">
            <!-- Week Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-family: 'Bitter', serif; font-size: 2rem; font-weight: 700; margin-bottom: 4px; color: #F2A922;">This Week's Progress</h2>
                    <p style="color: #EEF4D9; font-size: 1rem; margin: 0; font-family: 'Bitter', serif;" id="weekDates">Loading...</p>
                </div>
                <div style="background: linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%); padding: 16px 24px; border-radius: 12px; border: 2px solid #F2A922; box-shadow: 0 4px 12px rgba(242, 169, 34, 0.15); text-align: center;">
                    <div style="font-size: 0.65rem; color: #64748B; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 4px;">Days Remaining</div>
                    <div style="font-size: 2.5rem; font-weight: 700; color: #F2A922; font-family: 'Bitter', serif; line-height: 1;" id="daysLeft">0</div>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div id="weeklyMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Metrics will be loaded here -->
                <div style="text-align: center; padding: 40px; background: #FFFFFF; border-radius: 8px; grid-column: 1/-1; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <div class="spinner"></div>
                    <p style="color: #64748B;">Loading your weekly metrics...</p>
                </div>
            </div>

            <!-- Weekly Results -->
            <div style="background: linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%); padding: 32px; border-radius: 12px; border: 2px solid #F2A922; box-shadow: 0 6px 16px rgba(242, 169, 34, 0.15);">
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; color: #000000; font-family: 'Bitter', serif; margin: 0;">Weekly Results</h3>
                </div>

                <!-- Activity Grid -->
                <div id="activityTrackerGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Tab 3: Leaderboard -->
        <div class="tab-content" id="tab-team">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-family: 'Bitter', serif; font-size: 2rem; font-weight: 700; margin-bottom: 4px; color: #F2A922;">Leaderboard</h2>
                    <p style="color: #EEF4D9; font-size: 1rem; margin: 0;" id="teamWeekDates">Week of Loading...</p>
                </div>
                <div style="text-align: right;" id="yourRankDisplay">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #05908C;">â€”</div>
                    <div style="font-size: 0.85rem; color: #012E40;">Your rank</div>
                </div>
            </div>

            <div class="team-leaderboard">
                <table class="scorecard-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Rank</th>
                            <th>Rep Name</th>
                            <th>Disc</th>
                            <th>Onboard</th>
                            <th>Live</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody id="teamLeaderboardBody">
                        <tr>
                            <td colspan="7" class="loading-cell">Loading team data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: #F8FAFC; border-radius: 8px; border-left: 4px solid #0EA5E9; display: none;" id="gapToFirst">
                <p style="margin: 0; font-size: 0.9rem; color: #0F172A;"><strong>Gap to #1:</strong> <span id="gapText">â€”</span></p>
            </div>
        </div>

        <!-- Tab 4: Tasks -->
        <div class="tab-content" id="tab-actions">
            <div style="margin-bottom: 24px;">
                <h2 style="font-family: 'Bitter', serif; font-size: 2rem; font-weight: 700; margin-bottom: 4px; color: #FFFFFF;">Tasks</h2>
                <p style="color: #EEF4D9; font-size: 1rem; margin: 0;">What needs your attention right now</p>
            </div>

            <!-- Stuck Deals (New Priority Section) -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-family: 'Bitter', serif; font-size: 1.25rem; font-weight: 700; color: #FFFFFF; margin: 0;">Stuck Deals (>7 Days)</h3>
                    <span id="stuckDealsCount" style="background: #dc2626; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="stuckDeals" style="background: #FFFFFF; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #64748B;">No stuck deals</p>
                </div>
            </div>

            <!-- Overdue -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-family: 'Bitter', serif; font-size: 1.25rem; font-weight: 700; color: #FFFFFF; margin: 0;">Overdue</h3>
                    <span id="overdueCount" style="background: #dc2626; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="overdueTasks" style="background: #FFFFFF; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #64748B;">No overdue items</p>
                </div>
            </div>

            <!-- Due Today -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-family: 'Bitter', serif; font-size: 1.25rem; font-weight: 700; color: #FFFFFF; margin: 0;">Due Today</h3>
                    <span id="dueTodayCount" style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="dueTodayTasks" style="background: #FFFFFF; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #64748B;">No tasks due today</p>
                </div>
            </div>

            <!-- Upcoming -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-family: 'Bitter', serif; font-size: 1.25rem; font-weight: 700; color: #FFFFFF; margin: 0;">Upcoming</h3>
                    <span id="upcomingCount" style="background: #64748B; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="upcomingTasks" style="background: #FFFFFF; border-radius: 8px; border: 1px solid #E2E8F0; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #64748B;">No upcoming tasks</p>
                </div>
            </div>
        </div>

        <!-- Tab 5: Archived -->
        <div class="tab-content" id="tab-archived">
            <div style="margin-bottom: 24px;">
                <h2 style="font-family: 'Bitter', serif; font-size: 2rem; font-weight: 700; margin-bottom: 4px; color: #FFFFFF;">Archived Deals</h2>
                <p style="color: #EEF4D9; font-size: 1rem; margin: 0;">Deals that were marked as lost</p>
            </div>

            <div style="background: #FFFFFF; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                <table class="scorecard-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Contact</th>
                            <th>Stage When Lost</th>
                            <th>Archived Date</th>
                        </tr>
                    </thead>
                    <tbody id="archivedDealsBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 24px; color: #64748B;">Loading archived deals...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Deal Modal -->
    <div id="dealModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #FFFFFF; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
            <div style="padding: 24px; border-bottom: 1px solid #E2E8F0;">
                <h2 id="dealModalTitle" style="margin: 0; color: #0F172A;">Add New Deal</h2>
            </div>
            <form id="dealForm" style="padding: 24px;">
                <input type="hidden" id="dealId" value="">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Company Name *</label>
                        <input type="text" id="dealCompanyName" required style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Contact Name</label>
                        <input type="text" id="dealContactName" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Website</label>
                        <input type="text" id="dealWebsite" placeholder="example.com" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Email</label>
                            <input type="email" id="dealEmail" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Phone</label>
                            <input type="tel" id="dealPhone" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Stage *</label>
                        <select id="dealStage" required style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                            <option value="qualified">Qualified</option>
                            <option value="cold-outreach">Cold Outreach</option>
                            <option value="follow-up">Follow-Up</option>
                            <option value="discovery-scheduled">Discovery Scheduled</option>
                            <option value="discovery-completed">Discovery Completed</option>
                            <option value="onboarding-portal">Onboarding Portal</option>
                            <option value="campaign-live">Campaign Live</option>
                            <option value="follow-up-resell">Follow-Up & Resell</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Attachments</label>
                        <input type="file" id="dealAttachments" multiple style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                        <div id="attachmentsList" style="margin-top: 8px; font-size: 0.85rem; color: #64748B;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 1px solid #E2E8F0;">
                    <button type="button" onclick="closeDealModal()" class="btn btn-outline" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="dealSubmitBtn">Create Deal</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Configuration -->
    <script src="config.js"></script>

    <!-- Main Functions -->
    <script src="sales-functions.js"></script>

    <script>
        // CRITICAL SECURITY: Check Firebase Authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Verify Firebase Authentication
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) {
                    // Not authenticated - redirect to login
                    console.warn('Unauthorized access attempt to sales dashboard');
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                    return;
                }

                // User is authenticated - verify they are a sales rep
                try {
                    const repDoc = await db.collection('salesReps').doc(user.uid).get();
                    if (!repDoc.exists) {
                        console.error('User is not a sales rep');
                        await firebase.auth().signOut();
                        sessionStorage.clear();
                        window.location.href = 'index.html';
                        return;
                    }

                    const repData = repDoc.data();

                    // Store rep info in session for quick access
                    sessionStorage.setItem('repAuthenticated', 'true');
                    sessionStorage.setItem('repId', user.uid);
                    sessionStorage.setItem('repName', repData.name);
                    sessionStorage.setItem('repRole', repData.role);

                    // Load rep name in header
                    document.getElementById('repNameDisplay').textContent = repData.name || 'Rep';

                    // Initialize dashboard
                    initializeDashboard();
                } catch (error) {
                    console.error('Error verifying rep:', error);
                    await firebase.auth().signOut();
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
            });
        });

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await firebase.auth().signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'deals') {
                loadMyPipeline();
            } else if (tabName === 'week') {
                loadThisWeek();
            } else if (tabName === 'team') {
                loadTeamLeaderboard();
            } else if (tabName === 'actions') {
                loadActionItems();
            } else if (tabName === 'archived') {
                loadArchivedDeals();
            }
        }

        // Initialize dashboard (load default tab)
        async function initializeDashboard() {
            // Load initial data for the active tab (My Deals)
            await loadMyPipeline();
        }


        // Load My Pipeline
        async function loadMyPipeline() {
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            const pipelineBoard = document.getElementById('pipelineBoard');
            pipelineBoard.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading your deals...</p></div>';

            try {
                // Load deals assigned to this rep
                const snapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .get();

                const deals = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Only show active deals (not completed or closed-lost)
                    if (data.stage !== 'completed' && data.stage !== 'closed-lost') {
                        deals.push({ id: doc.id, ...data });
                    }
                });

                // Update deal count display
                document.getElementById('totalDealsCount').textContent = deals.length;

                renderPipelineBoard(deals);
            } catch (error) {
                console.error('Error loading pipeline:', error);
                pipelineBoard.innerHTML = '<div class="loading-state"><p style="color: #d32f2f;">Error loading pipeline. Please refresh.</p></div>';
            }
        }

        // Render Pipeline Board
        function renderPipelineBoard(deals) {
            const pipelineBoard = document.getElementById('pipelineBoard');

            const stages = [
                { id: 'qualified', name: 'Qualified' },
                { id: 'cold-outreach', name: 'Cold Outreach' },
                { id: 'follow-up', name: 'Follow-Up' },
                { id: 'discovery-scheduled', name: 'Discovery Scheduled' },
                { id: 'discovery-completed', name: 'Discovery Completed' },
                { id: 'onboarding-portal', name: 'Onboarding Portal' },
                { id: 'campaign-live', name: 'Campaign Live' },
                { id: 'follow-up-resell', name: 'Follow-Up & Resell' }
            ];

            // Group deals by stage
            const dealsByStage = {};
            stages.forEach(stage => {
                dealsByStage[stage.id] = deals.filter(d => d.stage === stage.id);
            });

            // Render empty state if no deals
            if (deals.length === 0) {
                pipelineBoard.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: #FFFFFF; border-radius: 8px; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                        <h3 style="color: #64748B; font-weight: 500; margin-bottom: 8px;">No Deals Yet</h3>
                        <p style="color: #64748B; font-size: 0.9rem; margin-bottom: 20px;">Start tracking your sales pipeline by adding your first deal.</p>
                        <button class="btn btn-primary" onclick="openNewDealModal()">+ Add First Deal</button>
                    </div>
                `;
                return;
            }

            // Render pipeline columns
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">';

            stages.forEach(stage => {
                const stageDeals = dealsByStage[stage.id] || [];
                html += `
                    <div class="stage-column" data-stage="${stage.id}" ondrop="handleDrop(event, '${stage.id}')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" style="background: linear-gradient(180deg, rgba(238, 244, 217, 0.4) 0%, rgba(255, 255, 255, 0.8) 100%); backdrop-filter: blur(8px); border-radius: 12px; padding: 18px; min-height: 400px; border: 2px solid #85C7B3; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(1, 46, 64, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #F2A922;">
                            <h3 style="font-family: 'Bitter', serif; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #000000; margin: 0;">${stage.name}</h3>
                            <span style="background: linear-gradient(135deg, #F2A922 0%, #f59e0b 100%); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 6px rgba(242, 169, 34, 0.3);">${stageDeals.length}</span>
                        </div>
                        <div class="stage-cards">
                `;

                // Check if multiple deals in this stage
                const isCompressed = stageDeals.length > 1;

                stageDeals.forEach(deal => {
                    // Calculate days in stage
                    const lastUpdated = deal.lastUpdated?.toDate() || deal.createdAt?.toDate() || new Date();
                    const daysInStage = Math.floor((new Date() - lastUpdated) / (1000 * 60 * 60 * 24));

                    // Stage-specific thresholds
                    const stageThresholds = {
                        'qualified': { ideal: 2, warning: 3 },
                        'cold-outreach': { ideal: 5, warning: 7 },
                        'follow-up': { ideal: 7, warning: 10 },
                        'discovery-scheduled': { ideal: 3, warning: 3 },
                        'discovery-completed': { ideal: 4, warning: 5 },
                        'onboarding-portal': { ideal: 7, warning: 10 },
                        'campaign-live': { ideal: 30, warning: 45 },
                        'follow-up-resell': { ideal: 60, warning: 90 }
                    };

                    const threshold = stageThresholds[deal.stage] || { ideal: 7, warning: 7 };

                    // Color-coded status: green (on track), yellow (warning), red (overdue)
                    let statusColor, statusBg, statusText;
                    if (daysInStage <= threshold.ideal) {
                        statusColor = '#000000'; // black
                        statusBg = '#d1fae5';
                        statusText = 'On Track';
                    } else if (daysInStage <= threshold.warning) {
                        statusColor = '#F59E0B'; // yellow
                        statusBg = '#fef3c7';
                        statusText = 'Warning';
                    } else {
                        statusColor = '#dc2626'; // red
                        statusBg = '#fee2e2';
                        statusText = 'Overdue';
                    }

                    const isStalling = daysInStage > threshold.warning;
                    const stageColor = isStalling ? '#dc2626' : statusColor;

                    // Format last activity
                    const lastActivityText = daysInStage === 0 ? 'Today' :
                                           daysInStage === 1 ? 'Yesterday' :
                                           `${daysInStage} days ago`;

                    // Expected timeline text
                    const expectedDays = threshold.ideal;
                    const timelineText = expectedDays === 1 ? '1 day' : `${expectedDays} days`;

                    if (isCompressed) {
                        // COMPRESSED VIEW - Only show company and contact name, click to expand
                        html += `
                            <div class="deal-card" id="deal-${deal.id}" draggable="true" ondragstart="handleDragStart(event, '${deal.id}')" ondragend="handleDragEnd(event)" onclick="toggleExpandCard('${deal.id}', event)" style="background: linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%); border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; border-left: 4px solid #F2A922; cursor: pointer; transition: all 0.15s ease; border: 2px solid rgba(0, 0, 0, 0.75); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);">
                                <div class="card-summary">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600; color: #012E40; font-size: 0.9rem;">${deal.companyName || 'Unnamed Deal'}</div>
                                            <div style="font-size: 0.8rem; color: #64748B; margin-top: 2px;">${deal.contactName || 'No contact'}</div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">${daysInStage}d</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-details" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 2px solid #85C7B3;">
                                    <!-- Edit & Delete Controls -->
                                    <div style="display: flex; gap: 6px; margin-bottom: 12px;">
                                        <button onclick="openEditDeal('${deal.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #EEF4D9; border: 2px solid rgba(0, 0, 0, 0.75); border-radius: 4px; font-size: 0.7rem; cursor: pointer; color: #012E40; font-weight: 600;" title="Edit deal">Edit</button>
                                        <button onclick="confirmLostDeal('${deal.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #fef2f2; border: 2px solid rgba(0, 0, 0, 0.75); border-radius: 4px; font-size: 0.7rem; cursor: pointer; color: #000000; font-weight: 600;" title="Mark as lost">Lost</button>
                                    </div>

                                    <!-- Quick Stage Change -->
                                    <div style="margin-bottom: 8px;">
                                        <select onchange="changeStage('${deal.id}', this.value); event.stopPropagation();" style="width: 100%; padding: 6px 8px; border: 2px solid rgba(0, 0, 0, 0.75); border-radius: 4px; font-size: 0.8rem; background: #FFFFFF; cursor: pointer; color: #012E40;">
                                            <option value="" disabled selected>Move to stage...</option>
                                            <option value="qualified" ${deal.stage === 'qualified' ? 'disabled' : ''}>Qualified</option>
                                            <option value="cold-outreach" ${deal.stage === 'cold-outreach' ? 'disabled' : ''}>Cold Outreach</option>
                                            <option value="follow-up" ${deal.stage === 'follow-up' ? 'disabled' : ''}>Follow-Up</option>
                                            <option value="discovery-scheduled" ${deal.stage === 'discovery-scheduled' ? 'disabled' : ''}>Discovery Scheduled</option>
                                        </select>
                                    </div>

                                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                                        <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${statusText}</span>
                                        <span style="color: #000000; font-size: 0.75rem;">${daysInStage} of ${timelineText}</span>
                                        <span style="color: #000000; font-size: 0.75rem;">â€¢ ${lastActivityText}</span>
                                    </div>
                                    <div style="display: flex; gap: 6px;">
                                        <button onclick="moveToNext('${deal.id}', '${deal.stage}'); event.stopPropagation();" style="flex: 1; padding: 4px 8px; background: #05908C; border: 2px solid rgba(0, 0, 0, 0.75); border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: white;">Next</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // FULL VIEW - Show all details when only one deal
                        html += `
                            <div class="deal-card" id="deal-${deal.id}" draggable="true" ondragstart="handleDragStart(event, '${deal.id}')" ondragend="handleDragEnd(event)" style="background: linear-gradient(135deg, #FFFFFF 0%, #EEF4D9 100%); border-radius: 10px; padding: 14px; margin-bottom: 12px; border-left: 4px solid #F2A922; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); border: 2px solid rgba(0, 0, 0, 0.75); position: relative; cursor: move;">
                                <!-- Edit & Delete Controls -->
                                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 6px;">
                                    <button onclick="openEditDeal('${deal.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #EEF4D9; border: 2px solid rgba(0, 0, 0, 0.75); border-radius: 4px; font-size: 0.7rem; cursor: pointer; color: #012E40; font-weight: 600;" title="Edit deal">Edit</button>
                                    <button onclick="confirmLostDeal('${deal.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #fef2f2; border: 2px solid rgba(0, 0, 0, 0.75); border-radius: 4px; font-size: 0.7rem; cursor: pointer; color: #000000; font-weight: 600;" title="Mark as lost">Lost</button>
                                </div>

                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; padding-right: 120px;">
                                    <div style="font-weight: 700; color: #012E40;">${deal.companyName || 'Unnamed Deal'}</div>
                                    ${isStalling ? '<span style="background: #fee2e2; color: #dc2626; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">STALLING</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: #64748B; margin-bottom: 4px;">${deal.contactName || 'No contact'}</div>
                                ${deal.website ? `<div style="font-size: 0.8rem; color: #05908C; margin-bottom: 8px;"><a href="${deal.website.startsWith('http') ? deal.website : 'https://' + deal.website}" target="_blank" style="color: #05908C; text-decoration: none;">${deal.website}</a></div>` : '<div style="font-size: 0.8rem; color: #9ca3af; margin-bottom: 8px;">No website</div>'}

                                <!-- Quick Stage Change -->
                                <div style="margin-bottom: 8px;">
                                    <select onchange="changeStage('${deal.id}', this.value); event.stopPropagation();" style="width: 100%; padding: 6px 8px; border: 2px solid rgba(0, 0, 0, 0.75); border-radius: 4px; font-size: 0.8rem; background: #FFFFFF; cursor: pointer; color: #012E40;">
                                        <option value="" disabled selected>Move to stage...</option>
                                        <option value="qualified" ${deal.stage === 'qualified' ? 'disabled' : ''}>Qualified</option>
                                        <option value="cold-outreach" ${deal.stage === 'cold-outreach' ? 'disabled' : ''}>Cold Outreach</option>
                                        <option value="follow-up" ${deal.stage === 'follow-up' ? 'disabled' : ''}>Follow-Up</option>
                                        <option value="discovery-scheduled" ${deal.stage === 'discovery-scheduled' ? 'disabled' : ''}>Discovery Scheduled</option>
                                    </select>
                                </div>

                                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                                    <span style="background: ${statusBg}; color: ${statusColor}; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${statusText}</span>
                                    <span style="color: #000000; font-size: 0.75rem;">${daysInStage} of ${timelineText}</span>
                                    <span style="color: #000000; font-size: 0.75rem;">â€¢ Last: ${lastActivityText}</span>
                                </div>
                                ${deal.attachments && deal.attachments.length > 0 ? `
                                    <div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 255, 255, 0.6); border-radius: 6px;">
                                        <div style="font-size: 0.75rem; color: #64748B; margin-bottom: 4px; font-weight: 600;">ðŸ“Ž Attachments (${deal.attachments.length})</div>
                                        ${deal.attachments.map((url, idx) => {
                                            const fileName = decodeURIComponent(url.split('/').pop().split('?')[0]).replace(/^\d+_/, '');
                                            return `<a href="${url}" target="_blank" onclick="event.stopPropagation();" style="display: block; color: #05908C; font-size: 0.75rem; margin-top: 2px; text-decoration: none;">â€¢ ${fileName}</a>`;
                                        }).join('')}
                                    </div>
                                ` : ''}
                                <div style="display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #EEF4D9;">
                                    <button onclick="moveToNext('${deal.id}', '${deal.stage}'); event.stopPropagation();" style="flex: 1; padding: 4px 8px; background: #05908C; border: 2px solid rgba(0, 0, 0, 0.75); border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: white;">Next</button>
                                </div>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            pipelineBoard.innerHTML = html;
        }

        // Tab 2: This Week
        async function loadThisWeek() {
            console.log('Loading This Week tab...');
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            // Calculate current week dates
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            // Format dates
            const options = { month: 'short', day: 'numeric' };
            const mondayStr = monday.toLocaleDateString('en-US', options);
            const sundayStr = sunday.toLocaleDateString('en-US', options);
            document.getElementById('weekDates').textContent = `Week of ${mondayStr} - ${sundayStr}`;

            // Calculate days left
            const daysLeft = Math.max(0, Math.ceil((sunday - today) / (1000 * 60 * 60 * 24)));
            document.getElementById('daysLeft').textContent = daysLeft;

            // Get week identifier (e.g., "2025-W14")
            const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;

            try {
                // Load rep's weekly targets
                console.log('Loading rep data for repId:', repId);
                const repDoc = await db.collection('salesReps').doc(repId).get();

                if (!repDoc.exists) {
                    throw new Error('Rep document not found');
                }

                const repData = repDoc.data();
                console.log('Rep data loaded:', repData);

                // Load scorecard for this week
                console.log('Loading scorecard for:', `${repId}_${weekId}`);
                const scorecardRef = db.collection('scorecard').doc(`${repId}_${weekId}`);
                const scorecardDoc = await scorecardRef.get();

                let scorecard = {
                    discoveryScheduled: 0,
                    discoveryCompleted: 0,
                    dealsToOnboarding: 0,
                    dealsLive: 0
                };

                if (scorecardDoc.exists) {
                    scorecard = scorecardDoc.data();
                    console.log('Scorecard loaded:', scorecard);
                } else {
                    console.log('No scorecard exists for this week, using defaults');
                }

                // Render metrics
                renderWeeklyMetrics(scorecard);
            } catch (error) {
                console.error('Error loading weekly metrics:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                document.getElementById('weeklyMetrics').innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 12px; grid-column: 1/-1;"><p style="color: #d32f2f;">Error loading metrics: ' + error.message + '</p></div>';
            }
        }

        // Helper: Get week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Render weekly metrics (no targets - results only)
        function renderWeeklyMetrics(scorecard) {
            const metrics = [
                { id: 'discoveryScheduled', label: 'Discovery Scheduled', actual: scorecard.discoveryScheduled || 0, color: '#F2A922' },
                { id: 'discoveryCompleted', label: 'Discovery Completed', actual: scorecard.discoveryCompleted || 0, color: '#F2A922' },
                { id: 'dealsToOnboarding', label: 'To Onboarding', actual: scorecard.dealsToOnboarding || 0, color: '#05908C' },
                { id: 'dealsLive', label: 'Gone Live', actual: scorecard.dealsLive || 0, color: '#05908C' }
            ];

            let html = '';
            metrics.forEach(metric => {
                html += `
                    <div style="background: linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%); border-radius: 8px; padding: 20px; border: 2px solid ${metric.color}; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06); text-align: center;">
                        <div style="font-size: 0.75rem; color: #000000; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 16px; font-family: 'Bitter', serif;">${metric.label}</div>
                        <div style="font-size: 3rem; font-weight: 700; color: ${metric.color}; font-family: 'Bitter', serif; line-height: 1;">${metric.actual}</div>
                    </div>
                `;
            });

            document.getElementById('weeklyMetrics').innerHTML = html;

            // Also render weekly results
            renderActivityTracker(scorecard);
        }

        // Render weekly results (no targets, admin-controlled only)
        function renderActivityTracker(scorecard) {
            const activities = [
                { id: 'discoveryScheduled', label: 'Discovery Scheduled', actual: scorecard.discoveryScheduled || 0, color: '#F2A922', bgGradient: 'linear-gradient(135deg, #F2A922 0%, #f59e0b 100%)' },
                { id: 'discoveryCompleted', label: 'Discovery Completed', actual: scorecard.discoveryCompleted || 0, color: '#F2A922', bgGradient: 'linear-gradient(135deg, #F2A922 0%, #f59e0b 100%)' },
                { id: 'dealsToOnboarding', label: 'To Onboarding', actual: scorecard.dealsToOnboarding || 0, color: '#05908C', bgGradient: 'linear-gradient(135deg, #05908C 0%, #85C7B3 100%)' },
                { id: 'dealsLive', label: 'Gone Live', actual: scorecard.dealsLive || 0, color: '#05908C', bgGradient: 'linear-gradient(135deg, #05908C 0%, #85C7B3 100%)' }
            ];

            let html = '';
            activities.forEach(activity => {
                html += `
                    <div style="background: linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%); border-radius: 12px; padding: 24px; border: 2px solid ${activity.color}; box-shadow: 0 4px 8px rgba(0,0,0,0.08); text-align: center;">
                        <!-- Header -->
                        <div style="margin-bottom: 20px;">
                            <h4 style="font-size: 0.85rem; font-weight: 700; color: #000000; font-family: 'Bitter', serif; text-transform: uppercase; letter-spacing: 0.5px; margin: 0 0 12px 0;">${activity.label}</h4>
                            <div style="height: 3px; width: 50px; background: ${activity.bgGradient}; border-radius: 2px; margin: 0 auto;"></div>
                        </div>

                        <!-- Count Display -->
                        <div style="font-size: 4rem; font-weight: 700; color: ${activity.color}; font-family: 'Bitter', serif; line-height: 1;">${activity.actual}</div>
                        <div style="font-size: 0.75rem; color: #64748B; text-transform: uppercase; letter-spacing: 1px; margin-top: 8px; font-weight: 600;">This Week</div>
                    </div>
                `;
            });

            document.getElementById('activityTrackerGrid').innerHTML = html;
        }

        // No quick adjust - admin controls all metrics now

        // Tab 3: Leaderboard
        async function loadTeamLeaderboard() {
            console.log('Loading Team tab...');
            const currentRepId = sessionStorage.getItem('repId');
            if (!currentRepId) return;

            // Calculate current week
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            // Format dates
            const options = { month: 'short', day: 'numeric' };
            const mondayStr = monday.toLocaleDateString('en-US', options);
            const sundayStr = sunday.toLocaleDateString('en-US', options);
            document.getElementById('teamWeekDates').textContent = `Week of ${mondayStr} - ${sundayStr}`;

            const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;

            try {
                // Load all active sales reps
                const repsSnapshot = await db.collection('salesReps')
                    .where('active', '==', true)
                    .get();

                const teamData = [];

                // Load scorecard for each rep
                for (const repDoc of repsSnapshot.docs) {
                    const repData = repDoc.data();

                    // Skip admin users from leaderboard
                    if (repData.role === 'admin') {
                        continue;
                    }

                    const scorecardDoc = await db.collection('scorecard')
                        .doc(`${repDoc.id}_${weekId}`)
                        .get();

                    let scorecard = {
                        discoveryScheduled: 0,
                        discoveryCompleted: 0,
                        dealsToOnboarding: 0,
                        dealsLive: 0
                    };

                    if (scorecardDoc.exists) {
                        scorecard = scorecardDoc.data();
                    }

                    // Calculate total points (activity + results)
                    const totalPoints =
                        (scorecard.callsMade || 0) * 0.1 +         // 0.1 pt per call
                        (scorecard.emailsSent || 0) * 0.1 +        // 0.1 pt per email
                        (scorecard.discoveryScheduled || 0) * 3 +  // 3 pts per scheduled
                        (scorecard.discoveryCompleted || 0) * 5 +  // 5 pts per completed
                        (scorecard.dealsToOnboarding || 0) * 10 +  // 10 pts to onboarding
                        (scorecard.dealsLive || 0) * 20;           // 20 pts gone live

                    teamData.push({
                        id: repDoc.id,
                        name: repData.name,
                        scorecard: scorecard,
                        totalPoints: totalPoints
                    });
                }

                // Sort by total points (descending)
                teamData.sort((a, b) => b.totalPoints - a.totalPoints);

                // Render leaderboard
                renderTeamLeaderboard(teamData, currentRepId);

            } catch (error) {
                console.error('Error loading team leaderboard:', error);
                document.getElementById('teamLeaderboardBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px; color: #d32f2f;">Error loading leaderboard. Please refresh.</td></tr>';
            }
        }

        // Render team leaderboard
        function renderTeamLeaderboard(teamData, currentRepId) {
            let html = '';
            let currentUserRank = 0;
            let firstPlacePoints = teamData.length > 0 ? teamData[0].totalPoints : 0;
            let currentUserPoints = 0;

            teamData.forEach((rep, index) => {
                const rank = index + 1;
                const isCurrentUser = rep.id === currentRepId;

                if (isCurrentUser) {
                    currentUserRank = rank;
                    currentUserPoints = rep.totalPoints;
                }

                // Rank badge styling
                let rankBadge = '';
                if (rank === 1) {
                    rankBadge = '<span style="font-size: 1.2rem; font-weight: 700; color: #0EA5E9;">#1</span>';
                } else if (rank === 2) {
                    rankBadge = '<span style="font-size: 1.2rem; font-weight: 700; color: #64748B;">#2</span>';
                } else if (rank === 3) {
                    rankBadge = '<span style="font-size: 1.2rem; font-weight: 700; color: #64748B;">#3</span>';
                } else {
                    rankBadge = `<span style="color: #64748B; font-weight: 600;">#${rank}</span>`;
                }

                const rowStyle = isCurrentUser
                    ? 'background: #F8FAFC; border-left: 4px solid #0EA5E9; font-weight: 600;'
                    : '';

                html += `
                    <tr style="${rowStyle}">
                        <td style="text-align: center;">${rankBadge}</td>
                        <td>${rep.name}${isCurrentUser ? ' <span style="color: #0EA5E9; font-size: 0.75rem;">(You)</span>' : ''}</td>
                        <td style="text-align: center;">${rep.scorecard.discoveryCompleted || 0}</td>
                        <td style="text-align: center;">${rep.scorecard.dealsToOnboarding || 0}</td>
                        <td style="text-align: center;">${rep.scorecard.dealsLive || 0}</td>
                        <td style="text-align: center; font-weight: 700;">${Math.round(rep.totalPoints)}</td>
                    </tr>
                `;
            });

            document.getElementById('teamLeaderboardBody').innerHTML = html;

            // Update rank display
            if (currentUserRank === 1) {
                document.getElementById('yourRankDisplay').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: 700; color: #0EA5E9;">#1</div>
                    <div style="font-size: 0.85rem; color: #64748B;">You're #1!</div>
                `;
            } else {
                document.getElementById('yourRankDisplay').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: 700; color: #0F172A;">#${currentUserRank}</div>
                    <div style="font-size: 0.85rem; color: #64748B;">Your rank</div>
                `;
            }

            // Show gap to first place if not winning
            const gapDiv = document.getElementById('gapToFirst');
            if (currentUserRank > 1) {
                const gap = firstPlacePoints - currentUserPoints;
                document.getElementById('gapText').textContent = `${gap} points behind #1`;
                gapDiv.style.display = 'block';
            } else {
                gapDiv.style.display = 'none';
            }
        }

        // Tab 4: Tasks
        async function loadActionItems() {
            console.log('Loading Tasks tab...');
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            try {
                // Load all deals for this rep
                const snapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .get();

                const actionItems = [];
                const stuckDeals = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                snapshot.forEach(doc => {
                    const data = doc.data();

                    // Skip completed or closed deals
                    if (data.stage === 'completed' || data.stage === 'closed-lost') return;

                    // Generate action items based on stage and last activity
                    const lastUpdated = data.lastUpdated?.toDate() || data.createdAt?.toDate() || new Date();
                    const daysSinceUpdate = Math.floor((today - lastUpdated) / (1000 * 60 * 60 * 24));

                    let actionText = '';
                    let dueDate = new Date(lastUpdated);

                    // Stage-specific action items
                    if (data.stage === 'qualified' || data.stage === 'cold-outreach') {
                        actionText = `Reach out to ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 2); // Due 2 days after last update
                    } else if (data.stage === 'follow-up') {
                        actionText = `Follow up with ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 3);
                    } else if (data.stage === 'discovery-scheduled') {
                        actionText = `Discovery call with ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 1);
                    } else if (data.stage === 'discovery-completed') {
                        actionText = `Send proposal to ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 1);
                    } else if (data.stage === 'onboarding-portal') {
                        actionText = `Check onboarding progress for ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 7);
                    } else if (data.stage === 'campaign-live') {
                        actionText = `Weekly check-in with ${data.companyName || 'client'}`;
                        dueDate.setDate(dueDate.getDate() + 7);
                    } else if (data.stage === 'follow-up-resell') {
                        actionText = `Upsell opportunity with ${data.companyName || 'client'}`;
                        dueDate.setDate(dueDate.getDate() + 14);
                    }

                    // Check if deal is stuck (>7 days in stage)
                    if (daysSinceUpdate > 7) {
                        stuckDeals.push({
                            id: doc.id,
                            companyName: data.companyName,
                            stage: data.stage,
                            daysStuck: daysSinceUpdate
                        });
                    }

                    if (actionText) {
                        actionItems.push({
                            id: doc.id,
                            text: actionText,
                            companyName: data.companyName,
                            stage: data.stage,
                            dueDate: dueDate,
                            dealData: data
                        });
                    }
                });

                // Categorize action items
                const overdue = [];
                const dueToday = [];
                const upcoming = [];

                actionItems.forEach(item => {
                    const itemDate = new Date(item.dueDate);
                    itemDate.setHours(0, 0, 0, 0);

                    if (itemDate < today) {
                        overdue.push(item);
                    } else if (itemDate.getTime() === today.getTime()) {
                        dueToday.push(item);
                    } else {
                        upcoming.push(item);
                    }
                });

                // Sort by due date
                overdue.sort((a, b) => a.dueDate - b.dueDate);
                dueToday.sort((a, b) => a.dueDate - b.dueDate);
                upcoming.sort((a, b) => a.dueDate - b.dueDate);

                // Render action items
                renderActionItems(stuckDeals, overdue, dueToday, upcoming);

            } catch (error) {
                console.error('Error loading action items:', error);
            }
        }

        // Render action items
        function renderActionItems(stuckDeals, overdue, dueToday, upcoming) {
            // Update counts
            document.getElementById('stuckDealsCount').textContent = stuckDeals.length;
            document.getElementById('overdueCount').textContent = overdue.length;
            document.getElementById('dueTodayCount').textContent = dueToday.length;
            document.getElementById('upcomingCount').textContent = upcoming.length;

            // Render stuck deals
            if (stuckDeals.length === 0) {
                document.getElementById('stuckDeals').innerHTML = '<p class="no-data" style="padding: 24px; text-align: center; color: #64748B; margin: 0;">No stuck deals - great job!</p>';
            } else {
                let html = '<div style="padding: 16px;">';
                stuckDeals.forEach(deal => {
                    const stageNames = {
                        'qualified': 'Qualified',
                        'cold-outreach': 'Cold Outreach',
                        'follow-up': 'Follow-Up',
                        'discovery-scheduled': 'Discovery Scheduled',
                        'discovery-completed': 'Discovery Completed',
                        'onboarding-portal': 'Onboarding Portal',
                        'campaign-live': 'Campaign Live',
                        'follow-up-resell': 'Follow-Up & Resell'
                    };

                    html += `
                        <div style="padding: 12px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #0F172A; margin-bottom: 4px;">${deal.companyName || 'Unnamed Deal'}</div>
                                <div style="font-size: 0.85rem; color: #dc2626;">${deal.daysStuck} days in ${stageNames[deal.stage] || deal.stage}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="logActivity('${deal.id}', 'call'); event.stopPropagation();" style="padding: 6px 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 0.85rem; cursor: pointer; color: #0F172A;">Call</button>
                                <button onclick="moveToNext('${deal.id}', '${deal.stage}'); event.stopPropagation();" style="padding: 6px 12px; background: #0EA5E9; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer; color: white;">Next</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('stuckDeals').innerHTML = html;
            }

            // Render overdue
            if (overdue.length === 0) {
                document.getElementById('overdueTasks').innerHTML = '<p class="no-data" style="padding: 24px; text-align: center; color: #64748B; margin: 0;">No overdue items</p>';
            } else {
                let html = '<div style="padding: 16px;">';
                overdue.forEach(item => {
                    const daysOverdue = Math.floor((new Date() - item.dueDate) / (1000 * 60 * 60 * 24));
                    const stageNames = {
                        'qualified': 'Qualified',
                        'cold-outreach': 'Cold Outreach',
                        'follow-up': 'Follow-Up',
                        'discovery-scheduled': 'Discovery Scheduled',
                        'discovery-completed': 'Discovery Completed',
                        'onboarding-portal': 'Onboarding',
                        'campaign-live': 'Live',
                        'follow-up-resell': 'Resell'
                    };
                    const stageName = stageNames[item.stage] || item.stage;
                    html += `
                        <div style="padding: 14px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-weight: 700; color: #0F172A; font-size: 1rem;">${item.companyName || 'Unnamed Deal'}</span>
                                    <span style="background: #F2A922; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${stageName}</span>
                                </div>
                                <div style="font-weight: 500; color: #64748B; margin-bottom: 4px; font-size: 0.9rem;">${item.text}</div>
                                <div style="font-size: 0.85rem; color: #dc2626; font-weight: 600;">${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} overdue</div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem; background: #10b981; color: white; border: none; font-weight: 600;" onclick="markDone('${item.id}')">âœ“ Complete</button>
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem;" onclick="snoozeTask('${item.id}')">Snooze</button>
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem; background: #05908C; color: white; border: none; font-weight: 600;" onclick="viewDeal('${item.id}')">â†’ View Deal</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('overdueTasks').innerHTML = html;
            }

            // Render due today
            if (dueToday.length === 0) {
                document.getElementById('dueTodayTasks').innerHTML = '<p class="no-data" style="padding: 24px; text-align: center; color: #64748B; margin: 0;">No tasks due today</p>';
            } else {
                let html = '<div style="padding: 16px;">';
                dueToday.forEach(item => {
                    const stageNames = {
                        'qualified': 'Qualified',
                        'cold-outreach': 'Cold Outreach',
                        'follow-up': 'Follow-Up',
                        'discovery-scheduled': 'Discovery Scheduled',
                        'discovery-completed': 'Discovery Completed',
                        'onboarding-portal': 'Onboarding',
                        'campaign-live': 'Live',
                        'follow-up-resell': 'Resell'
                    };
                    const stageName = stageNames[item.stage] || item.stage;
                    html += `
                        <div style="padding: 14px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-weight: 700; color: #0F172A; font-size: 1rem;">${item.companyName || 'Unnamed Deal'}</span>
                                    <span style="background: #F2A922; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${stageName}</span>
                                </div>
                                <div style="font-weight: 500; color: #64748B; margin-bottom: 4px; font-size: 0.9rem;">${item.text}</div>
                                <div style="font-size: 0.85rem; color: #f59e0b; font-weight: 600;">Due today</div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem; background: #10b981; color: white; border: none; font-weight: 600;" onclick="markDone('${item.id}')">âœ“ Complete</button>
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem;" onclick="snoozeTask('${item.id}')">Snooze</button>
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem; background: #05908C; color: white; border: none; font-weight: 600;" onclick="viewDeal('${item.id}')">â†’ View Deal</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('dueTodayTasks').innerHTML = html;
            }

            // Render upcoming (limit to 10)
            if (upcoming.length === 0) {
                document.getElementById('upcomingTasks').innerHTML = '<p class="no-data" style="padding: 24px; text-align: center; color: #64748B; margin: 0;">No upcoming tasks</p>';
            } else {
                let html = '<div style="padding: 16px;">';
                upcoming.slice(0, 10).forEach(item => {
                    const dueDate = item.dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const stageNames = {
                        'qualified': 'Qualified',
                        'cold-outreach': 'Cold Outreach',
                        'follow-up': 'Follow-Up',
                        'discovery-scheduled': 'Discovery Scheduled',
                        'discovery-completed': 'Discovery Completed',
                        'onboarding-portal': 'Onboarding',
                        'campaign-live': 'Live',
                        'follow-up-resell': 'Resell'
                    };
                    const stageName = stageNames[item.stage] || item.stage;
                    html += `
                        <div style="padding: 14px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-weight: 700; color: #0F172A; font-size: 1rem;">${item.companyName || 'Unnamed Deal'}</span>
                                    <span style="background: #F2A922; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${stageName}</span>
                                </div>
                                <div style="font-weight: 500; color: #64748B; margin-bottom: 4px; font-size: 0.9rem;">${item.text}</div>
                                <div style="font-size: 0.85rem; color: #64748B;">Due ${dueDate}</div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem; background: #10b981; color: white; border: none; font-weight: 600;" onclick="markDone('${item.id}')">âœ“ Complete</button>
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem;" onclick="snoozeTask('${item.id}')">Snooze</button>
                                <button class="btn btn-outline" style="padding: 8px 14px; font-size: 0.85rem; background: #05908C; color: white; border: none; font-weight: 600;" onclick="viewDeal('${item.id}')">â†’ View Deal</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('upcomingTasks').innerHTML = html;
            }
        }

        // Mark task as done
        async function markDone(dealId) {
            try {
                await db.collection('deals').doc(dealId).update({
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show feedback
                event.target.textContent = 'Done!';
                event.target.style.background = '#0EA5E9';
                event.target.style.borderColor = '#0EA5E9';
                event.target.style.color = 'white';

                setTimeout(() => {
                    loadActionItems();
                }, 1000);
            } catch (error) {
                console.error('Error marking task done:', error);
                alert('Error updating task. Please try again.');
            }
        }

        // View deal - switches to My Deals tab and scrolls to deal
        function viewDeal(dealId) {
            // Switch to My Deals tab
            switchTab('deals');

            // Wait for tab to load, then scroll to deal card
            setTimeout(() => {
                const dealCard = document.querySelector(`[data-deal-id="${dealId}"]`);
                if (dealCard) {
                    dealCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Add highlight animation
                    dealCard.style.boxShadow = '0 0 0 3px #F2A922';
                    setTimeout(() => {
                        dealCard.style.boxShadow = '';
                    }, 2000);
                }
            }, 300);
        }

        // Snooze task
        async function snoozeTask(dealId) {
            const days = prompt('Snooze for how many days?', '3');
            if (!days) return;

            try {
                const newDate = new Date();
                newDate.setDate(newDate.getDate() + parseInt(days));

                await db.collection('deals').doc(dealId).update({
                    lastUpdated: firebase.firestore.Timestamp.fromDate(newDate)
                });

                // Show feedback
                event.target.textContent = `Snoozed ${days}d`;
                event.target.style.background = '#64748B';
                event.target.style.borderColor = '#64748B';
                event.target.style.color = 'white';

                setTimeout(() => {
                    loadActionItems();
                }, 1000);
            } catch (error) {
                console.error('Error snoozing task:', error);
                alert('Error snoozing task. Please try again.');
            }
        }

        // Tab 5: Archived Deals
        async function loadArchivedDeals() {
            console.log('Loading Archived Deals tab...');
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            try {
                // Load archived deals for this rep
                const archivedSnapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .where('archived', '==', true)
                    .orderBy('archivedAt', 'desc')
                    .get();

                const stageNames = {
                    'qualified': 'Qualified',
                    'cold-outreach': 'Cold Outreach',
                    'follow-up': 'Follow-Up',
                    'discovery-scheduled': 'Discovery Scheduled',
                    'discovery-completed': 'Discovery Completed',
                    'proposal-sent': 'Proposal Sent',
                    'negotiation': 'Negotiation',
                    'onboarding': 'Onboarding',
                    'campaign-live': 'Campaign Live'
                };

                if (archivedSnapshot.empty) {
                    document.getElementById('archivedDealsBody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 24px; color: #64748B;">No archived deals</td></tr>';
                    return;
                }

                let html = '';
                archivedSnapshot.forEach(doc => {
                    const data = doc.data();
                    const archivedDate = data.archivedAt ? data.archivedAt.toDate().toLocaleDateString() : 'N/A';
                    const stageWhenLost = stageNames[data.stageWhenLost] || data.stageWhenLost || 'Unknown';

                    html += `
                        <tr>
                            <td>${data.companyName || 'Unnamed'}</td>
                            <td>${data.contactName || 'N/A'}</td>
                            <td>${stageWhenLost}</td>
                            <td>${archivedDate}</td>
                        </tr>
                    `;
                });

                document.getElementById('archivedDealsBody').innerHTML = html;
            } catch (error) {
                console.error('Error loading archived deals:', error);
                document.getElementById('archivedDealsBody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 24px; color: #d32f2f;">Error loading archived deals. Please refresh.</td></tr>';
            }
        }

        // Quick log activity
        async function quickLog(type, event) {
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            // Calculate current week
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;

            const scorecardRef = db.collection('scorecard').doc(`${repId}_${weekId}`);

            try {
                // Map activity type to scorecard field
                const fieldMap = {
                    'call': 'callsMade',
                    'email': 'emailsSent',
                    'discovery-scheduled': 'discoveryScheduled',
                    'discovery-completed': 'discoveryCompleted',
                    'onboarding': 'dealsToOnboarding',
                    'live': 'dealsLive'
                };

                const field = fieldMap[type];
                if (!field) return;

                // Increment the field
                await scorecardRef.update({
                    [field]: firebase.firestore.FieldValue.increment(1),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success feedback
                const buttonText = {
                    'discovery-scheduled': 'Discovery Scheduled',
                    'discovery-completed': 'Discovery Completed',
                    'onboarding': 'To Onboarding',
                    'live': 'Gone Live'
                };

                // Quick visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Logged!';
                btn.style.background = '#0EA5E9';
                btn.style.borderColor = '#0EA5E9';
                btn.style.color = 'white';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }, 1500);

                // Reload the metrics to show updated values
                setTimeout(() => {
                    loadThisWeek();
                }, 500);

            } catch (error) {
                console.error('Error logging activity:', error);
                alert('Error logging activity. Please try again.');
            }
        }

        // Quick action functions for deal cards
        async function logActivity(dealId, activityType) {
            try {
                // Update deal's lastUpdated timestamp
                await db.collection('deals').doc(dealId).update({
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Log activity in scorecard (if tracking calls/emails)
                const repId = sessionStorage.getItem('repId');
                const today = new Date();
                const monday = new Date(today);
                monday.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
                const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;
                const scorecardRef = db.collection('scorecard').doc(`${repId}_${weekId}`);

                if (activityType === 'call') {
                    await scorecardRef.update({
                        callsMade: firebase.firestore.FieldValue.increment(1),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else if (activityType === 'email') {
                    await scorecardRef.update({
                        emailsSent: firebase.firestore.FieldValue.increment(1),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Show success feedback
                const msg = activityType === 'call' ? 'Call logged!' : 'Email logged!';
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Refresh pipeline to update "last activity"
                loadMyPipeline();
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        async function moveToNext(dealId, currentStage) {
            const stages = [
                'qualified', 'cold-outreach', 'follow-up', 'discovery-scheduled',
                'discovery-completed', 'onboarding-portal', 'campaign-live', 'follow-up-resell'
            ];

            const currentIndex = stages.indexOf(currentStage);
            if (currentIndex === -1 || currentIndex === stages.length - 1) return;

            const nextStage = stages[currentIndex + 1];

            try {
                await db.collection('deals').doc(dealId).update({
                    stage: nextStage,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                toast.textContent = 'Deal moved to next stage!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Refresh pipeline
                loadMyPipeline();
            } catch (error) {
                console.error('Error moving deal:', error);
            }
        }

        // Quick change stage from dropdown
        async function changeStage(dealId, newStage) {
            if (!newStage) return;

            // Reps can only move deals to first 4 stages
            const allowedStages = ['qualified', 'cold-outreach', 'follow-up', 'discovery-scheduled'];
            if (!allowedStages.includes(newStage)) {
                alert('You can only move deals to: Qualified, Cold Outreach, Follow-Up, or Discovery Scheduled. Later stages are admin-controlled.');
                return;
            }

            try {
                await db.collection('deals').doc(dealId).update({
                    stage: newStage,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                toast.textContent = 'Stage updated!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Refresh pipeline
                loadMyPipeline();
            } catch (error) {
                console.error('Error changing stage:', error);
                alert('Error updating stage. Please try again.');
            }
        }

        // Open edit deal modal
        async function openEditDeal(dealId) {
            try {
                const doc = await db.collection('deals').doc(dealId).get();
                if (!doc.exists) {
                    alert('Deal not found');
                    return;
                }

                const deal = doc.data();

                // Update modal title and button
                document.getElementById('dealModalTitle').textContent = 'Edit Deal';
                document.getElementById('dealSubmitBtn').textContent = 'Update Deal';

                // Fill form with deal data
                document.getElementById('dealId').value = dealId;
                document.getElementById('dealCompanyName').value = deal.companyName || '';
                document.getElementById('dealContactName').value = deal.contactName || '';
                document.getElementById('dealWebsite').value = deal.website || '';
                document.getElementById('dealEmail').value = deal.email || '';
                document.getElementById('dealPhone').value = deal.phone || '';
                document.getElementById('dealStage').value = deal.stage || 'qualified';

                // Display existing attachments
                const attachmentsList = document.getElementById('attachmentsList');
                if (deal.attachments && deal.attachments.length > 0) {
                    attachmentsList.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 4px;">Existing files:</div>
                        ${deal.attachments.map((url, idx) => {
                            const fileName = decodeURIComponent(url.split('/').pop().split('?')[0]).replace(/^\d+_/, '');
                            return `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <a href="${url}" target="_blank" style="color: #05908C; text-decoration: none; flex: 1;">ðŸ“Ž ${fileName}</a>
                                <button type="button" onclick="removeAttachment('${dealId}', ${idx})" style="padding: 2px 6px; background: #fef2f2; border: 1px solid #dc2626; border-radius: 4px; font-size: 0.7rem; color: #dc2626; cursor: pointer;">Remove</button>
                            </div>`;
                        }).join('')}
                    `;
                } else {
                    attachmentsList.innerHTML = '';
                }

                // Show modal
                document.getElementById('dealModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading deal:', error);
                alert('Error loading deal. Please try again.');
            }
        }

        // Mark deal as lost with confirmation
        async function confirmLostDeal(dealId) {
            if (!confirm('Mark this deal as LOST? This will archive the deal.')) return;

            try {
                // Get current stage before archiving
                const dealDoc = await db.collection('deals').doc(dealId).get();
                const currentStage = dealDoc.data().stage;

                await db.collection('deals').doc(dealId).update({
                    stageWhenLost: currentStage,  // Save the stage when it was lost
                    stage: 'closed-lost',
                    archived: true,
                    archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #05908C; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                toast.textContent = 'Deal marked as lost and archived';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Refresh pipeline
                loadMyPipeline();
            } catch (error) {
                console.error('Error archiving deal:', error);
                alert('Error archiving deal. Please try again.');
            }
        }

        // Toggle expand/collapse for compressed cards
        function toggleExpandCard(dealId, event) {
            if (event.target.tagName === 'BUTTON' || event.target.tagName === 'SELECT') {
                return; // Don't toggle if clicking on buttons or select
            }

            const card = document.getElementById('deal-' + dealId);
            if (!card) return;

            const detailsDiv = card.querySelector('.card-details');
            if (detailsDiv) {
                const isExpanded = detailsDiv.style.display !== 'none';
                detailsDiv.style.display = isExpanded ? 'none' : 'block';
                card.style.background = isExpanded ? 'linear-gradient(135deg, #EEF4D9 0%, #FFFFFF 100%)' : 'linear-gradient(135deg, #FFFFFF 0%, #EEF4D9 100%)';
            }
        }

        // Drag and Drop Variables
        let draggedDealId = null;

        function handleDragStart(event, dealId) {
            draggedDealId = dealId;
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
        }

        function handleDragEnd(event) {
            event.target.style.opacity = '1';
        }

        function handleDragOver(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';

            // Highlight the drop zone
            const column = event.currentTarget;
            if (column.classList.contains('stage-column')) {
                column.style.background = 'linear-gradient(180deg, rgba(242, 169, 34, 0.2) 0%, rgba(238, 244, 217, 0.6) 100%)';
                column.style.borderColor = '#F2A922';
                column.style.boxShadow = '0 8px 20px rgba(242, 169, 34, 0.3)';
            }

            return false;
        }

        function handleDragLeave(event) {
            const column = event.currentTarget;
            if (column.classList.contains('stage-column')) {
                column.style.background = 'linear-gradient(180deg, rgba(238, 244, 217, 0.4) 0%, rgba(255, 255, 255, 0.8) 100%)';
                column.style.borderColor = '#85C7B3';
                column.style.boxShadow = '0 4px 12px rgba(1, 46, 64, 0.1)';
            }
        }

        async function handleDrop(event, targetStage) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }

            // Reset column styling
            const column = event.currentTarget;
            column.style.background = 'linear-gradient(180deg, rgba(238, 244, 217, 0.4) 0%, rgba(255, 255, 255, 0.8) 100%)';
            column.style.borderColor = '#85C7B3';
            column.style.boxShadow = '0 4px 12px rgba(1, 46, 64, 0.1)';

            if (!draggedDealId) return false;

            // Reps can only move deals to first 4 stages
            const allowedStages = ['qualified', 'cold-outreach', 'follow-up', 'discovery-scheduled'];
            if (!allowedStages.includes(targetStage)) {
                alert('You can only move deals to: Qualified, Cold Outreach, Follow-Up, or Discovery Scheduled. Later stages are admin-controlled.');
                return false;
            }

            // Update the deal stage in Firestore
            try {
                await db.collection('deals').doc(draggedDealId).update({
                    stage: targetStage,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success toast
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #05908C; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(1, 46, 64, 0.12);';
                toast.textContent = 'Deal moved successfully!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Reload pipeline
                loadMyPipeline();
            } catch (error) {
                console.error('Error moving deal:', error);
                alert('Error moving deal. Please try again.');
            }

            draggedDealId = null;
            return false;
        }

        // Deal Modal Functions
        function openNewDealModal() {
            // Reset for new deal
            document.getElementById('dealModalTitle').textContent = 'Add New Deal';
            document.getElementById('dealSubmitBtn').textContent = 'Create Deal';
            document.getElementById('dealId').value = '';
            document.getElementById('dealForm').reset();
            document.getElementById('attachmentsList').innerHTML = '';
            document.getElementById('dealModal').style.display = 'flex';
        }

        function closeDealModal() {
            document.getElementById('dealModal').style.display = 'none';
        }

        // Remove attachment from deal
        async function removeAttachment(dealId, attachmentIndex) {
            if (!confirm('Remove this attachment?')) return;

            try {
                const doc = await db.collection('deals').doc(dealId).get();
                const deal = doc.data();
                const attachments = deal.attachments || [];

                // Remove the attachment at the specified index
                attachments.splice(attachmentIndex, 1);

                // Update the deal
                await db.collection('deals').doc(dealId).update({ attachments });

                // Refresh the edit modal
                openEditDeal(dealId);
            } catch (error) {
                console.error('Error removing attachment:', error);
                alert('Error removing attachment. Please try again.');
            }
        }

        // Handle deal form submission (create or update)
        document.getElementById('dealForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const repId = sessionStorage.getItem('repId');
            const dealId = document.getElementById('dealId').value;

            const dealData = {
                companyName: document.getElementById('dealCompanyName').value,
                contactName: document.getElementById('dealContactName').value || null,
                website: document.getElementById('dealWebsite').value || null,
                email: document.getElementById('dealEmail').value || null,
                phone: document.getElementById('dealPhone').value || null,
                stage: document.getElementById('dealStage').value,
                assignedTo: repId,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // Handle file uploads
                const fileInput = document.getElementById('dealAttachments');
                const files = fileInput.files;
                const attachmentURLs = [];

                if (files.length > 0) {
                    const uploadPromises = [];
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const timestamp = Date.now();
                        const fileName = `${timestamp}_${file.name}`;
                        const storageRef = storage.ref(`deal-attachments/${repId}/${fileName}`);
                        uploadPromises.push(
                            storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
                        );
                    }
                    const uploadedURLs = await Promise.all(uploadPromises);
                    attachmentURLs.push(...uploadedURLs);
                }

                // Add attachments to dealData (merge with existing if editing)
                if (dealId) {
                    const existingDeal = await db.collection('deals').doc(dealId).get();
                    const existingAttachments = existingDeal.data().attachments || [];
                    dealData.attachments = [...existingAttachments, ...attachmentURLs];
                } else {
                    dealData.attachments = attachmentURLs;
                }

                if (dealId) {
                    // Update existing deal
                    await db.collection('deals').doc(dealId).update(dealData);

                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 16px 24px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                    successDiv.textContent = 'Deal updated successfully!';
                    document.body.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 3000);
                } else {
                    // Create new deal
                    dealData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('deals').add(dealData);

                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 16px 24px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                    successDiv.textContent = 'Deal created successfully!';
                    document.body.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 3000);
                }

                closeDealModal();
                loadMyPipeline(); // Refresh pipeline
            } catch (error) {
                console.error('Error saving deal:', error);
                alert('Error saving deal. Please try again.');
            }
        });

        // Edit Targets Functions (REMOVED)
        async function openEditTargetsModal() {
            // Weekly targets feature removed
            return;
        }

        function closeTargetsModal() {
            // Weekly targets feature removed
            return;
        }
    </script>

    <!-- Footer -->
    <footer style="background: #012E40; padding: 32px 0; margin-top: 60px;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 32px; margin-bottom: 24px;">
                <!-- Quick Links -->
                <div>
                    <h4 style="color: #F2A922; font-size: 0.75rem; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Quick Links</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 8px;">
                            <a href="faq.html" style="color: #85C7B3; text-decoration: none; font-size: 0.875rem; transition: color 0.15s;">FAQ</a>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <a href="resources.html" style="color: #85C7B3; text-decoration: none; font-size: 0.875rem; transition: color 0.15s;">Resources</a>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <a href="archived.html" style="color: #85C7B3; text-decoration: none; font-size: 0.875rem; transition: color 0.15s;">Archived Deals</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div>
                    <h4 style="color: #F2A922; font-size: 0.75rem; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Support</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 8px;">
                            <a href="mailto:support@driveleadmedia.com" style="color: #85C7B3; text-decoration: none; font-size: 0.875rem; transition: color 0.15s;">Contact Support</a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Copyright -->
            <div style="text-align: center; padding-top: 24px; border-top: 1px solid #85C7B3;">
                <p style="color: #EEF4D9; font-size: 0.75rem; margin: 0;">Â© 2025 Drive Lead Media. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
