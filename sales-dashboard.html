<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - Drive Lead Media</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Young+Serif:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="sales-styles.css">
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>Drive Lead Media</h1>
            <p class="welcome-text">Welcome back, <span id="repNameDisplay">Loading...</span></p>
        </div>
        <div class="header-right">
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="deals" onclick="switchTab('deals')">
            My Deals
        </button>
        <button class="nav-tab" data-tab="week" onclick="switchTab('week')">
            This Week
        </button>
        <button class="nav-tab" data-tab="team" onclick="switchTab('team')">
            Team
        </button>
        <button class="nav-tab" data-tab="actions" onclick="switchTab('actions')">
            Action Items
        </button>
    </div>

    <!-- Main Content Container -->
    <div class="dashboard-container">

        <!-- Tab 1: My Deals -->
        <div class="tab-content active" id="tab-deals">
            <!-- Pipeline Value & Filter -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                <div>
                    <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 4px;">Total Pipeline Value</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #000;" id="totalPipelineValue">$0</div>
                    <div style="font-size: 0.85rem; color: #6b7280; margin-top: 4px;"><span id="totalDealsCount">0</span> active deals</div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <input type="checkbox" id="filterActionNeeded" onchange="loadMyPipeline()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 0.9rem; font-weight: 600; color: #012E40;">Action needed today</span>
                    </label>
                    <button class="btn btn-primary" onclick="openNewDealModal()">+ New Deal</button>
                </div>
            </div>

            <div class="pipeline-board" id="pipelineBoard">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading your deals...</p>
                </div>
            </div>
        </div>

        <!-- Tab 2: This Week -->
        <div class="tab-content" id="tab-week">
            <!-- Week Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="margin-bottom: 4px;">This Week's Progress</h2>
                    <p style="color: #6b7280; font-size: 0.9rem; margin: 0;" id="weekDates">Loading...</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 2rem; font-weight: 700; color: #000;" id="daysLeft">0</div>
                    <div style="font-size: 0.85rem; color: #6b7280;">days left</div>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div id="weeklyMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Metrics will be loaded here -->
                <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; grid-column: 1/-1;">
                    <div class="spinner"></div>
                    <p>Loading your weekly metrics...</p>
                </div>
            </div>

            <!-- Quick Log Buttons -->
            <div style="background: white; padding: 24px; border-radius: 12px; border: 1px solid #e5e7eb;">
                <h3 style="font-size: 1rem; font-weight: 600; color: #012E40; margin-bottom: 16px;">Quick Log Activity</h3>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="quickLog('discovery-scheduled')">âœ“ Discovery Scheduled</button>
                    <button class="btn btn-outline" onclick="quickLog('discovery-completed')">âœ“ Discovery Completed</button>
                    <button class="btn btn-outline" onclick="quickLog('onboarding')">âœ“ To Onboarding</button>
                    <button class="btn btn-outline" onclick="quickLog('live')">âœ“ Gone Live</button>
                </div>
            </div>
        </div>

        <!-- Tab 3: Team -->
        <div class="tab-content" id="tab-team">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="margin-bottom: 4px;">Team Leaderboard</h2>
                    <p style="color: #6b7280; font-size: 0.9rem; margin: 0;" id="teamWeekDates">Week of Loading...</p>
                </div>
                <div style="text-align: right;" id="yourRankDisplay">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #000;">â€”</div>
                    <div style="font-size: 0.85rem; color: #6b7280;">Your rank</div>
                </div>
            </div>

            <div class="team-leaderboard">
                <table class="scorecard-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Rank</th>
                            <th>Rep Name</th>
                            <th>Disc Sched</th>
                            <th>Disc Comp</th>
                            <th>Onboarding</th>
                            <th>Gone Live</th>
                            <th>Total Points</th>
                        </tr>
                    </thead>
                    <tbody id="teamLeaderboardBody">
                        <tr>
                            <td colspan="7" class="loading-cell">Loading team data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #05908C;" id="gapToFirst" style="display: none;">
                <p style="margin: 0; font-size: 0.9rem; color: #012E40;"><strong>Gap to #1:</strong> <span id="gapText">â€”</span></p>
            </div>
        </div>

        <!-- Tab 4: Action Items -->
        <div class="tab-content" id="tab-actions">
            <div style="margin-bottom: 24px;">
                <h2 style="margin-bottom: 4px;">Action Items</h2>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">What needs your attention right now</p>
            </div>

            <!-- Overdue -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #dc2626; margin: 0;">ðŸ”´ Overdue</h3>
                    <span id="overdueCount" style="background: #dc2626; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="overdueTasks" style="background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #9ca3af;">No overdue items</p>
                </div>
            </div>

            <!-- Due Today -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #f59e0b; margin: 0;">ðŸŸ¡ Due Today</h3>
                    <span id="dueTodayCount" style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="dueTodayTasks" style="background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #9ca3af;">No tasks due today</p>
                </div>
            </div>

            <!-- Upcoming -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #6b7280; margin: 0;">âšª Upcoming</h3>
                    <span id="upcomingCount" style="background: #6b7280; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="upcomingTasks" style="background: white; border-radius: 12px; border: 1px solid #e5e7eb; max-height: 400px; overflow-y: auto;">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #9ca3af;">No upcoming tasks</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Configuration -->
    <script src="config.js"></script>

    <!-- Main Functions -->
    <script src="sales-functions.js"></script>

    <script>
        // CRITICAL SECURITY: Check Firebase Authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Verify Firebase Authentication
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) {
                    // Not authenticated - redirect to login
                    console.warn('Unauthorized access attempt to sales dashboard');
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                    return;
                }

                // User is authenticated - verify they are a sales rep
                try {
                    const repDoc = await db.collection('salesReps').doc(user.uid).get();
                    if (!repDoc.exists) {
                        console.error('User is not a sales rep');
                        await firebase.auth().signOut();
                        sessionStorage.clear();
                        window.location.href = 'index.html';
                        return;
                    }

                    const repData = repDoc.data();

                    // Store rep info in session for quick access
                    sessionStorage.setItem('repAuthenticated', 'true');
                    sessionStorage.setItem('repId', user.uid);
                    sessionStorage.setItem('repName', repData.name);
                    sessionStorage.setItem('repRole', repData.role);

                    // Load rep name in header
                    document.getElementById('repNameDisplay').textContent = repData.name || 'Rep';

                    // Initialize dashboard
                    initializeDashboard();
                } catch (error) {
                    console.error('Error verifying rep:', error);
                    await firebase.auth().signOut();
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
            });
        });

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await firebase.auth().signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'deals') {
                loadMyPipeline();
            } else if (tabName === 'week') {
                loadThisWeek();
            } else if (tabName === 'team') {
                loadTeamLeaderboard();
            } else if (tabName === 'actions') {
                loadActionItems();
            }
        }

        // Initialize dashboard (load default tab)
        async function initializeDashboard() {
            // Load initial data for the active tab (My Deals)
            await loadMyPipeline();
        }

        // Load My Pipeline
        async function loadMyPipeline() {
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            const pipelineBoard = document.getElementById('pipelineBoard');
            pipelineBoard.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading your deals...</p></div>';

            try {
                // Load deals assigned to this rep
                const snapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .get();

                const deals = [];
                let totalValue = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Only show active deals (not completed or closed-lost)
                    if (data.stage !== 'completed' && data.stage !== 'closed-lost') {
                        deals.push({ id: doc.id, ...data });
                        // Calculate total pipeline value (MRR * contract length)
                        if (data.mrr && data.contractLength) {
                            totalValue += (data.mrr * data.contractLength);
                        }
                    }
                });

                // Update pipeline value display
                document.getElementById('totalPipelineValue').textContent = '$' + totalValue.toLocaleString();
                document.getElementById('totalDealsCount').textContent = deals.length;

                renderPipelineBoard(deals);
            } catch (error) {
                console.error('Error loading pipeline:', error);
                pipelineBoard.innerHTML = '<div class="loading-state"><p style="color: #d32f2f;">Error loading pipeline. Please refresh.</p></div>';
            }
        }

        // Render Pipeline Board
        function renderPipelineBoard(deals) {
            const pipelineBoard = document.getElementById('pipelineBoard');

            const stages = [
                { id: 'qualified', name: 'Qualified' },
                { id: 'cold-outreach', name: 'Cold Outreach' },
                { id: 'follow-up', name: 'Follow-Up' },
                { id: 'discovery-scheduled', name: 'Discovery Scheduled' },
                { id: 'discovery-completed', name: 'Discovery Completed' },
                { id: 'onboarding-portal', name: 'Onboarding Portal' },
                { id: 'campaign-live', name: 'Campaign Live' },
                { id: 'follow-up-resell', name: 'Follow-Up & Resell' }
            ];

            // Group deals by stage
            const dealsByStage = {};
            stages.forEach(stage => {
                dealsByStage[stage.id] = deals.filter(d => d.stage === stage.id);
            });

            // Render empty state if no deals
            if (deals.length === 0) {
                pipelineBoard.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;">ðŸ“Š</div>
                        <h3 style="color: #6b7280; font-weight: 500; margin-bottom: 8px;">No Deals Yet</h3>
                        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 20px;">Start tracking your sales pipeline by adding your first deal.</p>
                        <button class="btn btn-primary" onclick="openNewDealModal()">+ Add First Deal</button>
                    </div>
                `;
                return;
            }

            // Render pipeline columns
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">';

            stages.forEach(stage => {
                const stageDeals = dealsByStage[stage.id] || [];
                html += `
                    <div style="background: #f9fafb; border-radius: 12px; padding: 18px; min-height: 400px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #000;">
                            <h3 style="font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #333; margin: 0;">${stage.name}</h3>
                            <span style="background: #000; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;">${stageDeals.length}</span>
                        </div>
                        <div>
                `;

                stageDeals.forEach(deal => {
                    html += `
                        <div class="deal-card" style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 3px solid #000; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                            <div style="font-weight: 700; color: #012E40; margin-bottom: 4px;">${deal.companyName || 'Unnamed Deal'}</div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 8px;">${deal.contactName || 'No contact'}</div>
                            ${deal.mrr ? `<div style="font-size: 0.9rem; font-weight: 600; color: #05908C;">$${deal.mrr}/mo</div>` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            pipelineBoard.innerHTML = html;
        }

        // Tab 2: This Week
        async function loadThisWeek() {
            console.log('Loading This Week tab...');
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            // Calculate current week dates
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            // Format dates
            const options = { month: 'short', day: 'numeric' };
            const mondayStr = monday.toLocaleDateString('en-US', options);
            const sundayStr = sunday.toLocaleDateString('en-US', options);
            document.getElementById('weekDates').textContent = `Week of ${mondayStr} - ${sundayStr}`;

            // Calculate days left
            const daysLeft = Math.max(0, Math.ceil((sunday - today) / (1000 * 60 * 60 * 24)));
            document.getElementById('daysLeft').textContent = daysLeft;

            // Get week identifier (e.g., "2025-W14")
            const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;

            try {
                // Load rep's weekly targets
                const repDoc = await db.collection('salesReps').doc(repId).get();
                const repData = repDoc.data();

                // Load or create scorecard for this week
                const scorecardRef = db.collection('scorecard').doc(`${repId}_${weekId}`);
                const scorecardDoc = await scorecardRef.get();

                let scorecard = {
                    discoveryScheduled: 0,
                    discoveryCompleted: 0,
                    dealsToOnboarding: 0,
                    dealsLive: 0
                };

                if (scorecardDoc.exists) {
                    scorecard = scorecardDoc.data();
                } else {
                    // Create empty scorecard for this week
                    await scorecardRef.set({
                        repId: repId,
                        weekId: weekId,
                        discoveryScheduled: 0,
                        discoveryCompleted: 0,
                        dealsToOnboarding: 0,
                        dealsLive: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Render metrics
                renderWeeklyMetrics(scorecard, repData.weeklyTargets || {});
            } catch (error) {
                console.error('Error loading weekly metrics:', error);
                document.getElementById('weeklyMetrics').innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 12px; grid-column: 1/-1;"><p style="color: #d32f2f;">Error loading metrics. Please refresh.</p></div>';
            }
        }

        // Helper: Get week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Render weekly metrics
        function renderWeeklyMetrics(scorecard, targets) {
            const metrics = [
                {
                    id: 'discoveryScheduled',
                    label: 'Discovery Calls Scheduled',
                    actual: scorecard.discoveryScheduled || 0,
                    target: targets.discoveryScheduled || 0
                },
                {
                    id: 'discoveryCompleted',
                    label: 'Discovery Calls Completed',
                    actual: scorecard.discoveryCompleted || 0,
                    target: targets.discoveryCompleted || 0
                },
                {
                    id: 'dealsToOnboarding',
                    label: 'Deals to Onboarding',
                    actual: scorecard.dealsToOnboarding || 0,
                    target: targets.dealsToOnboarding || 0
                },
                {
                    id: 'dealsLive',
                    label: 'Deals Gone Live',
                    actual: scorecard.dealsLive || 0,
                    target: targets.dealsLive || 0
                }
            ];

            let html = '';
            metrics.forEach(metric => {
                const percentage = metric.target > 0 ? Math.min(100, (metric.actual / metric.target) * 100) : 0;

                // Color based on progress
                let statusColor = '#6b7280'; // gray (no target)
                let statusBg = '#f3f4f6';

                if (metric.target > 0) {
                    if (percentage >= 100) {
                        statusColor = '#059669'; // green (hit target)
                        statusBg = '#d1fae5';
                    } else if (percentage >= 70) {
                        statusColor = '#f59e0b'; // yellow (close)
                        statusBg = '#fef3c7';
                    } else {
                        statusColor = '#dc2626'; // red (behind)
                        statusBg = '#fee2e2';
                    }
                }

                const needMore = Math.max(0, metric.target - metric.actual);

                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px;">${metric.label}</div>
                        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                            <div style="font-size: 2rem; font-weight: 700; color: ${statusColor};">${metric.actual}</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">of ${metric.target}</div>
                        </div>

                        <!-- Progress Bar -->
                        <div style="background: #e5e7eb; border-radius: 8px; height: 8px; overflow: hidden; margin-bottom: 12px;">
                            <div style="background: ${statusColor}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                        </div>

                        <!-- Status Message -->
                        ${metric.target > 0 ? `
                            <div style="background: ${statusBg}; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; color: ${statusColor}; font-weight: 600;">
                                ${percentage >= 100
                                    ? 'âœ“ Target hit!'
                                    : `You need ${needMore} more to hit target`
                                }
                            </div>
                        ` : `
                            <div style="background: #f3f4f6; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; color: #6b7280;">
                                No target set
                            </div>
                        `}
                    </div>
                `;
            });

            document.getElementById('weeklyMetrics').innerHTML = html;
        }

        // Tab 3: Team
        function loadTeamLeaderboard() {
            console.log('Loading Team tab...');
            // Will be implemented
            document.getElementById('teamLeaderboardBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px; color: #9ca3af;">Team leaderboard - Coming soon!</td></tr>';
        }

        // Tab 4: Action Items
        function loadActionItems() {
            console.log('Loading Action Items tab...');
            // Will be implemented
        }

        // Quick log activity
        async function quickLog(type) {
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            // Calculate current week
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;

            const scorecardRef = db.collection('scorecard').doc(`${repId}_${weekId}`);

            try {
                // Map activity type to scorecard field
                const fieldMap = {
                    'discovery-scheduled': 'discoveryScheduled',
                    'discovery-completed': 'discoveryCompleted',
                    'onboarding': 'dealsToOnboarding',
                    'live': 'dealsLive'
                };

                const field = fieldMap[type];
                if (!field) return;

                // Increment the field
                await scorecardRef.update({
                    [field]: firebase.firestore.FieldValue.increment(1),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success feedback
                const buttonText = {
                    'discovery-scheduled': 'Discovery Scheduled',
                    'discovery-completed': 'Discovery Completed',
                    'onboarding': 'To Onboarding',
                    'live': 'Gone Live'
                };

                // Quick visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ Logged!';
                btn.style.background = '#059669';
                btn.style.borderColor = '#059669';
                btn.style.color = 'white';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }, 1500);

                // Reload the metrics to show updated values
                setTimeout(() => {
                    loadThisWeek();
                }, 500);

            } catch (error) {
                console.error('Error logging activity:', error);
                alert('Error logging activity. Please try again.');
            }
        }

        // Modals
        function openNewDealModal() {
            alert('Add New Deal - Coming soon! Admin can create deals in the Sales CRM tab for now.');
        }
    </script>
</body>
</html>
