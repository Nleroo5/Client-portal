<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - Drive Lead Media</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Young+Serif:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="sales-styles.css">
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>Drive Lead Media</h1>
            <p class="welcome-text">Welcome back, <span id="repNameDisplay">Loading...</span></p>
        </div>
        <div class="header-right">
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="pipeline" onclick="switchTab('pipeline')">
            My Pipeline
        </button>
        <button class="nav-tab" data-tab="scorecard" onclick="switchTab('scorecard')">
            My Scorecard
        </button>
        <button class="nav-tab" data-tab="team" onclick="switchTab('team')">
            Team
        </button>
        <button class="nav-tab" data-tab="tasks" onclick="switchTab('tasks')">
            Tasks
        </button>
    </div>

    <!-- Main Content Container -->
    <div class="dashboard-container">

        <!-- Tab 1: My Pipeline -->
        <div class="tab-content active" id="tab-pipeline">
            <div class="section-header">
                <div>
                    <h2 style="margin-bottom: 4px;">My Pipeline</h2>
                    <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Track your active deals across all stages</p>
                </div>
                <button class="btn btn-primary" onclick="openNewDealModal()">+ New Deal</button>
            </div>

            <div class="pipeline-board" id="pipelineBoard">
                <!-- Pipeline columns will be dynamically loaded here -->
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading your pipeline...</p>
                </div>
            </div>
        </div>

        <!-- Tab 2: My Scorecard -->
        <div class="tab-content" id="tab-scorecard">
            <div class="section-header">
                <div>
                    <h2 style="margin-bottom: 4px;">My Scorecard - This Week</h2>
                    <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Monitor your weekly performance metrics</p>
                </div>
                <button class="btn btn-secondary" onclick="openLogActivityModal()">+ Log Activity</button>
            </div>

            <div class="scorecard-widget">
                <table class="scorecard-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Target</th>
                            <th>Actual</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="scorecardTableBody">
                        <tr>
                            <td colspan="4" class="loading-cell">Loading scorecard...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="activity-log-section">
                <h3 style="color: #012E40; margin-bottom: 16px; font-size: 1rem; font-weight: 600;">Recent Activities</h3>
                <div id="recentActivities">
                    <p class="no-data">No activities logged yet.</p>
                </div>
            </div>
        </div>

        <!-- Tab 3: Team Performance -->
        <div class="tab-content" id="tab-team">
            <div class="section-header">
                <div>
                    <h2 style="margin-bottom: 4px;">Team Performance</h2>
                    <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Compare your performance with team members</p>
                </div>
                <div class="week-indicator" id="weekIndicator" style="color: #05908C; font-weight: 600; font-size: 0.95rem;">Week of Loading...</div>
            </div>

            <div class="team-leaderboard">
                <table class="scorecard-table">
                    <thead>
                        <tr>
                            <th>Rep Name</th>
                            <th>Disc Scheduled</th>
                            <th>Disc Completed</th>
                            <th>Onboarding</th>
                            <th>Gone Live</th>
                        </tr>
                    </thead>
                    <tbody id="teamLeaderboardBody">
                        <tr>
                            <td colspan="5" class="loading-cell">Loading team data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="team-pipeline-section">
                <h3 style="color: #012E40; margin-bottom: 16px; font-size: 1rem; font-weight: 600;">Team Pipeline Overview</h3>
                <div id="teamPipelineStats">
                    <p class="no-data">Loading team pipeline...</p>
                </div>
                <button class="btn btn-outline" onclick="viewAllTeamDeals()">View All Team Deals</button>
            </div>
        </div>

        <!-- Tab 4: Tasks -->
        <div class="tab-content" id="tab-tasks">
            <div class="section-header">
                <div>
                    <h2 style="margin-bottom: 4px;">My Tasks</h2>
                    <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Track your action items and follow-ups</p>
                </div>
            </div>

            <div class="tasks-container">
                <div class="task-section">
                    <h3 class="task-section-title overdue" style="font-size: 1rem; font-weight: 600;">Overdue (<span id="overdueCount">0</span>)</h3>
                    <div id="overdueTasks" class="task-list">
                        <p class="no-data">No overdue tasks</p>
                    </div>
                </div>

                <div class="task-section">
                    <h3 class="task-section-title due-today" style="font-size: 1rem; font-weight: 600;">Due Today (<span id="dueTodayCount">0</span>)</h3>
                    <div id="dueTodayTasks" class="task-list">
                        <p class="no-data">No tasks due today</p>
                    </div>
                </div>

                <div class="task-section">
                    <h3 class="task-section-title upcoming" style="font-size: 1rem; font-weight: 600;">Upcoming (<span id="upcomingCount">0</span>)</h3>
                    <div id="upcomingTasks" class="task-list">
                        <p class="no-data">No upcoming tasks</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Configuration -->
    <script src="config.js"></script>

    <!-- Main Functions -->
    <script src="sales-functions.js"></script>

    <script>
        // CRITICAL SECURITY: Check Firebase Authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Verify Firebase Authentication
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) {
                    // Not authenticated - redirect to login
                    console.warn('Unauthorized access attempt to sales dashboard');
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                    return;
                }

                // User is authenticated - verify they are a sales rep
                try {
                    const repDoc = await db.collection('salesReps').doc(user.uid).get();
                    if (!repDoc.exists) {
                        console.error('User is not a sales rep');
                        await firebase.auth().signOut();
                        sessionStorage.clear();
                        window.location.href = 'index.html';
                        return;
                    }

                    const repData = repDoc.data();

                    // Store rep info in session for quick access
                    sessionStorage.setItem('repAuthenticated', 'true');
                    sessionStorage.setItem('repId', user.uid);
                    sessionStorage.setItem('repName', repData.name);
                    sessionStorage.setItem('repRole', repData.role);

                    // Load rep name in header
                    document.getElementById('repNameDisplay').textContent = repData.name || 'Rep';

                    // Initialize dashboard
                    initializeDashboard();
                } catch (error) {
                    console.error('Error verifying rep:', error);
                    await firebase.auth().signOut();
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
            });
        });

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await firebase.auth().signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load tab-specific data
            loadTabData(tabName);
        }

        // Load tab-specific data
        function loadTabData(tabName) {
            switch(tabName) {
                case 'pipeline':
                    loadMyPipeline();
                    break;
                case 'scorecard':
                    loadMyScorecard();
                    break;
                case 'team':
                    loadTeamData();
                    break;
                case 'tasks':
                    loadMyTasks();
                    break;
            }
        }

        // Initialize dashboard (load default tab)
        async function initializeDashboard() {
            // Load initial data for the active tab (Pipeline)
            await loadMyPipeline();
        }

        // Load My Pipeline
        async function loadMyPipeline() {
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            const pipelineBoard = document.getElementById('pipelineBoard');
            pipelineBoard.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading your pipeline...</p></div>';

            try {
                // Load deals assigned to this rep
                const snapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .get();

                const deals = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Only show active deals (not completed or closed-lost)
                    if (data.stage !== 'completed' && data.stage !== 'closed-lost') {
                        deals.push({ id: doc.id, ...data });
                    }
                });

                renderPipelineBoard(deals);
            } catch (error) {
                console.error('Error loading pipeline:', error);
                pipelineBoard.innerHTML = '<div class="loading-state"><p style="color: #d32f2f;">Error loading pipeline. Please refresh.</p></div>';
            }
        }

        // Render Pipeline Board
        function renderPipelineBoard(deals) {
            const pipelineBoard = document.getElementById('pipelineBoard');

            const stages = [
                { id: 'qualified', name: 'Qualified' },
                { id: 'cold-outreach', name: 'Cold Outreach' },
                { id: 'follow-up', name: 'Follow-Up' },
                { id: 'discovery-scheduled', name: 'Discovery Scheduled' },
                { id: 'discovery-completed', name: 'Discovery Completed' },
                { id: 'onboarding-portal', name: 'Onboarding Portal' },
                { id: 'campaign-live', name: 'Campaign Live' },
                { id: 'follow-up-resell', name: 'Follow-Up & Resell' }
            ];

            // Group deals by stage
            const dealsByStage = {};
            stages.forEach(stage => {
                dealsByStage[stage.id] = deals.filter(d => d.stage === stage.id);
            });

            // Render empty state if no deals
            if (deals.length === 0) {
                pipelineBoard.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;">📊</div>
                        <h3 style="color: #6b7280; font-weight: 500; margin-bottom: 8px;">No Deals Yet</h3>
                        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 20px;">Start tracking your sales pipeline by adding your first deal.</p>
                        <button class="btn btn-primary" onclick="openNewDealModal()">+ Add First Deal</button>
                    </div>
                `;
                return;
            }

            // Render pipeline columns
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">';

            stages.forEach(stage => {
                const stageDeals = dealsByStage[stage.id] || [];
                html += `
                    <div style="background: #f9fafb; border-radius: 12px; padding: 18px; min-height: 400px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #000;">
                            <h3 style="font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #333; margin: 0;">${stage.name}</h3>
                            <span style="background: #000; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;">${stageDeals.length}</span>
                        </div>
                        <div>
                `;

                stageDeals.forEach(deal => {
                    html += `
                        <div class="deal-card" style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 3px solid #000; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                            <div style="font-weight: 700; color: #012E40; margin-bottom: 4px;">${deal.companyName || 'Unnamed Deal'}</div>
                            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 8px;">${deal.contactName || 'No contact'}</div>
                            ${deal.mrr ? `<div style="font-size: 0.9rem; font-weight: 600; color: #05908C;">$${deal.mrr}/mo</div>` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            pipelineBoard.innerHTML = html;
        }

        function openNewDealModal() {
            alert('Add New Deal - Coming soon! This feature will be implemented next.');
        }

        function openLogActivityModal() {
            alert('Log Activity - Coming soon!');
        }

        function viewAllTeamDeals() {
            alert('Team Deals View - Coming soon!');
        }
    </script>
</body>
</html>
