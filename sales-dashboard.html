<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - Drive Lead Media</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Young+Serif:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="sales-styles.css?v=3.0">
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>Drive Lead Media</h1>
            <p class="welcome-text">Welcome back, <span id="repNameDisplay">Loading...</span></p>
        </div>
        <div class="header-right">
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="deals" onclick="switchTab('deals')">
            My Deals
        </button>
        <button class="nav-tab" data-tab="week" onclick="switchTab('week')">
            This Week
        </button>
        <button class="nav-tab" data-tab="team" onclick="switchTab('team')">
            Team
        </button>
        <button class="nav-tab" data-tab="actions" onclick="switchTab('actions')">
            Action Items
        </button>
    </div>

    <!-- Main Content Container -->
    <div class="dashboard-container">

        <!-- Tab 1: My Deals -->
        <div class="tab-content active" id="tab-deals">
            <!-- Focus Zone -->
            <div id="focusZone" style="background: #FFFFFF; padding: 20px; border-radius: 8px; margin-bottom: 20px; color: #0F172A; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06); border: 1px solid #E2E8F0;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: #0F172A;">
                    Today's Focus
                </h3>
                <div id="focusItems" style="display: grid; gap: 10px;">
                    <div style="text-align: center; padding: 20px; opacity: 0.7; color: #64748B;">Loading priorities...</div>
                </div>
            </div>

            <!-- Pipeline Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: #FFFFFF; padding: 20px; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                <div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #0F172A;">My Pipeline</div>
                    <div style="font-size: 0.9rem; color: #64748B; margin-top: 4px;"><span id="totalDealsCount">0</span> active deals</div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 16px; background: #F8FAFC; border-radius: 6px; border: 1px solid #E2E8F0;">
                        <input type="checkbox" id="filterActionNeeded" onchange="loadMyPipeline()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 0.9rem; font-weight: 600; color: #0F172A;">Action needed today</span>
                    </label>
                    <button class="btn btn-primary" onclick="openNewDealModal()">+ New Deal</button>
                </div>
            </div>

            <div class="pipeline-board" id="pipelineBoard">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading your deals...</p>
                </div>
            </div>
        </div>

        <!-- Tab 2: This Week -->
        <div class="tab-content" id="tab-week">
            <!-- Week Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="margin-bottom: 4px; color: #0F172A;">This Week's Progress</h2>
                    <p style="color: #64748B; font-size: 0.9rem; margin: 0;" id="weekDates">Loading...</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 2rem; font-weight: 700; color: #0F172A;" id="daysLeft">0</div>
                    <div style="font-size: 0.85rem; color: #64748B;">days left</div>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div id="weeklyMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Metrics will be loaded here -->
                <div style="text-align: center; padding: 40px; background: #FFFFFF; border-radius: 8px; grid-column: 1/-1; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <div class="spinner"></div>
                    <p style="color: #64748B;">Loading your weekly metrics...</p>
                </div>
            </div>

            <!-- Edit Targets & Quick Log -->
            <div style="display: grid; gap: 20px; grid-template-columns: 1fr 1fr;">
                <!-- Edit Targets -->
                <div style="background: #FFFFFF; padding: 24px; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #0F172A; margin-bottom: 16px;">Weekly Targets</h3>
                    <button class="btn btn-primary" onclick="openEditTargetsModal()" style="width: 100%;">Edit My Targets</button>
                </div>

                <!-- Quick Log Buttons -->
                <div style="background: #FFFFFF; padding: 24px; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <h3 style="font-size: 1rem; font-weight: 600; color: #0F172A; margin-bottom: 16px;">Quick Log Activity</h3>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-outline" onclick="quickLog('call', event)">Call Made</button>
                        <button class="btn btn-outline" onclick="quickLog('email', event)">Email Sent</button>
                        <button class="btn btn-outline" onclick="quickLog('discovery-scheduled', event)">Discovery Scheduled</button>
                        <button class="btn btn-outline" onclick="quickLog('discovery-completed', event)">Discovery Completed</button>
                        <button class="btn btn-outline" onclick="quickLog('onboarding', event)">To Onboarding</button>
                        <button class="btn btn-outline" onclick="quickLog('live', event)">Gone Live</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Team -->
        <div class="tab-content" id="tab-team">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="margin-bottom: 4px; color: #0F172A;">Team Leaderboard</h2>
                    <p style="color: #64748B; font-size: 0.9rem; margin: 0;" id="teamWeekDates">Week of Loading...</p>
                </div>
                <div style="text-align: right;" id="yourRankDisplay">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #0F172A;">—</div>
                    <div style="font-size: 0.85rem; color: #64748B;">Your rank</div>
                </div>
            </div>

            <div class="team-leaderboard">
                <table class="scorecard-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Rank</th>
                            <th>Rep Name</th>
                            <th>Calls</th>
                            <th>Emails</th>
                            <th>Disc</th>
                            <th>Onboard</th>
                            <th>Live</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody id="teamLeaderboardBody">
                        <tr>
                            <td colspan="7" class="loading-cell">Loading team data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: #F8FAFC; border-radius: 8px; border-left: 4px solid #0EA5E9; display: none;" id="gapToFirst">
                <p style="margin: 0; font-size: 0.9rem; color: #0F172A;"><strong>Gap to #1:</strong> <span id="gapText">—</span></p>
            </div>
        </div>

        <!-- Tab 4: Action Items -->
        <div class="tab-content" id="tab-actions">
            <div style="margin-bottom: 24px;">
                <h2 style="margin-bottom: 4px; color: #0F172A;">Action Items</h2>
                <p style="color: #64748B; font-size: 0.9rem; margin: 0;">What needs your attention right now</p>
            </div>

            <!-- Stuck Deals (New Priority Section) -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #dc2626; margin: 0;">Stuck Deals (>7 Days)</h3>
                    <span id="stuckDealsCount" style="background: #dc2626; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="stuckDeals" style="background: #FFFFFF; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #64748B;">No stuck deals</p>
                </div>
            </div>

            <!-- Overdue -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #dc2626; margin: 0;">Overdue</h3>
                    <span id="overdueCount" style="background: #dc2626; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="overdueTasks" style="background: #FFFFFF; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #64748B;">No overdue items</p>
                </div>
            </div>

            <!-- Due Today -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #f59e0b; margin: 0;">Due Today</h3>
                    <span id="dueTodayCount" style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="dueTodayTasks" style="background: #FFFFFF; border-radius: 8px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #64748B;">No tasks due today</p>
                </div>
            </div>

            <!-- Upcoming -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #64748B; margin: 0;">Upcoming</h3>
                    <span id="upcomingCount" style="background: #64748B; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="upcomingTasks" style="background: #FFFFFF; border-radius: 8px; border: 1px solid #E2E8F0; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                    <p class="no-data" style="padding: 24px; text-align: center; color: #64748B;">No upcoming tasks</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Deal Modal -->
    <div id="dealModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #FFFFFF; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
            <div style="padding: 24px; border-bottom: 1px solid #E2E8F0;">
                <h2 id="dealModalTitle" style="margin: 0; color: #0F172A;">Add New Deal</h2>
            </div>
            <form id="dealForm" style="padding: 24px;">
                <input type="hidden" id="dealId" value="">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Company Name *</label>
                        <input type="text" id="dealCompanyName" required style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Contact Name</label>
                        <input type="text" id="dealContactName" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Email</label>
                            <input type="email" id="dealEmail" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Phone</label>
                            <input type="tel" id="dealPhone" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #0F172A;">Stage *</label>
                        <select id="dealStage" required style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.95rem; color: #0F172A;">
                            <option value="qualified">Qualified</option>
                            <option value="cold-outreach">Cold Outreach</option>
                            <option value="follow-up">Follow-Up</option>
                            <option value="discovery-scheduled">Discovery Scheduled</option>
                            <option value="discovery-completed">Discovery Completed</option>
                            <option value="onboarding-portal">Onboarding Portal</option>
                            <option value="campaign-live">Campaign Live</option>
                            <option value="follow-up-resell">Follow-Up & Resell</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 1px solid #E2E8F0;">
                    <button type="button" onclick="closeDealModal()" class="btn btn-outline" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="dealSubmitBtn">Create Deal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Targets Modal -->
    <div id="targetsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: #FFFFFF; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 0;">
            <div style="padding: 24px; border-bottom: 1px solid #E2E8F0;">
                <h2 style="margin: 0; color: #1E293B;">Edit Weekly Targets</h2>
                <p style="margin: 8px 0 0 0; color: #64748B; font-size: 0.875rem;">Set your personal weekly goals</p>
            </div>
            <form id="targetsForm" style="padding: 24px;">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #1E293B; font-size: 0.875rem;">Calls Made</label>
                        <input type="number" id="targetCallsMade" min="0" required style="width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #1E293B; font-size: 0.875rem;">Emails Sent</label>
                        <input type="number" id="targetEmailsSent" min="0" required style="width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #1E293B; font-size: 0.875rem;">Discovery Calls Scheduled</label>
                        <input type="number" id="targetDiscoveryScheduled" min="0" required style="width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #1E293B; font-size: 0.875rem;">Discovery Calls Completed</label>
                        <input type="number" id="targetDiscoveryCompleted" min="0" required style="width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #1E293B; font-size: 0.875rem;">Deals to Onboarding</label>
                        <input type="number" id="targetDealsToOnboarding" min="0" required style="width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #1E293B; font-size: 0.875rem;">Deals Gone Live</label>
                        <input type="number" id="targetDealsLive" min="0" required style="width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 0.875rem;">
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 1px solid #E2E8F0;">
                    <button type="button" onclick="closeTargetsModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Targets</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Configuration -->
    <script src="config.js"></script>

    <!-- Main Functions -->
    <script src="sales-functions.js"></script>

    <script>
        // CRITICAL SECURITY: Check Firebase Authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Verify Firebase Authentication
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) {
                    // Not authenticated - redirect to login
                    console.warn('Unauthorized access attempt to sales dashboard');
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                    return;
                }

                // User is authenticated - verify they are a sales rep
                try {
                    const repDoc = await db.collection('salesReps').doc(user.uid).get();
                    if (!repDoc.exists) {
                        console.error('User is not a sales rep');
                        await firebase.auth().signOut();
                        sessionStorage.clear();
                        window.location.href = 'index.html';
                        return;
                    }

                    const repData = repDoc.data();

                    // Store rep info in session for quick access
                    sessionStorage.setItem('repAuthenticated', 'true');
                    sessionStorage.setItem('repId', user.uid);
                    sessionStorage.setItem('repName', repData.name);
                    sessionStorage.setItem('repRole', repData.role);

                    // Load rep name in header
                    document.getElementById('repNameDisplay').textContent = repData.name || 'Rep';

                    // Initialize dashboard
                    initializeDashboard();
                } catch (error) {
                    console.error('Error verifying rep:', error);
                    await firebase.auth().signOut();
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                }
            });
        });

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await firebase.auth().signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load tab-specific data
            if (tabName === 'deals') {
                loadMyPipeline();
            } else if (tabName === 'week') {
                loadThisWeek();
            } else if (tabName === 'team') {
                loadTeamLeaderboard();
            } else if (tabName === 'actions') {
                loadActionItems();
            }
        }

        // Initialize dashboard (load default tab)
        async function initializeDashboard() {
            // Load initial data for the active tab (My Deals)
            await loadMyPipeline();
        }

        // Load Focus Zone (Today's priorities)
        async function loadFocusZone() {
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            try {
                const snapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .get();

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let overdue = 0;
                let discoveryToday = 0;
                let stuckDeals = 0;
                let quickWins = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.stage === 'completed' || data.stage === 'closed-lost') return;

                    const lastUpdated = data.lastUpdated?.toDate() || data.createdAt?.toDate() || new Date();
                    const daysInStage = Math.floor((today - lastUpdated) / (1000 * 60 * 60 * 24));

                    // Count overdue (>7 days in stage)
                    if (daysInStage > 7) stuckDeals++;

                    // Count discovery calls today
                    if (data.stage === 'discovery-scheduled') discoveryToday++;

                    // Quick wins (in onboarding or campaign-live)
                    if (data.stage === 'onboarding-portal' || data.stage === 'campaign-live') {
                        quickWins.push(data.companyName);
                    }
                });

                let html = '<div style="display: grid; gap: 8px;">';

                if (stuckDeals > 0) {
                    html += `<div style="background: #F8FAFC; padding: 12px; border-radius: 6px; border: 1px solid #E2E8F0; color: #0F172A;"><strong>${stuckDeals}</strong> stalled deal${stuckDeals !== 1 ? 's' : ''} (>7 days in stage)</div>`;
                }

                if (discoveryToday > 0) {
                    html += `<div style="background: #F8FAFC; padding: 12px; border-radius: 6px; border: 1px solid #E2E8F0; color: #0F172A;"><strong>${discoveryToday}</strong> discovery call${discoveryToday !== 1 ? 's' : ''} scheduled</div>`;
                }

                if (quickWins.length > 0) {
                    html += `<div style="background: #F8FAFC; padding: 12px; border-radius: 6px; border: 1px solid #E2E8F0; color: #0F172A;">Quick Win: <strong>${quickWins[0]}</strong> is ready to close!</div>`;
                }

                if (stuckDeals === 0 && discoveryToday === 0 && quickWins.length === 0) {
                    html = '<div style="text-align: center; padding: 12px; opacity: 0.8; color: #64748B;">You\'re all caught up! Add more deals to your pipeline.</div>';
                }

                html += '</div>';
                document.getElementById('focusItems').innerHTML = html;
            } catch (error) {
                console.error('Error loading focus zone:', error);
            }
        }

        // Load My Pipeline
        async function loadMyPipeline() {
            loadFocusZone(); // Also load focus zone
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            const pipelineBoard = document.getElementById('pipelineBoard');
            pipelineBoard.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading your deals...</p></div>';

            try {
                // Load deals assigned to this rep
                const snapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .get();

                const deals = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Only show active deals (not completed or closed-lost)
                    if (data.stage !== 'completed' && data.stage !== 'closed-lost') {
                        deals.push({ id: doc.id, ...data });
                    }
                });

                // Update deal count display
                document.getElementById('totalDealsCount').textContent = deals.length;

                renderPipelineBoard(deals);
            } catch (error) {
                console.error('Error loading pipeline:', error);
                pipelineBoard.innerHTML = '<div class="loading-state"><p style="color: #d32f2f;">Error loading pipeline. Please refresh.</p></div>';
            }
        }

        // Render Pipeline Board
        function renderPipelineBoard(deals) {
            const pipelineBoard = document.getElementById('pipelineBoard');

            const stages = [
                { id: 'qualified', name: 'Qualified' },
                { id: 'cold-outreach', name: 'Cold Outreach' },
                { id: 'follow-up', name: 'Follow-Up' },
                { id: 'discovery-scheduled', name: 'Discovery Scheduled' },
                { id: 'discovery-completed', name: 'Discovery Completed' },
                { id: 'onboarding-portal', name: 'Onboarding Portal' },
                { id: 'campaign-live', name: 'Campaign Live' },
                { id: 'follow-up-resell', name: 'Follow-Up & Resell' }
            ];

            // Group deals by stage
            const dealsByStage = {};
            stages.forEach(stage => {
                dealsByStage[stage.id] = deals.filter(d => d.stage === stage.id);
            });

            // Render empty state if no deals
            if (deals.length === 0) {
                pipelineBoard.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: #FFFFFF; border-radius: 8px; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                        <h3 style="color: #64748B; font-weight: 500; margin-bottom: 8px;">No Deals Yet</h3>
                        <p style="color: #64748B; font-size: 0.9rem; margin-bottom: 20px;">Start tracking your sales pipeline by adding your first deal.</p>
                        <button class="btn btn-primary" onclick="openNewDealModal()">+ Add First Deal</button>
                    </div>
                `;
                return;
            }

            // Render pipeline columns
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">';

            stages.forEach(stage => {
                const stageDeals = dealsByStage[stage.id] || [];
                html += `
                    <div style="background: #F8FAFC; border-radius: 8px; padding: 18px; min-height: 400px; border: 1px solid #E2E8F0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #0F172A;">
                            <h3 style="font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #0F172A; margin: 0;">${stage.name}</h3>
                            <span style="background: #0F172A; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;">${stageDeals.length}</span>
                        </div>
                        <div>
                `;

                stageDeals.forEach(deal => {
                    // Calculate days in stage
                    const lastUpdated = deal.lastUpdated?.toDate() || deal.createdAt?.toDate() || new Date();
                    const daysInStage = Math.floor((new Date() - lastUpdated) / (1000 * 60 * 60 * 24));

                    // Determine if stalling (>7 days in stage)
                    const isStalling = daysInStage > 7;
                    const stageColor = isStalling ? '#dc2626' : '#6b7280';

                    // Format last activity
                    const lastActivityText = daysInStage === 0 ? 'Today' :
                                           daysInStage === 1 ? 'Yesterday' :
                                           `${daysInStage} days ago`;

                    html += `
                        <div class="deal-card" style="background: #FFFFFF; border-radius: 6px; padding: 12px; margin-bottom: 12px; border-left: 3px solid #0EA5E9; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06); position: relative;">
                            <!-- Edit & Delete Controls -->
                            <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 6px;">
                                <button onclick="openEditDeal('${deal.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 0.7rem; cursor: pointer; color: #0F172A; font-weight: 600;" title="Edit deal">Edit</button>
                                <button onclick="archiveDeal('${deal.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; font-size: 0.7rem; cursor: pointer; color: #dc2626; font-weight: 600;" title="Archive deal">Archive</button>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; padding-right: 120px;">
                                <div style="font-weight: 700; color: #0F172A;">${deal.companyName || 'Unnamed Deal'}</div>
                                ${isStalling ? '<span style="background: #fee2e2; color: #dc2626; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">STALLING</span>' : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #64748B; margin-bottom: 8px;">${deal.contactName || 'No contact'}</div>

                            <!-- Quick Stage Change -->
                            <div style="margin-bottom: 8px;">
                                <select onchange="changeStage('${deal.id}', this.value); event.stopPropagation();" style="width: 100%; padding: 6px 8px; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 0.8rem; background: #F8FAFC; cursor: pointer; color: #0F172A;">
                                    <option value="" disabled selected>Move to stage...</option>
                                    <option value="qualified" ${deal.stage === 'qualified' ? 'disabled' : ''}>Qualified</option>
                                    <option value="cold-outreach" ${deal.stage === 'cold-outreach' ? 'disabled' : ''}>Cold Outreach</option>
                                    <option value="follow-up" ${deal.stage === 'follow-up' ? 'disabled' : ''}>Follow-Up</option>
                                    <option value="discovery-scheduled" ${deal.stage === 'discovery-scheduled' ? 'disabled' : ''}>Discovery Scheduled</option>
                                    <option value="discovery-completed" ${deal.stage === 'discovery-completed' ? 'disabled' : ''}>Discovery Completed</option>
                                    <option value="onboarding-portal" ${deal.stage === 'onboarding-portal' ? 'disabled' : ''}>Onboarding Portal</option>
                                    <option value="campaign-live" ${deal.stage === 'campaign-live' ? 'disabled' : ''}>Campaign Live</option>
                                    <option value="follow-up-resell" ${deal.stage === 'follow-up-resell' ? 'disabled' : ''}>Follow-Up & Resell</option>
                                </select>
                            </div>

                            <div style="display: flex; gap: 12px; font-size: 0.75rem;">
                                <span style="color: ${stageColor};">${daysInStage} days in stage</span>
                                <span style="color: #64748B;">Last: ${lastActivityText}</span>
                            </div>
                            <div style="display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #F8FAFC;">
                                <button onclick="logActivity('${deal.id}', 'call'); event.stopPropagation();" style="flex: 1; padding: 4px 8px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #0F172A;">Call</button>
                                <button onclick="logActivity('${deal.id}', 'email'); event.stopPropagation();" style="flex: 1; padding: 4px 8px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #0F172A;">Email</button>
                                <button onclick="moveToNext('${deal.id}', '${deal.stage}'); event.stopPropagation();" style="flex: 1; padding: 4px 8px; background: #0EA5E9; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: white;">Next</button>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            pipelineBoard.innerHTML = html;
        }

        // Tab 2: This Week
        async function loadThisWeek() {
            console.log('Loading This Week tab...');
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            // Calculate current week dates
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            // Format dates
            const options = { month: 'short', day: 'numeric' };
            const mondayStr = monday.toLocaleDateString('en-US', options);
            const sundayStr = sunday.toLocaleDateString('en-US', options);
            document.getElementById('weekDates').textContent = `Week of ${mondayStr} - ${sundayStr}`;

            // Calculate days left
            const daysLeft = Math.max(0, Math.ceil((sunday - today) / (1000 * 60 * 60 * 24)));
            document.getElementById('daysLeft').textContent = daysLeft;

            // Get week identifier (e.g., "2025-W14")
            const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;

            try {
                // Load rep's weekly targets
                const repDoc = await db.collection('salesReps').doc(repId).get();
                const repData = repDoc.data();

                // Load or create scorecard for this week
                const scorecardRef = db.collection('scorecard').doc(`${repId}_${weekId}`);
                const scorecardDoc = await scorecardRef.get();

                let scorecard = {
                    discoveryScheduled: 0,
                    discoveryCompleted: 0,
                    dealsToOnboarding: 0,
                    dealsLive: 0
                };

                if (scorecardDoc.exists) {
                    scorecard = scorecardDoc.data();
                } else {
                    // Create empty scorecard for this week
                    await scorecardRef.set({
                        repId: repId,
                        weekId: weekId,
                        discoveryScheduled: 0,
                        discoveryCompleted: 0,
                        dealsToOnboarding: 0,
                        dealsLive: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Render metrics
                renderWeeklyMetrics(scorecard, repData.weeklyTargets || {});
            } catch (error) {
                console.error('Error loading weekly metrics:', error);
                document.getElementById('weeklyMetrics').innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 12px; grid-column: 1/-1;"><p style="color: #d32f2f;">Error loading metrics. Please refresh.</p></div>';
            }
        }

        // Helper: Get week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Render weekly metrics
        function renderWeeklyMetrics(scorecard, targets) {
            const metrics = [
                {
                    id: 'callsMade',
                    label: 'Calls Made',
                    actual: scorecard.callsMade || 0,
                    target: targets.callsMade || 50
                },
                {
                    id: 'emailsSent',
                    label: 'Emails Sent',
                    actual: scorecard.emailsSent || 0,
                    target: targets.emailsSent || 30
                },
                {
                    id: 'discoveryScheduled',
                    label: 'Discovery Calls Scheduled',
                    actual: scorecard.discoveryScheduled || 0,
                    target: targets.discoveryScheduled || 0
                },
                {
                    id: 'discoveryCompleted',
                    label: 'Discovery Calls Completed',
                    actual: scorecard.discoveryCompleted || 0,
                    target: targets.discoveryCompleted || 0
                },
                {
                    id: 'dealsToOnboarding',
                    label: 'Deals to Onboarding',
                    actual: scorecard.dealsToOnboarding || 0,
                    target: targets.dealsToOnboarding || 0
                },
                {
                    id: 'dealsLive',
                    label: 'Deals Gone Live',
                    actual: scorecard.dealsLive || 0,
                    target: targets.dealsLive || 0
                }
            ];

            let html = '';
            metrics.forEach(metric => {
                const percentage = metric.target > 0 ? Math.min(100, (metric.actual / metric.target) * 100) : 0;

                // Color based on progress
                let statusColor = '#6b7280'; // gray (no target)
                let statusBg = '#f3f4f6';

                if (metric.target > 0) {
                    if (percentage >= 100) {
                        statusColor = '#10B981'; // green (hit target)
                        statusBg = '#d1fae5';
                    } else if (percentage >= 70) {
                        statusColor = '#f59e0b'; // yellow (close)
                        statusBg = '#fef3c7';
                    } else {
                        statusColor = '#dc2626'; // red (behind)
                        statusBg = '#fee2e2';
                    }
                }

                const needMore = Math.max(0, metric.target - metric.actual);

                html += `
                    <div style="background: #FFFFFF; border-radius: 8px; padding: 20px; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);">
                        <div style="font-size: 0.75rem; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px;">${metric.label}</div>
                        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px;">
                            <div style="font-size: 2rem; font-weight: 700; color: ${statusColor};">${metric.actual}</div>
                            <div style="font-size: 0.9rem; color: #64748B;">of ${metric.target}</div>
                        </div>

                        <!-- Progress Bar -->
                        <div style="background: #E2E8F0; border-radius: 6px; height: 8px; overflow: hidden; margin-bottom: 12px;">
                            <div style="background: ${statusColor}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                        </div>

                        <!-- Status Message -->
                        ${metric.target > 0 ? `
                            <div style="background: ${statusBg}; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; color: ${statusColor}; font-weight: 600;">
                                ${percentage >= 100
                                    ? 'Target hit!'
                                    : `You need ${needMore} more to hit target`
                                }
                            </div>
                        ` : `
                            <div style="background: #F8FAFC; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; color: #64748B;">
                                No target set
                            </div>
                        `}
                    </div>
                `;
            });

            document.getElementById('weeklyMetrics').innerHTML = html;
        }

        // Tab 3: Team
        async function loadTeamLeaderboard() {
            console.log('Loading Team tab...');
            const currentRepId = sessionStorage.getItem('repId');
            if (!currentRepId) return;

            // Calculate current week
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            // Format dates
            const options = { month: 'short', day: 'numeric' };
            const mondayStr = monday.toLocaleDateString('en-US', options);
            const sundayStr = sunday.toLocaleDateString('en-US', options);
            document.getElementById('teamWeekDates').textContent = `Week of ${mondayStr} - ${sundayStr}`;

            const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;

            try {
                // Load all active sales reps
                const repsSnapshot = await db.collection('salesReps')
                    .where('active', '==', true)
                    .get();

                const teamData = [];

                // Load scorecard for each rep
                for (const repDoc of repsSnapshot.docs) {
                    const repData = repDoc.data();
                    const scorecardDoc = await db.collection('scorecard')
                        .doc(`${repDoc.id}_${weekId}`)
                        .get();

                    let scorecard = {
                        discoveryScheduled: 0,
                        discoveryCompleted: 0,
                        dealsToOnboarding: 0,
                        dealsLive: 0
                    };

                    if (scorecardDoc.exists) {
                        scorecard = scorecardDoc.data();
                    }

                    // Calculate total points (activity + results)
                    const totalPoints =
                        (scorecard.callsMade || 0) * 0.1 +         // 0.1 pt per call
                        (scorecard.emailsSent || 0) * 0.1 +        // 0.1 pt per email
                        (scorecard.discoveryScheduled || 0) * 3 +  // 3 pts per scheduled
                        (scorecard.discoveryCompleted || 0) * 5 +  // 5 pts per completed
                        (scorecard.dealsToOnboarding || 0) * 10 +  // 10 pts to onboarding
                        (scorecard.dealsLive || 0) * 20;           // 20 pts gone live

                    teamData.push({
                        id: repDoc.id,
                        name: repData.name,
                        scorecard: scorecard,
                        totalPoints: totalPoints
                    });
                }

                // Sort by total points (descending)
                teamData.sort((a, b) => b.totalPoints - a.totalPoints);

                // Render leaderboard
                renderTeamLeaderboard(teamData, currentRepId);

            } catch (error) {
                console.error('Error loading team leaderboard:', error);
                document.getElementById('teamLeaderboardBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px; color: #d32f2f;">Error loading leaderboard. Please refresh.</td></tr>';
            }
        }

        // Render team leaderboard
        function renderTeamLeaderboard(teamData, currentRepId) {
            let html = '';
            let currentUserRank = 0;
            let firstPlacePoints = teamData.length > 0 ? teamData[0].totalPoints : 0;
            let currentUserPoints = 0;

            teamData.forEach((rep, index) => {
                const rank = index + 1;
                const isCurrentUser = rep.id === currentRepId;

                if (isCurrentUser) {
                    currentUserRank = rank;
                    currentUserPoints = rep.totalPoints;
                }

                // Rank badge styling
                let rankBadge = '';
                if (rank === 1) {
                    rankBadge = '<span style="font-size: 1.2rem; font-weight: 700; color: #0EA5E9;">#1</span>';
                } else if (rank === 2) {
                    rankBadge = '<span style="font-size: 1.2rem; font-weight: 700; color: #64748B;">#2</span>';
                } else if (rank === 3) {
                    rankBadge = '<span style="font-size: 1.2rem; font-weight: 700; color: #64748B;">#3</span>';
                } else {
                    rankBadge = `<span style="color: #64748B; font-weight: 600;">#${rank}</span>`;
                }

                const rowStyle = isCurrentUser
                    ? 'background: #F8FAFC; border-left: 4px solid #0EA5E9; font-weight: 600;'
                    : '';

                html += `
                    <tr style="${rowStyle}">
                        <td style="text-align: center;">${rankBadge}</td>
                        <td>${rep.name}${isCurrentUser ? ' <span style="color: #0EA5E9; font-size: 0.75rem;">(You)</span>' : ''}</td>
                        <td style="text-align: center;">${rep.scorecard.callsMade || 0}</td>
                        <td style="text-align: center;">${rep.scorecard.emailsSent || 0}</td>
                        <td style="text-align: center;">${rep.scorecard.discoveryCompleted || 0}</td>
                        <td style="text-align: center;">${rep.scorecard.dealsToOnboarding || 0}</td>
                        <td style="text-align: center;">${rep.scorecard.dealsLive || 0}</td>
                        <td style="text-align: center; font-weight: 700;">${Math.round(rep.totalPoints)}</td>
                    </tr>
                `;
            });

            document.getElementById('teamLeaderboardBody').innerHTML = html;

            // Update rank display
            if (currentUserRank === 1) {
                document.getElementById('yourRankDisplay').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: 700; color: #0EA5E9;">#1</div>
                    <div style="font-size: 0.85rem; color: #64748B;">You're #1!</div>
                `;
            } else {
                document.getElementById('yourRankDisplay').innerHTML = `
                    <div style="font-size: 1.5rem; font-weight: 700; color: #0F172A;">#${currentUserRank}</div>
                    <div style="font-size: 0.85rem; color: #64748B;">Your rank</div>
                `;
            }

            // Show gap to first place if not winning
            const gapDiv = document.getElementById('gapToFirst');
            if (currentUserRank > 1) {
                const gap = firstPlacePoints - currentUserPoints;
                document.getElementById('gapText').textContent = `${gap} points behind #1`;
                gapDiv.style.display = 'block';
            } else {
                gapDiv.style.display = 'none';
            }
        }

        // Tab 4: Action Items
        async function loadActionItems() {
            console.log('Loading Action Items tab...');
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            try {
                // Load all deals for this rep
                const snapshot = await db.collection('deals')
                    .where('assignedTo', '==', repId)
                    .get();

                const actionItems = [];
                const stuckDeals = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                snapshot.forEach(doc => {
                    const data = doc.data();

                    // Skip completed or closed deals
                    if (data.stage === 'completed' || data.stage === 'closed-lost') return;

                    // Generate action items based on stage and last activity
                    const lastUpdated = data.lastUpdated?.toDate() || data.createdAt?.toDate() || new Date();
                    const daysSinceUpdate = Math.floor((today - lastUpdated) / (1000 * 60 * 60 * 24));

                    let actionText = '';
                    let dueDate = new Date(lastUpdated);

                    // Stage-specific action items
                    if (data.stage === 'qualified' || data.stage === 'cold-outreach') {
                        actionText = `Reach out to ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 2); // Due 2 days after last update
                    } else if (data.stage === 'follow-up') {
                        actionText = `Follow up with ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 3);
                    } else if (data.stage === 'discovery-scheduled') {
                        actionText = `Discovery call with ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 1);
                    } else if (data.stage === 'discovery-completed') {
                        actionText = `Send proposal to ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 1);
                    } else if (data.stage === 'onboarding-portal') {
                        actionText = `Check onboarding progress for ${data.companyName || 'prospect'}`;
                        dueDate.setDate(dueDate.getDate() + 7);
                    } else if (data.stage === 'campaign-live') {
                        actionText = `Weekly check-in with ${data.companyName || 'client'}`;
                        dueDate.setDate(dueDate.getDate() + 7);
                    } else if (data.stage === 'follow-up-resell') {
                        actionText = `Upsell opportunity with ${data.companyName || 'client'}`;
                        dueDate.setDate(dueDate.getDate() + 14);
                    }

                    // Check if deal is stuck (>7 days in stage)
                    if (daysSinceUpdate > 7) {
                        stuckDeals.push({
                            id: doc.id,
                            companyName: data.companyName,
                            stage: data.stage,
                            daysStuck: daysSinceUpdate
                        });
                    }

                    if (actionText) {
                        actionItems.push({
                            id: doc.id,
                            text: actionText,
                            companyName: data.companyName,
                            stage: data.stage,
                            dueDate: dueDate,
                            dealData: data
                        });
                    }
                });

                // Categorize action items
                const overdue = [];
                const dueToday = [];
                const upcoming = [];

                actionItems.forEach(item => {
                    const itemDate = new Date(item.dueDate);
                    itemDate.setHours(0, 0, 0, 0);

                    if (itemDate < today) {
                        overdue.push(item);
                    } else if (itemDate.getTime() === today.getTime()) {
                        dueToday.push(item);
                    } else {
                        upcoming.push(item);
                    }
                });

                // Sort by due date
                overdue.sort((a, b) => a.dueDate - b.dueDate);
                dueToday.sort((a, b) => a.dueDate - b.dueDate);
                upcoming.sort((a, b) => a.dueDate - b.dueDate);

                // Render action items
                renderActionItems(stuckDeals, overdue, dueToday, upcoming);

            } catch (error) {
                console.error('Error loading action items:', error);
            }
        }

        // Render action items
        function renderActionItems(stuckDeals, overdue, dueToday, upcoming) {
            // Update counts
            document.getElementById('stuckDealsCount').textContent = stuckDeals.length;
            document.getElementById('overdueCount').textContent = overdue.length;
            document.getElementById('dueTodayCount').textContent = dueToday.length;
            document.getElementById('upcomingCount').textContent = upcoming.length;

            // Render stuck deals
            if (stuckDeals.length === 0) {
                document.getElementById('stuckDeals').innerHTML = '<p class="no-data" style="padding: 24px; text-align: center; color: #64748B; margin: 0;">No stuck deals - great job!</p>';
            } else {
                let html = '<div style="padding: 16px;">';
                stuckDeals.forEach(deal => {
                    const stageNames = {
                        'qualified': 'Qualified',
                        'cold-outreach': 'Cold Outreach',
                        'follow-up': 'Follow-Up',
                        'discovery-scheduled': 'Discovery Scheduled',
                        'discovery-completed': 'Discovery Completed',
                        'onboarding-portal': 'Onboarding Portal',
                        'campaign-live': 'Campaign Live',
                        'follow-up-resell': 'Follow-Up & Resell'
                    };

                    html += `
                        <div style="padding: 12px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #0F172A; margin-bottom: 4px;">${deal.companyName || 'Unnamed Deal'}</div>
                                <div style="font-size: 0.85rem; color: #dc2626;">${deal.daysStuck} days in ${stageNames[deal.stage] || deal.stage}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="logActivity('${deal.id}', 'call'); event.stopPropagation();" style="padding: 6px 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 0.85rem; cursor: pointer; color: #0F172A;">Call</button>
                                <button onclick="moveToNext('${deal.id}', '${deal.stage}'); event.stopPropagation();" style="padding: 6px 12px; background: #0EA5E9; border: none; border-radius: 4px; font-size: 0.85rem; cursor: pointer; color: white;">Next</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('stuckDeals').innerHTML = html;
            }

            // Render overdue
            if (overdue.length === 0) {
                document.getElementById('overdueTasks').innerHTML = '<p class="no-data" style="padding: 24px; text-align: center; color: #64748B; margin: 0;">No overdue items</p>';
            } else {
                let html = '<div style="padding: 16px;">';
                overdue.forEach(item => {
                    const daysOverdue = Math.floor((new Date() - item.dueDate) / (1000 * 60 * 60 * 24));
                    html += `
                        <div style="padding: 12px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #0F172A; margin-bottom: 4px;">${item.text}</div>
                                <div style="font-size: 0.85rem; color: #dc2626;">${daysOverdue} day${daysOverdue !== 1 ? 's' : ''} overdue</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem;" onclick="markDone('${item.id}')">Done</button>
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem;" onclick="snoozeTask('${item.id}')">Snooze</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('overdueTasks').innerHTML = html;
            }

            // Render due today
            if (dueToday.length === 0) {
                document.getElementById('dueTodayTasks').innerHTML = '<p class="no-data" style="padding: 24px; text-align: center; color: #64748B; margin: 0;">No tasks due today</p>';
            } else {
                let html = '<div style="padding: 16px;">';
                dueToday.forEach(item => {
                    html += `
                        <div style="padding: 12px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #0F172A; margin-bottom: 4px;">${item.text}</div>
                                <div style="font-size: 0.85rem; color: #f59e0b;">Due today</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem;" onclick="markDone('${item.id}')">Done</button>
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem;" onclick="snoozeTask('${item.id}')">Snooze</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('dueTodayTasks').innerHTML = html;
            }

            // Render upcoming (limit to 10)
            if (upcoming.length === 0) {
                document.getElementById('upcomingTasks').innerHTML = '<p class="no-data" style="padding: 24px; text-align: center; color: #64748B; margin: 0;">No upcoming tasks</p>';
            } else {
                let html = '<div style="padding: 16px;">';
                upcoming.slice(0, 10).forEach(item => {
                    const dueDate = item.dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    html += `
                        <div style="padding: 12px; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #0F172A; margin-bottom: 4px;">${item.text}</div>
                                <div style="font-size: 0.85rem; color: #64748B;">Due ${dueDate}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem;" onclick="markDone('${item.id}')">Done</button>
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem;" onclick="snoozeTask('${item.id}')">Snooze</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('upcomingTasks').innerHTML = html;
            }
        }

        // Mark task as done
        async function markDone(dealId) {
            try {
                await db.collection('deals').doc(dealId).update({
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show feedback
                event.target.textContent = 'Done!';
                event.target.style.background = '#0EA5E9';
                event.target.style.borderColor = '#0EA5E9';
                event.target.style.color = 'white';

                setTimeout(() => {
                    loadActionItems();
                }, 1000);
            } catch (error) {
                console.error('Error marking task done:', error);
                alert('Error updating task. Please try again.');
            }
        }

        // Snooze task
        async function snoozeTask(dealId) {
            const days = prompt('Snooze for how many days?', '3');
            if (!days) return;

            try {
                const newDate = new Date();
                newDate.setDate(newDate.getDate() + parseInt(days));

                await db.collection('deals').doc(dealId).update({
                    lastUpdated: firebase.firestore.Timestamp.fromDate(newDate)
                });

                // Show feedback
                event.target.textContent = `Snoozed ${days}d`;
                event.target.style.background = '#64748B';
                event.target.style.borderColor = '#64748B';
                event.target.style.color = 'white';

                setTimeout(() => {
                    loadActionItems();
                }, 1000);
            } catch (error) {
                console.error('Error snoozing task:', error);
                alert('Error snoozing task. Please try again.');
            }
        }

        // Quick log activity
        async function quickLog(type, event) {
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            // Calculate current week
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;

            const scorecardRef = db.collection('scorecard').doc(`${repId}_${weekId}`);

            try {
                // Map activity type to scorecard field
                const fieldMap = {
                    'call': 'callsMade',
                    'email': 'emailsSent',
                    'discovery-scheduled': 'discoveryScheduled',
                    'discovery-completed': 'discoveryCompleted',
                    'onboarding': 'dealsToOnboarding',
                    'live': 'dealsLive'
                };

                const field = fieldMap[type];
                if (!field) return;

                // Increment the field
                await scorecardRef.update({
                    [field]: firebase.firestore.FieldValue.increment(1),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success feedback
                const buttonText = {
                    'discovery-scheduled': 'Discovery Scheduled',
                    'discovery-completed': 'Discovery Completed',
                    'onboarding': 'To Onboarding',
                    'live': 'Gone Live'
                };

                // Quick visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Logged!';
                btn.style.background = '#0EA5E9';
                btn.style.borderColor = '#0EA5E9';
                btn.style.color = 'white';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }, 1500);

                // Reload the metrics to show updated values
                setTimeout(() => {
                    loadThisWeek();
                }, 500);

            } catch (error) {
                console.error('Error logging activity:', error);
                alert('Error logging activity. Please try again.');
            }
        }

        // Quick action functions for deal cards
        async function logActivity(dealId, activityType) {
            try {
                // Update deal's lastUpdated timestamp
                await db.collection('deals').doc(dealId).update({
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Log activity in scorecard (if tracking calls/emails)
                const repId = sessionStorage.getItem('repId');
                const today = new Date();
                const monday = new Date(today);
                monday.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
                const weekId = `${monday.getFullYear()}-W${getWeekNumber(monday)}`;
                const scorecardRef = db.collection('scorecard').doc(`${repId}_${weekId}`);

                if (activityType === 'call') {
                    await scorecardRef.update({
                        callsMade: firebase.firestore.FieldValue.increment(1),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else if (activityType === 'email') {
                    await scorecardRef.update({
                        emailsSent: firebase.firestore.FieldValue.increment(1),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Show success feedback
                const msg = activityType === 'call' ? 'Call logged!' : 'Email logged!';
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Refresh pipeline to update "last activity"
                loadMyPipeline();
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        async function moveToNext(dealId, currentStage) {
            const stages = [
                'qualified', 'cold-outreach', 'follow-up', 'discovery-scheduled',
                'discovery-completed', 'onboarding-portal', 'campaign-live', 'follow-up-resell'
            ];

            const currentIndex = stages.indexOf(currentStage);
            if (currentIndex === -1 || currentIndex === stages.length - 1) return;

            const nextStage = stages[currentIndex + 1];

            try {
                await db.collection('deals').doc(dealId).update({
                    stage: nextStage,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                toast.textContent = 'Deal moved to next stage!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Refresh pipeline
                loadMyPipeline();
            } catch (error) {
                console.error('Error moving deal:', error);
            }
        }

        // Quick change stage from dropdown
        async function changeStage(dealId, newStage) {
            if (!newStage) return;

            try {
                await db.collection('deals').doc(dealId).update({
                    stage: newStage,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                toast.textContent = 'Stage updated!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Refresh pipeline
                loadMyPipeline();
            } catch (error) {
                console.error('Error changing stage:', error);
                alert('Error updating stage. Please try again.');
            }
        }

        // Open edit deal modal
        async function openEditDeal(dealId) {
            try {
                const doc = await db.collection('deals').doc(dealId).get();
                if (!doc.exists) {
                    alert('Deal not found');
                    return;
                }

                const deal = doc.data();

                // Update modal title and button
                document.getElementById('dealModalTitle').textContent = 'Edit Deal';
                document.getElementById('dealSubmitBtn').textContent = 'Update Deal';

                // Fill form with deal data
                document.getElementById('dealId').value = dealId;
                document.getElementById('dealCompanyName').value = deal.companyName || '';
                document.getElementById('dealContactName').value = deal.contactName || '';
                document.getElementById('dealEmail').value = deal.email || '';
                document.getElementById('dealPhone').value = deal.phone || '';
                document.getElementById('dealStage').value = deal.stage || 'qualified';

                // Show modal
                document.getElementById('dealModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading deal:', error);
                alert('Error loading deal. Please try again.');
            }
        }

        // Archive/delete deal
        async function archiveDeal(dealId) {
            if (!confirm('Are you sure you want to archive this deal?')) return;

            try {
                await db.collection('deals').doc(dealId).update({
                    stage: 'closed-lost',
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show success
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                toast.textContent = 'Deal archived!';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                // Refresh pipeline
                loadMyPipeline();
            } catch (error) {
                console.error('Error archiving deal:', error);
                alert('Error archiving deal. Please try again.');
            }
        }

        // Deal Modal Functions
        function openNewDealModal() {
            // Reset for new deal
            document.getElementById('dealModalTitle').textContent = 'Add New Deal';
            document.getElementById('dealSubmitBtn').textContent = 'Create Deal';
            document.getElementById('dealId').value = '';
            document.getElementById('dealForm').reset();
            document.getElementById('dealModal').style.display = 'flex';
        }

        function closeDealModal() {
            document.getElementById('dealModal').style.display = 'none';
        }

        // Handle deal form submission (create or update)
        document.getElementById('dealForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const repId = sessionStorage.getItem('repId');
            const dealId = document.getElementById('dealId').value;

            const dealData = {
                companyName: document.getElementById('dealCompanyName').value,
                contactName: document.getElementById('dealContactName').value || null,
                email: document.getElementById('dealEmail').value || null,
                phone: document.getElementById('dealPhone').value || null,
                stage: document.getElementById('dealStage').value,
                assignedTo: repId,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (dealId) {
                    // Update existing deal
                    await db.collection('deals').doc(dealId).update(dealData);

                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 16px 24px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                    successDiv.textContent = 'Deal updated successfully!';
                    document.body.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 3000);
                } else {
                    // Create new deal
                    dealData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('deals').add(dealData);

                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #0EA5E9; color: white; padding: 16px 24px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                    successDiv.textContent = 'Deal created successfully!';
                    document.body.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 3000);
                }

                closeDealModal();
                loadMyPipeline(); // Refresh pipeline
            } catch (error) {
                console.error('Error saving deal:', error);
                alert('Error saving deal. Please try again.');
            }
        });

        // Edit Targets Functions
        async function openEditTargetsModal() {
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            try {
                // Load current targets
                const repDoc = await db.collection('salesReps').doc(repId).get();
                if (repDoc.exists) {
                    const targets = repDoc.data().weeklyTargets || {};

                    // Pre-fill form with current targets
                    document.getElementById('targetCallsMade').value = targets.callsMade || 50;
                    document.getElementById('targetEmailsSent').value = targets.emailsSent || 30;
                    document.getElementById('targetDiscoveryScheduled').value = targets.discoveryScheduled || 5;
                    document.getElementById('targetDiscoveryCompleted').value = targets.discoveryCompleted || 3;
                    document.getElementById('targetDealsToOnboarding').value = targets.dealsToOnboarding || 2;
                    document.getElementById('targetDealsLive').value = targets.dealsLive || 1;
                }

                // Show modal
                document.getElementById('targetsModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading targets:', error);
                alert('Error loading targets. Please try again.');
            }
        }

        function closeTargetsModal() {
            document.getElementById('targetsModal').style.display = 'none';
        }

        // Handle targets form submission
        document.getElementById('targetsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const repId = sessionStorage.getItem('repId');
            if (!repId) return;

            const newTargets = {
                callsMade: parseInt(document.getElementById('targetCallsMade').value),
                emailsSent: parseInt(document.getElementById('targetEmailsSent').value),
                discoveryScheduled: parseInt(document.getElementById('targetDiscoveryScheduled').value),
                discoveryCompleted: parseInt(document.getElementById('targetDiscoveryCompleted').value),
                dealsToOnboarding: parseInt(document.getElementById('targetDealsToOnboarding').value),
                dealsLive: parseInt(document.getElementById('targetDealsLive').value)
            };

            try {
                // Update targets in salesReps collection
                await db.collection('salesReps').doc(repId).update({
                    weeklyTargets: newTargets
                });

                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10B981; color: white; padding: 16px 24px; border-radius: 6px; z-index: 9999; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);';
                successDiv.textContent = 'Targets updated successfully!';
                document.body.appendChild(successDiv);
                setTimeout(() => successDiv.remove(), 3000);

                closeTargetsModal();

                // Reload the weekly metrics to show new targets
                loadThisWeek();
            } catch (error) {
                console.error('Error updating targets:', error);
                alert('Error updating targets. Please try again.');
            }
        });
    </script>

    <!-- Footer -->
    <footer style="background: #FFFFFF; border-top: 1px solid #E2E8F0; padding: 32px 0; margin-top: 60px;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 32px; margin-bottom: 24px;">
                <!-- Quick Links -->
                <div>
                    <h4 style="color: #0F172A; font-size: 0.75rem; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Quick Links</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 8px;">
                            <a href="faq.html" style="color: #64748B; text-decoration: none; font-size: 0.875rem; transition: color 0.15s;">FAQ</a>
                        </li>
                        <li style="margin-bottom: 8px;">
                            <a href="resources.html" style="color: #64748B; text-decoration: none; font-size: 0.875rem; transition: color 0.15s;">Resources</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div>
                    <h4 style="color: #0F172A; font-size: 0.75rem; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Support</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 8px;">
                            <a href="mailto:support@driveleadmedia.com" style="color: #64748B; text-decoration: none; font-size: 0.875rem; transition: color 0.15s;">Contact Support</a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Copyright -->
            <div style="text-align: center; padding-top: 24px; border-top: 1px solid #E2E8F0;">
                <p style="color: #94A3B8; font-size: 0.75rem; margin: 0;">© 2025 Drive Lead Media. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
